{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata":{
        "title": "EnrichIP-RiskIQ-Whois-Ip-Nested",
        "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. WHOIS is akin to a phone book for the Internet; it reveals the owners behind domain registrations and IP address hosting. Analysts can leverage WHOIS, both active and historic, in order to identify analytical leads. This data can sometimes reveal the threat actor behind a given set of infrastructure or provide deeper context as to what else may be related. This playbook will query for WHOIS data from indicators contained within the incident and post the results in the form of a comment.",
        "prerequisites": [
            "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed RiskIQ-Base prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your account settings page. For enterprise customers, it's preferred to use the \"organization\" credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
        ],
        "lastUpdateTime": "2022-08-29T10:43:00Z",
        "entities": ["ip"],
        "tags": ["Enrichment"],
        "support": {
            "tier": "microsoft"
        },
        "author": {
            "name": "Microsoft"
        }
    },
    "parameters": {
        "PlaybookName": {
            "defaultValue": "EnrichIP-RiskIQ-Whois-Ip-Nested",
            "type": "string"
        }
    },
    "variables": {
        "AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('PlaybookName'))]",
        "RiskIQConnectionName": "riskiq-shared"
    },
    "resources": [{
        "type": "Microsoft.Web/connections",
        "apiVersion": "2016-06-01",
        "name": "[variables('RiskIQConnectionName')]",
        "location": "[resourceGroup().location]",
        "properties": {
            "api": {
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/riskiqpassivetotal')]"
            }
        }
    }, {
        "type": "Microsoft.Web/connections",
        "apiVersion": "2016-06-01",
        "name": "[variables('AzureSentinelConnectionName')]",
        "location": "[resourceGroup().location]",
        "properties": {
            "api": {
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuresentinel')]"
            }
        }
    }, {
        "type": "Microsoft.Logic/workflows",
        "apiVersion": "2017-07-01",
        "name": "[parameters('PlaybookName')]",
        "location": "[resourceGroup().location]",
        "tags": {
            "LogicAppsCategory": "security"
        },
        "dependsOn": [
            "[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
            "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
        ],
        "properties": {
            "state": "Enabled",
            "definition": {
            "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
            "contentVersion": "1.0.0.0",
            "parameters": {
                "$connections": {
                    "defaultValue": {},
                    "type": "Object"
                }
            },
            "triggers": {
                "manual": {
                    "type": "Request",
                    "kind": "Http",
                    "inputs": {
                        "method": "POST",
                        "schema": {
                            "properties": {
                                "IPs": {
                                    "items": {
                                        "properties": {
                                            "Address": {
                                                "type": "string"
                                            }
                                        },
                                        "required": [
                                            "Address"
                                        ],
                                        "type": "object"
                                    },
                                    "type": "array"
                                }
                            },
                            "type": "object"
                        }
                    }
                }
            },
            "actions": {
                "For_each_ip": {
                    "foreach": "@triggerBody()?['IPs']",
                    "actions": {
                        "Append_to_string_variable": {
                            "runAfter": {
                                "Get_WHOIS_IP": [
                                    "Succeeded"
                                ]
                            },
                            "type": "AppendToStringVariable",
                            "inputs": {
                                "name": "Consolidated comment",
                                "value": "Associated WHOIS record for @{items('For_each_ip')?['Address']}:\n\nRegistrar: @{body('Get_WHOIS_IP')?['registrar']}\nRegistered:@{body('Get_WHOIS_IP')?['registered']}\nExpires: @{body('Get_WHOIS_IP')?['expiresAt']}\nContact: @{body('Get_WHOIS_IP')?['contactEmail']}\nNameservers: @{body('Get_WHOIS_IP')?['nameServers']}\n\nTo search on WHOIS data or view historic records, see https://community.riskiq.com/search/@{items('For_each_ip')?['Address']}/whois"
                            }
                        },
                        "Get_WHOIS_IP": {
                            "runAfter": {},
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/whois",
                                "queries": {
                                    "query": "@items('For_each_ip')?['Address']"
                                }
                            }
                        }
                    },
                    "runAfter": {
                        "Initialize_variable_Consolidated_comment": [
                            "Succeeded"
                        ]
                    },
                    "type": "Foreach"
                },
                "Initialize_variable_Consolidated_comment": {
                    "runAfter": {
                        "Initialize_variable_IPs": [
                            "Succeeded"
                        ]
                    },
                    "type": "InitializeVariable",
                    "inputs": {
                        "variables": [
                            {
                                "name": "Consolidated comment",
                                "type": "string"
                            }
                        ]
                    }
                },
                "Initialize_variable_IPs": {
                    "runAfter": {},
                    "type": "InitializeVariable",
                    "inputs": {
                        "variables": [
                            {
                                "name": "IPs",
                                "type": "array",
                                "value": "@triggerBody()?['IPs']"
                            }
                        ]
                    }
                }
            },
            "outputs": {}
        },
            "parameters": {
                "$connections": {
                    "value": {
                        "azuresentinel": {
                            "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                            "connectionName": "[variables('AzureSentinelConnectionName')]",
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuresentinel')]"
                        },
                        "riskiqpassivetotal": {
                            "connectionId": "[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                            "connectionName": "[variables('RiskIQConnectionName')]",
                            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/riskiqpassivetotal')]"
                        }
                    }
                }
            }
        }
    }]
}