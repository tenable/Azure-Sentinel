{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for Proofpoint On demand(POD) Email Security"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Proofpoint On-Demand Email Security",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "solutionId": "azuresentinel.azure-sentinel-proofpointpod",
    "_solutionId": "[variables('solutionId')]",
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "workbookVersion1": "1.0.0",
    "workbookContentId1": "ProofpointPODWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1')))]",
    "_workbookContentId1": "[variables('workbookContentId1')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "parserVersion1": "1.0.0",
    "parserContentId1": "ProofpointPOD-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "parserName1": "ProofpointPOD Data Parser",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId1')))]",
    "huntingQueryVersion1": "1.0.0",
    "huntingQuerycontentId1": "0794a162-8635-43fd-81ed-2cf2604575b1",
    "_huntingQuerycontentId1": "[variables('huntingQuerycontentId1')]",
    "huntingQueryId1": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId1'))]",
    "huntingQueryTemplateSpecName1": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId1')))]",
    "huntingQueryVersion2": "1.0.0",
    "huntingQuerycontentId2": "eb74aaab-ebf4-4763-9b03-b1a33fe48600",
    "_huntingQuerycontentId2": "[variables('huntingQuerycontentId2')]",
    "huntingQueryId2": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId2'))]",
    "huntingQueryTemplateSpecName2": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId2')))]",
    "huntingQueryVersion3": "1.0.0",
    "huntingQuerycontentId3": "a0d56fcd-edb3-46f1-aaa3-12d606a48ff1",
    "_huntingQuerycontentId3": "[variables('huntingQuerycontentId3')]",
    "huntingQueryId3": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId3'))]",
    "huntingQueryTemplateSpecName3": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId3')))]",
    "huntingQueryVersion4": "1.0.0",
    "huntingQuerycontentId4": "c9ff3690-b754-4c91-b866-4d07098da074",
    "_huntingQuerycontentId4": "[variables('huntingQuerycontentId4')]",
    "huntingQueryId4": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId4'))]",
    "huntingQueryTemplateSpecName4": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId4')))]",
    "huntingQueryVersion5": "1.0.0",
    "huntingQuerycontentId5": "bc619ce8-0807-4b13-93ea-0d7b79c7ee68",
    "_huntingQuerycontentId5": "[variables('huntingQuerycontentId5')]",
    "huntingQueryId5": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId5'))]",
    "huntingQueryTemplateSpecName5": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId5')))]",
    "huntingQueryVersion6": "1.0.0",
    "huntingQuerycontentId6": "dd9674cf-898b-4c80-96f1-f70bec66e6fc",
    "_huntingQuerycontentId6": "[variables('huntingQuerycontentId6')]",
    "huntingQueryId6": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId6'))]",
    "huntingQueryTemplateSpecName6": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId6')))]",
    "huntingQueryVersion7": "1.0.0",
    "huntingQuerycontentId7": "d324e435-31d3-4aa3-907c-76f4917820a9",
    "_huntingQuerycontentId7": "[variables('huntingQuerycontentId7')]",
    "huntingQueryId7": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId7'))]",
    "huntingQueryTemplateSpecName7": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId7')))]",
    "huntingQueryVersion8": "1.0.0",
    "huntingQuerycontentId8": "c334e1e8-a7da-4c23-a9c0-fdda26b07606",
    "_huntingQuerycontentId8": "[variables('huntingQuerycontentId8')]",
    "huntingQueryId8": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId8'))]",
    "huntingQueryTemplateSpecName8": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId8')))]",
    "huntingQueryVersion9": "1.0.0",
    "huntingQuerycontentId9": "af7f133a-5fed-4ebf-8272-4330c884c7ca",
    "_huntingQuerycontentId9": "[variables('huntingQuerycontentId9')]",
    "huntingQueryId9": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId9'))]",
    "huntingQueryTemplateSpecName9": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId9')))]",
    "huntingQueryVersion10": "1.0.0",
    "huntingQuerycontentId10": "7b281f4a-6a9a-439f-8b4f-f08eb24f2fb7",
    "_huntingQuerycontentId10": "[variables('huntingQuerycontentId10')]",
    "huntingQueryId10": "[resourceId('Microsoft.OperationalInsights/savedSearches', variables('_huntingQuerycontentId10'))]",
    "huntingQueryTemplateSpecName10": "[concat(parameters('workspace'),'-hq-',uniquestring(variables('_huntingQuerycontentId10')))]",
    "analyticRuleVersion1": "1.0.2",
    "analyticRulecontentId1": "eb68b129-5f17-4f56-bf6d-dde48d5e615a",
    "_analyticRulecontentId1": "[variables('analyticRulecontentId1')]",
    "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId1'))]",
    "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId1')))]",
    "analyticRuleVersion2": "1.0.1",
    "analyticRulecontentId2": "aedc5b33-2d7c-42cb-a692-f25ef637cbb1",
    "_analyticRulecontentId2": "[variables('analyticRulecontentId2')]",
    "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId2'))]",
    "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId2')))]",
    "analyticRuleVersion3": "1.0.1",
    "analyticRulecontentId3": "c7cd6073-6d2c-4284-a5c8-da27605bdfde",
    "_analyticRulecontentId3": "[variables('analyticRulecontentId3')]",
    "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId3'))]",
    "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId3')))]",
    "analyticRuleVersion4": "1.0.2",
    "analyticRulecontentId4": "bda5a2bd-979b-4828-a91f-27c2a5048f7f",
    "_analyticRulecontentId4": "[variables('analyticRulecontentId4')]",
    "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId4'))]",
    "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId4')))]",
    "analyticRuleVersion5": "1.0.1",
    "analyticRulecontentId5": "d1aba9a3-5ab1-45ef-8ed4-da57dc3c0d32",
    "_analyticRulecontentId5": "[variables('analyticRulecontentId5')]",
    "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId5'))]",
    "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId5')))]",
    "analyticRuleVersion6": "1.1.1",
    "analyticRulecontentId6": "f8127962-7739-4211-a4a9-390a7a00e91f",
    "_analyticRulecontentId6": "[variables('analyticRulecontentId6')]",
    "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId6'))]",
    "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId6')))]",
    "analyticRuleVersion7": "1.0.2",
    "analyticRulecontentId7": "f6a51e2c-2d6a-4f92-a090-cfb002ca611f",
    "_analyticRulecontentId7": "[variables('analyticRulecontentId7')]",
    "analyticRuleId7": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId7'))]",
    "analyticRuleTemplateSpecName7": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId7')))]",
    "analyticRuleVersion8": "1.0.2",
    "analyticRulecontentId8": "56b0a0cd-894e-4b38-a0a1-c41d9f96649a",
    "_analyticRulecontentId8": "[variables('analyticRulecontentId8')]",
    "analyticRuleId8": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', variables('analyticRulecontentId8'))]",
    "analyticRuleTemplateSpecName8": "[concat(parameters('workspace'),'-ar-',uniquestring(variables('_analyticRulecontentId8')))]",
    "uiConfigId1": "ProofpointPOD",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "ProofpointPOD",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1')))]",
    "dataConnectorVersion1": "1.0.0"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Workbook with template",
        "displayName": "Proofpoint On demand(POD) Email Security workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('workbookTemplateSpecName1'),'/',variables('workbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ProofpointPODWorkbook Workbook with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Gain insights into your Proofpoint on Demand Email Security activities, including maillog and messages data. The Workbook provides users with an executive dashboard showing the reporting capabilities, message traceability and monitoring."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"\\n>**NOTE:** This workbook uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Parsers/ProofpointPOD/ProofpointPOD) to create the Kusto function alias **ProofpointPOD**.\"},\"name\":\"text - 16\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"3fb8c41a-e970-467a-8975-0b87bfda8cc0\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Proofpoint Email Security Main Dashboard\",\"subTarget\":\"proofpoint_email_security_main_dashboard\",\"preText\":\"Proofpoint Email Security Main Dashboard\",\"style\":\"link\"},{\"id\":\"40d6c856-9ecd-428b-ada5-ad76ba351f5e\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"TLS Dashboard\",\"subTarget\":\"tls_dashboard\",\"style\":\"link\"},{\"id\":\"68036e0c-acaa-48d3-aae0-911917ec637d\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Message Summary\",\"subTarget\":\"messages_summary\",\"style\":\"link\"}]},\"name\":\"Tab\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"f1aebfc5-f1bd-4462-bb99-f87af7f027ba\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":5184000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isNotEqualTo\",\"value\":\"messages_summary\"},\"name\":\"Parameters\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EventType;\",\"size\":1,\"title\":\"Events over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"name\":\"EventsOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let email_security_total_messages_timechart=ProofpointPOD\\n| where EventType == \\\"message\\\" \\n| where TimeGenerated {TimeRange}\\n| extend event_type = \\\"Message Rate\\\";\\n\\nlet email_security_total_blocked_timechart =\\nProofpointPOD\\n| where EventType == \\\"message\\\" \\n| where FilterDisposition == \\\"discard\\\" or FilterDisposition == \\\"reject\\\"\\n| extend event_type = \\\"Blocked Message Rate\\\";\\n\\nlet quarantine_trends = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange}\\n| where isnotempty(FilterQuarantineFolder)\\n| extend event_type = \\\"Quarantined Message Rate\\\";\\n\\nlet result = union email_security_total_messages_timechart, email_security_total_blocked_timechart, quarantine_trends\\n| make-series Trend = dcount(MsgHeaderMessageId) on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by event_type;\\nresult\",\"size\":0,\"title\":\"Email Messages over time\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"60\",\"name\":\"EmailMessagesOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let email_security_total_messages_processed =\\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title=\\\"Total Messages Processed\\\";\\n\\nlet email_security_inbound_messages_processed =\\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where NetworkDirection == \\\"inbound\\\"\\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title=\\\"Inbound Messages Processed\\\";\\n\\nlet email_security_outbound_messages_processed =\\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where NetworkDirection == \\\"outbound\\\"\\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title=\\\"Outbound Messages Processed\\\";\\n\\nlet email_security_total_blocked_messages =\\nProofpointPOD\\n| where EventType == \\\"message\\\" \\n| where TimeGenerated {TimeRange} \\n| where FilterDisposition == \\\"discard\\\" or FilterDisposition == \\\"reject\\\"\\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title=\\\"Total Blocked Messages\\\";\\n\\nlet email_security_total_quarantined_messages = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange}\\n| where isnotempty(FilterQuarantineFolder)\\n| summarize Count=dcount(MsgHeaderMessageId) \\n| extend title = \\\"Quarantined Messages\\\";\\n\\nlet email_security_result_table = union email_security_total_messages_processed, email_security_inbound_messages_processed,email_security_outbound_messages_processed,email_security_total_blocked_messages,email_security_total_quarantined_messages; \\nemail_security_result_table \\n| sort by Count\",\"size\":3,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false,\"size\":\"auto\"}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"40\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where isnotempty(FilterQuarantineRule)\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by FilterQuarantineRule\",\"size\":3,\"title\":\"Quarantine Rules Hits\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"35\",\"name\":\"QuarantineRulesHits\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where isnotempty(FilterModulesDmarcFilterdResult)\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by FilterModulesDmarcFilterdResult\",\"size\":3,\"title\":\"DMARC Summary Results\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"35\",\"name\":\"DMARCSummaryResults\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where isnotempty(FilterModulesSpamTriggeredClassifier)\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by FilterModulesSpamTriggeredClassifier\",\"size\":3,\"title\":\"Top AntiSpam Results\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"TopAntiSpamResults\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where FilterDisposition == \\\"discard\\\" or FilterDisposition == \\\"reject\\\" or isnotempty(FilterQuarantineFolder)\\n| where TimeGenerated {TimeRange} \\n| extend dstUserUpn = todynamic(DstUserUpn) \\n| mv-expand dstUserUpn\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by tostring(dstUserUpn) | top 10 by Count\",\"size\":0,\"title\":\"Top Recipients with high block rate\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"TopRecipients\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| extend srcUserUpn = todynamic(SrcUserUpn) \\n| mv-expand srcUserUpn\\n| where isnotempty(srcUserUpn)\\n| summarize Count = dcount(MsgNormalizedHeaderMessageId) by tostring(srcUserUpn) | top 10 by Count\",\"size\":0,\"title\":\"Top Senders\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"proofpoint_email_security_main_dashboard\"},\"customWidth\":\"30\",\"name\":\"TopSenders\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"afe179f1-6dc8-4a97-bc20-5b8aadf5a9aa\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange1\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":172800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000},\"label\":\"TimeRange\"},{\"id\":\"cc0743b6-1893-4f3d-8c7c-96f075f3006c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Direction\",\"type\":2,\"isRequired\":true,\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange1} \\n| project NetworkDirection | distinct NetworkDirection | where isnotempty(NetworkDirection)\\n| order by NetworkDirection asc\",\"typeSettings\":{\"showDefault\":false},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"34bcd907-7f33-4d49-b158-eb7877a763f9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Sender\",\"type\":1,\"value\":\"\"},{\"id\":\"65c7de4d-b953-407a-ac81-9c2fe2fddd99\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Recipient\",\"type\":1,\"value\":\"\"},{\"id\":\"e819f521-396a-4292-ae6d-99a173eb09b6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subject\",\"type\":1,\"value\":\"\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"messages_summary\"},\"name\":\"Parameters2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange1}\\n| project-rename Direction = NetworkDirection, Sender = MsgHeaderFrom,  Recipient = MsgHeaderTo, Subject = MsgHeaderSubject, Filter_Action = FilterDisposition\\n| project TimeGenerated, Direction, Sender, Recipient, Subject, Filter_Action, MsgNormalizedHeaderMessageId\\n| search Sender contains \\\"{Sender:value}\\\" and Recipient contains \\\"{Recipient:value}\\\" and Subject contains \\\"{Subject:value}\\\"\\n| search Direction == \\\"{Direction:value}\\\" | project TimeGenerated, Direction, Sender, Recipient, Subject, Filter_Action, MsgNormalizedHeaderMessageId | take 50\",\"size\":0,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"MsgNormalizedHeaderMessageId\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"MsgNormalizedHeaderMessageId\",\"sortOrder\":1}]},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"messages_summary\"},\"name\":\"Table\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let inbound_tls_encrypted = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange}\\n| where FilterIsMsgEncrypted == \\\"true\\\" and NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound TLS Encrypted\\\";\\n\\nlet inbound_tls_unencrypted = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where FilterIsMsgEncrypted == \\\"false\\\" and NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound TLS Unencrypted\\\";\\n\\nlet inbound_total = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound Total\\\";\\n\\nlet trend_result = union inbound_tls_encrypted, inbound_tls_unencrypted, inbound_total;\\ntrend_result | summarize Count=dcount(MsgNormalizedHeaderMessageId) by event_type \\n| join kind=inner (trend_result | make-series Trend = dcount(MsgNormalizedHeaderMessageId) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}  by event_type) on event_type \\n;\\n\",\"size\":1,\"title\":\"TLS Usage over time\",\"timeContext\":{\"durationMs\":5184000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"tls_dashboard\"},\"customWidth\":\"70\",\"name\":\"TLSUsage\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let inbound_tls_encrypted = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange}\\n| where FilterIsMsgEncrypted == \\\"true\\\" and NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound TLS Encrypted\\\";\\n\\nlet inbound_tls_unencrypted = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where FilterIsMsgEncrypted == \\\"false\\\" and NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound TLS Unencrypted\\\";\\n\\nlet inbound_total = \\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where NetworkDirection == \\\"inbound\\\"\\n| extend event_type = \\\"Inbound Total\\\";\\n\\nlet trend_result = union inbound_tls_encrypted, inbound_tls_unencrypted, inbound_total;\\ntrend_result | summarize Count=dcount(MsgNormalizedHeaderMessageId) by event_type \\n| join kind=inner (trend_result | make-series Trend = dcount(MsgNormalizedHeaderMessageId) default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}  by event_type) on event_type \\n| order by Count desc\\n| project event_type, Trend, Count\\n;\",\"size\":3,\"title\":\"TLS Statistics\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}}],\"sortBy\":[{\"itemKey\":\"Count\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"Count\",\"sortOrder\":2}],\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"event_type\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"tls_dashboard\"},\"customWidth\":\"30\",\"name\":\"TLSStatistics\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where TimeGenerated {TimeRange} \\n| where FilterIsMsgEncrypted == \\\"false\\\"\\n| summarize Count=dcount(MsgNormalizedHeaderMessageId) by MsgHeaderFrom | top 10 by Count | extend Domain = extract(\\\"(.*@)([a-zA-z0-9.-]*)\\\", 2, MsgHeaderFrom)\\n| project Domain, Count\\n\",\"size\":0,\"title\":\"Top 10 Sender domains not using TLS\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"tls_dashboard\"},\"customWidth\":\"50\",\"name\":\"Top10SenderNotUsingTLS\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nProofpointPOD\\n| where EventType == \\\"message\\\"\\n| where FilterIsMsgEncrypted == \\\"false\\\"\\n| where TimeGenerated {TimeRange} \\n| extend splited=split(MsgHeaderTo,\\\",\\\") | mv-expand splited | extend Domain = extract(\\\"(.*@)([a-zA-z0-9.-]*)\\\", 2, tostring(splited))\\n| where isnotempty(Domain)\\n| summarize Count=dcount(MsgNormalizedHeaderMessageId) by Domain | top 10 by Count\\n\",\"size\":0,\"title\":\"Top 10 Recipient domains not using TLS\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"tls_dashboard\"},\"customWidth\":\"50\",\"name\":\"Top10RecipientNotUsingTLS\"}],\"fromTemplateId\":\"sentinel-ProofpointPOD\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=ProofpointPODWorkbook; logoFileName=proofpointlogo.svg; description=Gain insights into your Proofpoint on Demand Email Security activities, including maillog and messages data. The Workbook provides users with an executive dashboard showing the reporting capabilities, message traceability and monitoring.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.0.0; title=Proofpoint On-Demand Email Security; templateRelativePath=ProofpointPOD.json; subtitle=; provider=Proofpoint}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "ProofpointPOD_maillog_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ProofpointPOD_message_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "ProofpointPOD",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "ProofpointPOD Data Parser with template",
        "displayName": "ProofpointPOD Data Parser template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('parserTemplateSpecName1'),'/',variables('parserVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('parserTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ProofpointPOD Data Parser with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2020-08-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD Data Parser",
                "category": "Samples",
                "functionAlias": "ProofpointPOD",
                "query": "\nlet ProofpointPOD_maillog_view = view () { \r\n    union isfuzzy=true ProofpointPOD_maillog_CL, maillog_CL | where isnotempty( pps_cid_s) and event_type_s == \"maillog\"\r\n    | extend \r\n                SmMsgid=column_ifexists('sm_msgid_g', ''),\r\n                PpsCid=column_ifexists('pps_cid_s', ''),\r\n                PpsAgent=column_ifexists('pps_agent_s', ''),\r\n                Id=column_ifexists('id_s', ''),\r\n                SmNrcpts=column_ifexists('sm_nrcpts_s', ''),\r\n                SmAuth=column_ifexists('sm_auth_s', ''),\r\n                SmClass=column_ifexists('sm_class_s', ''),\r\n                SmQid=column_ifexists('sm_qid_s', ''),\r\n                MetadataOriginDataAgent=column_ifexists('metadata_origin_data_agent_s', ''),\r\n                MetadataOriginDataCid=column_ifexists('metadata_origin_data_cid_s', ''),\r\n                SmMailer=column_ifexists('sm_mailer_s', ''),\r\n                SmDsn=column_ifexists('sm_dsn_s', ''),\r\n                SmPri=column_ifexists('sm_pri_s', ''),\r\n                SmXdelay=column_ifexists('sm_xdelay_s', ''),\r\n                SmCtladdr=column_ifexists('sm_ctladdr_s', ''),\r\n                EventUid=column_ifexists('sm_msgid_s', ''),\r\n                NetworkBytes=toreal( column_ifexists('sm_sizeBytes_s', '')),\r\n                TlsEstablished=column_ifexists('sm_tls_verify_s', ''),\r\n                SrcNatIpAddr=column_ifexists('sm_relay_s', ''),\r\n                ProcessName=column_ifexists('sm_daemon_s', ''),\r\n                NetworkProtocol=column_ifexists('sm_proto_s', ''),\r\n                SrcUserUpn=column_ifexists('sm_from_s', ''),\r\n                EventOriginalTime=column_ifexists('ts_t', ''),\r\n                EventOriginalMessage=column_ifexists('data_s', ''),\r\n                EventType=column_ifexists('event_type_s', ''),\r\n                NetworkConnectionStateDetailed=column_ifexists('sm_stat_s', ''),\r\n                DstUserUpn=column_ifexists('sm_to_s', ''),\r\n                NetworkDuration=column_ifexists('sm_delay_s', ''),\r\n                EventVendor=\"Proofpoint\",\r\n                EventProduct=\"Proofpoint On Demand Email Security\"\r\n    | project\r\n                TimeGenerated, \r\n                EventVendor,\r\n                EventProduct,\r\n                SmMsgid,\r\n                PpsCid,\r\n                PpsAgent,\r\n                Id,\r\n                SmNrcpts,\r\n                SmAuth,\r\n                SmClass,\r\n                SmQid,\r\n                MetadataOriginDataAgent,\r\n                MetadataOriginDataCid,\r\n                SmMailer,\r\n                SmDsn,\r\n                SmPri,\r\n                SmXdelay,\r\n                SmCtladdr,\r\n                EventUid,\r\n                NetworkBytes,\r\n                TlsEstablished,\r\n                SrcNatIpAddr,\r\n                ProcessName,\r\n                NetworkProtocol,\r\n                SrcUserUpn,\r\n                EventOriginalTime,\r\n                EventOriginalMessage,\r\n                EventType,\r\n                NetworkConnectionStateDetailed,\r\n                DstUserUpn,\r\n                NetworkDuration\r\n};\r\nlet ProofpointPOD_message_view = view () { \r\n    union isfuzzy=true ProofpointPOD_message_CL, message_CL | where event_type_s == \"message\"\r\n    | extend \r\n                FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize=column_ifexists('filter_modules_urldefense_counts_noRewriteIsLargeMsgPartSize_d', ''),\r\n\t\t        PpsVersion=column_ifexists('pps_version_s', ''),\r\n\t\t        PpsCid=column_ifexists('pps_cid_s', ''),\r\n\t\t        MsgParts=column_ifexists('msgParts_s', ''),\r\n\t\t        MetadataOriginDataAgent=column_ifexists('metadata_origin_data_agent_s', ''),\r\n\t\t        MetadataOriginDataVersion=column_ifexists('metadata_origin_data_version_s', ''),\r\n\t\t        MetadataOriginDataCid=column_ifexists('metadata_origin_data_cid_s', ''),\r\n\t\t        ConnectionHelo=column_ifexists('connection_helo_s', ''),\r\n\t\t        MsgLang=column_ifexists('msg_lang_s', ''),\r\n\t\t        MsgNormalizedHeaderSubject=column_ifexists('msg_normalizedHeader_subject_s', ''),\r\n\t\t        MsgNormalizedHeaderMessageId=column_ifexists('msg_normalizedHeader_message_id_s', ''),\r\n\t\t        MsgNormalizedHeaderTo=column_ifexists('msg_normalizedHeader_to_s', ''),\r\n\t\t        MsgNormalizedHeadertoHashed=column_ifexists('msg_normalizedHeader_toHashed_s', ''),\r\n\t\t        MsgNormalizedHeaderFrom=column_ifexists('msg_normalizedHeader_from_s', ''),\r\n\t\t        MsgNormalizedHeaderFromHashed=column_ifexists('msg_normalizedHeader_fromHashed_s', ''),\r\n\t\t        MsgHeaderFrom=column_ifexists('msg_header_from_s', ''),\r\n\t\t        MsgHeaderFromHashed=column_ifexists('msg_header_fromHashed_s', ''),\r\n\t\t        MsgHeaderMessageId=column_ifexists('msg_header_message_id_s', ''),\r\n\t\t        MsgHeaderSubject=column_ifexists('msg_header_subject_s', ''),\r\n\t\t        MsgHeaderTo=column_ifexists('msg_header_to_s', ''),\r\n\t\t        MsgHeaderToHashed=column_ifexists('msg_header_toHashed_s', ''),\r\n\t\t        MsgParsedAddressesFromHashed=column_ifexists('msg_parsedAddresses_fromHashed_s', ''),\r\n\t\t        MsgParsedAddressesFrom=column_ifexists('msg_parsedAddresses_from_s', ''),\r\n\t\t        MsgParsedAddressesToHashed=column_ifexists('msg_parsedAddresses_toHashed_s', ''),\r\n\t\t        MsgParsedAddressesTo=column_ifexists('msg_parsedAddresses_to_s', ''),\r\n\t\t        FilterActions=column_ifexists('filter_actions_s', ''),\r\n\t\t        FilterRoutes=column_ifexists('filter_routes_s', ''),\r\n\t\t        FilterQid=column_ifexists('filter_qid_s', ''),\r\n\t\t        FilterIsMsgEncrypted=column_ifexists('filter_isMsgEncrypted_b', ''),\r\n\t\t        FilterIsMsgReinjected=column_ifexists('filter_isMsgReinjected_b', ''),\r\n\t\t        FilterQuarantineRule=column_ifexists('filter_quarantine_rule_s', ''),\r\n\t\t        FilterQuarantineFolder=column_ifexists('filter_quarantine_folder_s', ''),\r\n\t\t        FilterModulesDmarcSrvid=column_ifexists('filter_modules_dmarc_srvid_s', ''),\r\n\t\t        FilterModulesDmarcRecords=column_ifexists('filter_modules_dmarc_records_s', ''),\r\n\t\t        FilterModulesDmarcFilterdResult=column_ifexists('filter_modules_dmarc_filterdResult_s', ''),\r\n\t\t        FilterModulesDmarcAuthResults=column_ifexists('filter_modules_dmarc_authResults_s', ''),\r\n\t\t        FilterModulesSpfDomain=column_ifexists('filter_modules_spf_domain_s', ''),\r\n\t\t        FilterModulesSpfResult=column_ifexists('filter_modules_spf_result_s', ''),\r\n\t\t        FilterModulesSpamTriggeredClassifier=column_ifexists('filter_modules_spam_triggeredClassifier_s', ''),\r\n\t\t        FilterModulesSpamSafeBlockedListMatches=column_ifexists('filter_modules_spam_safeBlockedListMatches_s', ''),\r\n\t\t        FilterModulesSpamVersionEngine=column_ifexists('filter_modules_spam_version_engine_s', ''),\r\n\t\t        FilterModulesSpamVersionDefinitions=column_ifexists('filter_modules_spam_version_definitions_s', ''),\r\n\t\t        FilterModulesSpamScoresOverall=column_ifexists('filter_modules_spam_scores_overall_d', ''),\r\n\t\t        FilterModulesSpamScoresEngine=column_ifexists('filter_modules_spam_scores_engine_d', ''),\r\n\t\t        FilterModulesSpamScoresClassifiers=column_ifexists('filter_modules_spam_scores_classifiers_s', ''),\r\n\t\t        FilterModulesSpamLangs=column_ifexists('filter_modules_spam_langs_s', ''),\r\n\t\t        FilterModulesUrldefenseVersionEngine=column_ifexists('filter_modules_urldefense_version_engine_s', ''),\r\n\t\t        FilterModulesUrldefenseCountsUnique=column_ifexists('filter_modules_urldefense_counts_unique_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsRewritten=column_ifexists('filter_modules_urldefense_counts_rewritten_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsTotal=column_ifexists('filter_modules_urldefense_counts_total_d', ''),\r\n\t\t        FilterModulesDkimv=column_ifexists('filter_modules_dkimv_s', ''),\r\n\t\t        FilterModulesPdrV2Response=column_ifexists('filter_modules_pdr_v2_response_s', ''),\r\n\t\t        FilterModulesZerohourScore=column_ifexists('filter_modules_zerohour_score_s', ''),\r\n\t\t        FilterDisposition=column_ifexists('filter_disposition_s', ''),\r\n\t\t        FilterSuborgsRcpts=column_ifexists('filter_suborgs_rcpts_s', ''),\r\n\t        \tFilterSuborgsSender=column_ifexists('filter_suborgs_sender_s', ''),\r\n\t        \tFilterMsgSizeBytes=column_ifexists('filter_msgSizeBytes_d', ''),\r\n\t\t        FilterVerifiedRcptsHashed=column_ifexists('filter_verified_rcptsHashed_s', ''),\r\n\t\t        FilterVerifiedRcpts=column_ifexists('filter_verified_rcpts_s', ''),\r\n\t        \tGuid=column_ifexists('guid_s', ''),\r\n\t        \tEnvelopeRcptsHashed=column_ifexists('envelope_rcptsHashed_s', ''),\r\n\t        \tEnvelopeFromHashed=column_ifexists('envelope_fromHashed_s', ''),\r\n\t        \tMsgNormalizedHeaderReturnPathHashed=column_ifexists('msg_normalizedHeader_return_pathHashed_s', ''),\r\n\t        \tMsgNormalizedHeaderXMailer=column_ifexists('msg_normalizedHeader_x_mailer_s', ''),\r\n\t\t        MsgNormalizedHeaderReturnPath=column_ifexists('msg_normalizedHeader_return_path_s', ''),\r\n\t\t        MsgHeaderXMailer=column_ifexists('msg_header_x_mailer_s', ''),\r\n\t\t        MsgHeaderReturnPathHashed=column_ifexists('msg_header_return_pathHashed_s', ''),\r\n\t\t        MsgHeaderReturnPath=column_ifexists('msg_header_return_path_s', ''),\r\n\t\t        FilterModulesSpamCharsets=column_ifexists('filter_modules_spam_charsets_s', ''),\r\n\t\t        FilterModulesDmarcAlignment=column_ifexists('filter_modules_dmarc_alignment_s', ''),\r\n\t\t        MsgNormalizedHeaderXOriginatingIp=column_ifexists('msg_normalizedHeader_x_originating_ip_s', ''),\r\n\t\t        MsgHeaderXOriginatingIp=column_ifexists('msg_header_x_originating_ip_s', ''),\r\n\t\t        MsgNormalizedHeaderReplyTo=column_ifexists('msg_normalizedHeader_reply_to_s', ''),\r\n\t\t        MsgNormalizedHeaderReplyToHashed=column_ifexists('msg_normalizedHeader_reply_toHashed_s', ''),\r\n\t\t        MsgHeaderReplyToHashed=column_ifexists('msg_header_reply_toHashed_s', ''),\r\n\t\t        MsgHeaderReplyTo=column_ifexists('msg_header_reply_to_s', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsEmail=column_ifexists('filter_modules_urldefense_counts_noRewriteIsEmail_d', ''),\r\n\t\t        FilterModulesPdrV2Rscore=column_ifexists('filter_modules_pdr_v2_rscore_d', ''),\r\n\t\t        FilterOrigGuid=column_ifexists('filter_origGuid_s', ''),\r\n\t\t        MsgNormalizedHeaderCc=column_ifexists('msg_normalizedHeader_cc_s', ''),\r\n\t\t        MsgNormalizedHeaderCcHashed=column_ifexists('msg_normalizedHeader_ccHashed_s', ''),\r\n\t\t        MsgParsedAddressesCcHashed=column_ifexists('msg_parsedAddresses_ccHashed_s', ''),\r\n\t\t        MsgParsedAddressesCc=column_ifexists('msg_parsedAddresses_cc_s', ''),\r\n\t\t        MsgHeaderCcHashed=column_ifexists('msg_header_ccHashed_s', ''),\r\n\t\t        MsgHeaderCc=column_ifexists('msg_header_cc_s', ''),\r\n\t\t        FilterModulesAvVirusNames=column_ifexists('filter_modules_av_virusNames_s', ''),\r\n\t\t        FilterThrottleIp=column_ifexists('filter_throttleIp_s', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme=column_ifexists('filter_modules_urldefense_counts_noRewriteIsUnsupportedScheme_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsSchemeless=column_ifexists('filter_modules_urldefense_counts_noRewriteIsSchemeless_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded=column_ifexists('filter_modules_urldefense_counts_noRewriteIsMaxLengthExceeded_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain=column_ifexists('filter_modules_urldefense_counts_noRewriteIsExcludedDomain_d', ''),\r\n                PpsAgent=column_ifexists('pps_agent_s', ''),\r\n                EventOriginalTime=column_ifexists('ts_t', ''),\r\n                TlsCipher=column_ifexists('connection_tls_inbound_cipher_s', ''),\r\n                TlsCipherBits=column_ifexists('connection_tls_inbound_cipherBits_d', ''),\r\n                TlsVersion=column_ifexists('connection_tls_inbound_version_s', ''),\r\n                SrcIpAddr=column_ifexists('connection_ip_s', ''),\r\n                NetworkSessionId=column_ifexists('connection_sid_s', ''),\r\n                SrcDvcHostname=column_ifexists('connection_host_s', ''),\r\n                SrcGeoCountry=column_ifexists('connection_country_s', ''),\r\n                NetworkProtocol=column_ifexists('connection_protocol_s', ''),\r\n                NetworkConnectionState=column_ifexists('connection_resolveStatus_s', ''),\r\n                NetworkBytes=toreal( column_ifexists('sm_sizeBytes_s', '')),\r\n                NetworkDuration=column_ifexists('filter_durationSecs_d', ''),\r\n                EventStartTime=column_ifexists('filter_startTime_t', ''),\r\n                NetworkDirection=column_ifexists('filter_routeDirection_s', ''),\r\n                DstUserUpn=column_ifexists('envelope_rcpts_s', ''),\r\n                SrcUserUpn=column_ifexists('envelope_from_s', ''),\r\n                EventType=column_ifexists('event_type_s', ''),\r\n                EventVendor=\"Proofpoint\",\r\n                EventProduct=\"Proofpoint On Demand Email Security\"\r\n    | project\r\n                TimeGenerated, \r\n                EventVendor,\r\n                EventProduct,\r\n                FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize,\r\n                PpsVersion,\r\n                PpsCid,\r\n                MsgParts,\r\n                MetadataOriginDataAgent,\r\n                MetadataOriginDataVersion,\r\n                MetadataOriginDataCid,\r\n                ConnectionHelo,\r\n                MsgLang,\r\n                MsgNormalizedHeaderSubject,\r\n                MsgNormalizedHeaderMessageId,\r\n                MsgNormalizedHeaderTo,\r\n                MsgNormalizedHeadertoHashed,\r\n                MsgNormalizedHeaderFrom,\r\n                MsgNormalizedHeaderFromHashed,\r\n                MsgHeaderFrom,\r\n                MsgHeaderFromHashed,\r\n                MsgHeaderMessageId,\r\n                MsgHeaderSubject,\r\n                MsgHeaderTo,\r\n                MsgHeaderToHashed,\r\n                MsgParsedAddressesFromHashed,\r\n                MsgParsedAddressesFrom,\r\n                MsgParsedAddressesToHashed,\r\n                MsgParsedAddressesTo,\r\n                FilterActions,\r\n                FilterRoutes,\r\n                FilterQid,\r\n                FilterIsMsgEncrypted,\r\n                FilterIsMsgReinjected,\r\n                FilterQuarantineRule,\r\n                FilterQuarantineFolder,\r\n                FilterModulesDmarcSrvid,\r\n                FilterModulesDmarcRecords,\r\n                FilterModulesDmarcFilterdResult,\r\n                FilterModulesDmarcAuthResults,\r\n                FilterModulesSpfDomain,\r\n                FilterModulesSpfResult,\r\n                FilterModulesSpamTriggeredClassifier,\r\n                FilterModulesSpamSafeBlockedListMatches,\r\n                FilterModulesSpamVersionEngine,\r\n                FilterModulesSpamVersionDefinitions,\r\n                FilterModulesSpamScoresOverall,\r\n                FilterModulesSpamScoresEngine,\r\n                FilterModulesSpamScoresClassifiers,\r\n                FilterModulesSpamLangs,\r\n                FilterModulesUrldefenseVersionEngine,\r\n                FilterModulesUrldefenseCountsUnique,\r\n                FilterModulesUrldefenseCountsRewritten,\r\n                FilterModulesUrldefenseCountsTotal,\r\n                FilterModulesDkimv,\r\n                FilterModulesPdrV2Response,\r\n                FilterModulesZerohourScore,\r\n                FilterDisposition,\r\n                FilterSuborgsRcpts,\r\n                FilterSuborgsSender,\r\n                FilterMsgSizeBytes,\r\n                FilterVerifiedRcptsHashed,\r\n                FilterVerifiedRcpts,\r\n                Guid,\r\n                EnvelopeRcptsHashed,\r\n                EnvelopeFromHashed,\r\n                MsgNormalizedHeaderReturnPathHashed,\r\n                MsgNormalizedHeaderXMailer,\r\n                MsgNormalizedHeaderReturnPath,\r\n                MsgHeaderXMailer,\r\n                MsgHeaderReturnPathHashed,\r\n                MsgHeaderReturnPath,\r\n                FilterModulesSpamCharsets,\r\n                FilterModulesDmarcAlignment,\r\n                MsgNormalizedHeaderXOriginatingIp,\r\n                MsgHeaderXOriginatingIp,\r\n                MsgNormalizedHeaderReplyTo,\r\n                MsgNormalizedHeaderReplyToHashed,\r\n                MsgHeaderReplyToHashed,\r\n                MsgHeaderReplyTo,\r\n                FilterModulesUrldefenseCountsNoRewriteIsEmail,\r\n                FilterModulesPdrV2Rscore,\r\n                FilterOrigGuid,\r\n                MsgNormalizedHeaderCc,\r\n                MsgNormalizedHeaderCcHashed,\r\n                MsgParsedAddressesCcHashed,\r\n                MsgParsedAddressesCc,\r\n                MsgHeaderCcHashed,\r\n                MsgHeaderCc,\r\n                FilterModulesAvVirusNames,\r\n                FilterThrottleIp,\r\n                FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme,\r\n                FilterModulesUrldefenseCountsNoRewriteIsSchemeless,\r\n                FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded,\r\n                FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain,\r\n                PpsAgent,\r\n                SrcDvcHostname,\r\n                EventOriginalTime,\r\n                TlsCipher,\r\n                TlsCipherBits,\r\n                TlsVersion,\r\n                SrcIpAddr,\r\n                NetworkSessionId,\r\n                SrcGeoCountry,\r\n                NetworkProtocol,\r\n                NetworkConnectionState,\r\n                NetworkBytes,\r\n                NetworkDuration,\r\n                EventStartTime,\r\n                NetworkDirection,\r\n                DstUserUpn,\r\n                SrcUserUpn,\r\n                EventType\r\n\t| join kind=inner  (\r\n\t\tProofpointPOD_message_CL\r\n\t\t| extend Guid = column_ifexists('guid_s', ''),\r\n\t\t    MsgParts=column_ifexists('msgParts_s', '')\r\n\t\t| extend d = parse_json(MsgParts)\r\n\t\t| mv-apply d on (where isnotempty(d.urls)\r\n\t\t    | extend URL_LIST = tostring(d.urls))\r\n\t\t| extend e = parse_json(URL_LIST)\r\n\t\t| mv-apply e on (where isnotempty(e.url)\r\n\t\t    | extend URLLIST = tostring(e.url))\r\n\t\t| summarize make_set(URLLIST) by Guid\r\n        )\r\n        on Guid\r\n    | project-away Guid1\r\n    | project-rename Urls = set_URLLIST\r\n};\r\nunion isfuzzy=true ProofpointPOD_message_view, ProofpointPOD_maillog_view\r\n",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "ProofpointPOD Data Parser"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "Proofpoint On demand(POD) Email Security",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2021-06-01",
      "name": "[variables('_parserName1')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "ProofpointPOD Data Parser",
        "category": "Samples",
        "functionAlias": "ProofpointPOD",
        "query": "\nlet ProofpointPOD_maillog_view = view () { \r\n    union isfuzzy=true ProofpointPOD_maillog_CL, maillog_CL | where isnotempty( pps_cid_s) and event_type_s == \"maillog\"\r\n    | extend \r\n                SmMsgid=column_ifexists('sm_msgid_g', ''),\r\n                PpsCid=column_ifexists('pps_cid_s', ''),\r\n                PpsAgent=column_ifexists('pps_agent_s', ''),\r\n                Id=column_ifexists('id_s', ''),\r\n                SmNrcpts=column_ifexists('sm_nrcpts_s', ''),\r\n                SmAuth=column_ifexists('sm_auth_s', ''),\r\n                SmClass=column_ifexists('sm_class_s', ''),\r\n                SmQid=column_ifexists('sm_qid_s', ''),\r\n                MetadataOriginDataAgent=column_ifexists('metadata_origin_data_agent_s', ''),\r\n                MetadataOriginDataCid=column_ifexists('metadata_origin_data_cid_s', ''),\r\n                SmMailer=column_ifexists('sm_mailer_s', ''),\r\n                SmDsn=column_ifexists('sm_dsn_s', ''),\r\n                SmPri=column_ifexists('sm_pri_s', ''),\r\n                SmXdelay=column_ifexists('sm_xdelay_s', ''),\r\n                SmCtladdr=column_ifexists('sm_ctladdr_s', ''),\r\n                EventUid=column_ifexists('sm_msgid_s', ''),\r\n                NetworkBytes=toreal( column_ifexists('sm_sizeBytes_s', '')),\r\n                TlsEstablished=column_ifexists('sm_tls_verify_s', ''),\r\n                SrcNatIpAddr=column_ifexists('sm_relay_s', ''),\r\n                ProcessName=column_ifexists('sm_daemon_s', ''),\r\n                NetworkProtocol=column_ifexists('sm_proto_s', ''),\r\n                SrcUserUpn=column_ifexists('sm_from_s', ''),\r\n                EventOriginalTime=column_ifexists('ts_t', ''),\r\n                EventOriginalMessage=column_ifexists('data_s', ''),\r\n                EventType=column_ifexists('event_type_s', ''),\r\n                NetworkConnectionStateDetailed=column_ifexists('sm_stat_s', ''),\r\n                DstUserUpn=column_ifexists('sm_to_s', ''),\r\n                NetworkDuration=column_ifexists('sm_delay_s', ''),\r\n                EventVendor=\"Proofpoint\",\r\n                EventProduct=\"Proofpoint On Demand Email Security\"\r\n    | project\r\n                TimeGenerated, \r\n                EventVendor,\r\n                EventProduct,\r\n                SmMsgid,\r\n                PpsCid,\r\n                PpsAgent,\r\n                Id,\r\n                SmNrcpts,\r\n                SmAuth,\r\n                SmClass,\r\n                SmQid,\r\n                MetadataOriginDataAgent,\r\n                MetadataOriginDataCid,\r\n                SmMailer,\r\n                SmDsn,\r\n                SmPri,\r\n                SmXdelay,\r\n                SmCtladdr,\r\n                EventUid,\r\n                NetworkBytes,\r\n                TlsEstablished,\r\n                SrcNatIpAddr,\r\n                ProcessName,\r\n                NetworkProtocol,\r\n                SrcUserUpn,\r\n                EventOriginalTime,\r\n                EventOriginalMessage,\r\n                EventType,\r\n                NetworkConnectionStateDetailed,\r\n                DstUserUpn,\r\n                NetworkDuration\r\n};\r\nlet ProofpointPOD_message_view = view () { \r\n    union isfuzzy=true ProofpointPOD_message_CL, message_CL | where event_type_s == \"message\"\r\n    | extend \r\n                FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize=column_ifexists('filter_modules_urldefense_counts_noRewriteIsLargeMsgPartSize_d', ''),\r\n\t\t        PpsVersion=column_ifexists('pps_version_s', ''),\r\n\t\t        PpsCid=column_ifexists('pps_cid_s', ''),\r\n\t\t        MsgParts=column_ifexists('msgParts_s', ''),\r\n\t\t        MetadataOriginDataAgent=column_ifexists('metadata_origin_data_agent_s', ''),\r\n\t\t        MetadataOriginDataVersion=column_ifexists('metadata_origin_data_version_s', ''),\r\n\t\t        MetadataOriginDataCid=column_ifexists('metadata_origin_data_cid_s', ''),\r\n\t\t        ConnectionHelo=column_ifexists('connection_helo_s', ''),\r\n\t\t        MsgLang=column_ifexists('msg_lang_s', ''),\r\n\t\t        MsgNormalizedHeaderSubject=column_ifexists('msg_normalizedHeader_subject_s', ''),\r\n\t\t        MsgNormalizedHeaderMessageId=column_ifexists('msg_normalizedHeader_message_id_s', ''),\r\n\t\t        MsgNormalizedHeaderTo=column_ifexists('msg_normalizedHeader_to_s', ''),\r\n\t\t        MsgNormalizedHeadertoHashed=column_ifexists('msg_normalizedHeader_toHashed_s', ''),\r\n\t\t        MsgNormalizedHeaderFrom=column_ifexists('msg_normalizedHeader_from_s', ''),\r\n\t\t        MsgNormalizedHeaderFromHashed=column_ifexists('msg_normalizedHeader_fromHashed_s', ''),\r\n\t\t        MsgHeaderFrom=column_ifexists('msg_header_from_s', ''),\r\n\t\t        MsgHeaderFromHashed=column_ifexists('msg_header_fromHashed_s', ''),\r\n\t\t        MsgHeaderMessageId=column_ifexists('msg_header_message_id_s', ''),\r\n\t\t        MsgHeaderSubject=column_ifexists('msg_header_subject_s', ''),\r\n\t\t        MsgHeaderTo=column_ifexists('msg_header_to_s', ''),\r\n\t\t        MsgHeaderToHashed=column_ifexists('msg_header_toHashed_s', ''),\r\n\t\t        MsgParsedAddressesFromHashed=column_ifexists('msg_parsedAddresses_fromHashed_s', ''),\r\n\t\t        MsgParsedAddressesFrom=column_ifexists('msg_parsedAddresses_from_s', ''),\r\n\t\t        MsgParsedAddressesToHashed=column_ifexists('msg_parsedAddresses_toHashed_s', ''),\r\n\t\t        MsgParsedAddressesTo=column_ifexists('msg_parsedAddresses_to_s', ''),\r\n\t\t        FilterActions=column_ifexists('filter_actions_s', ''),\r\n\t\t        FilterRoutes=column_ifexists('filter_routes_s', ''),\r\n\t\t        FilterQid=column_ifexists('filter_qid_s', ''),\r\n\t\t        FilterIsMsgEncrypted=column_ifexists('filter_isMsgEncrypted_b', ''),\r\n\t\t        FilterIsMsgReinjected=column_ifexists('filter_isMsgReinjected_b', ''),\r\n\t\t        FilterQuarantineRule=column_ifexists('filter_quarantine_rule_s', ''),\r\n\t\t        FilterQuarantineFolder=column_ifexists('filter_quarantine_folder_s', ''),\r\n\t\t        FilterModulesDmarcSrvid=column_ifexists('filter_modules_dmarc_srvid_s', ''),\r\n\t\t        FilterModulesDmarcRecords=column_ifexists('filter_modules_dmarc_records_s', ''),\r\n\t\t        FilterModulesDmarcFilterdResult=column_ifexists('filter_modules_dmarc_filterdResult_s', ''),\r\n\t\t        FilterModulesDmarcAuthResults=column_ifexists('filter_modules_dmarc_authResults_s', ''),\r\n\t\t        FilterModulesSpfDomain=column_ifexists('filter_modules_spf_domain_s', ''),\r\n\t\t        FilterModulesSpfResult=column_ifexists('filter_modules_spf_result_s', ''),\r\n\t\t        FilterModulesSpamTriggeredClassifier=column_ifexists('filter_modules_spam_triggeredClassifier_s', ''),\r\n\t\t        FilterModulesSpamSafeBlockedListMatches=column_ifexists('filter_modules_spam_safeBlockedListMatches_s', ''),\r\n\t\t        FilterModulesSpamVersionEngine=column_ifexists('filter_modules_spam_version_engine_s', ''),\r\n\t\t        FilterModulesSpamVersionDefinitions=column_ifexists('filter_modules_spam_version_definitions_s', ''),\r\n\t\t        FilterModulesSpamScoresOverall=column_ifexists('filter_modules_spam_scores_overall_d', ''),\r\n\t\t        FilterModulesSpamScoresEngine=column_ifexists('filter_modules_spam_scores_engine_d', ''),\r\n\t\t        FilterModulesSpamScoresClassifiers=column_ifexists('filter_modules_spam_scores_classifiers_s', ''),\r\n\t\t        FilterModulesSpamLangs=column_ifexists('filter_modules_spam_langs_s', ''),\r\n\t\t        FilterModulesUrldefenseVersionEngine=column_ifexists('filter_modules_urldefense_version_engine_s', ''),\r\n\t\t        FilterModulesUrldefenseCountsUnique=column_ifexists('filter_modules_urldefense_counts_unique_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsRewritten=column_ifexists('filter_modules_urldefense_counts_rewritten_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsTotal=column_ifexists('filter_modules_urldefense_counts_total_d', ''),\r\n\t\t        FilterModulesDkimv=column_ifexists('filter_modules_dkimv_s', ''),\r\n\t\t        FilterModulesPdrV2Response=column_ifexists('filter_modules_pdr_v2_response_s', ''),\r\n\t\t        FilterModulesZerohourScore=column_ifexists('filter_modules_zerohour_score_s', ''),\r\n\t\t        FilterDisposition=column_ifexists('filter_disposition_s', ''),\r\n\t\t        FilterSuborgsRcpts=column_ifexists('filter_suborgs_rcpts_s', ''),\r\n\t        \tFilterSuborgsSender=column_ifexists('filter_suborgs_sender_s', ''),\r\n\t        \tFilterMsgSizeBytes=column_ifexists('filter_msgSizeBytes_d', ''),\r\n\t\t        FilterVerifiedRcptsHashed=column_ifexists('filter_verified_rcptsHashed_s', ''),\r\n\t\t        FilterVerifiedRcpts=column_ifexists('filter_verified_rcpts_s', ''),\r\n\t        \tGuid=column_ifexists('guid_s', ''),\r\n\t        \tEnvelopeRcptsHashed=column_ifexists('envelope_rcptsHashed_s', ''),\r\n\t        \tEnvelopeFromHashed=column_ifexists('envelope_fromHashed_s', ''),\r\n\t        \tMsgNormalizedHeaderReturnPathHashed=column_ifexists('msg_normalizedHeader_return_pathHashed_s', ''),\r\n\t        \tMsgNormalizedHeaderXMailer=column_ifexists('msg_normalizedHeader_x_mailer_s', ''),\r\n\t\t        MsgNormalizedHeaderReturnPath=column_ifexists('msg_normalizedHeader_return_path_s', ''),\r\n\t\t        MsgHeaderXMailer=column_ifexists('msg_header_x_mailer_s', ''),\r\n\t\t        MsgHeaderReturnPathHashed=column_ifexists('msg_header_return_pathHashed_s', ''),\r\n\t\t        MsgHeaderReturnPath=column_ifexists('msg_header_return_path_s', ''),\r\n\t\t        FilterModulesSpamCharsets=column_ifexists('filter_modules_spam_charsets_s', ''),\r\n\t\t        FilterModulesDmarcAlignment=column_ifexists('filter_modules_dmarc_alignment_s', ''),\r\n\t\t        MsgNormalizedHeaderXOriginatingIp=column_ifexists('msg_normalizedHeader_x_originating_ip_s', ''),\r\n\t\t        MsgHeaderXOriginatingIp=column_ifexists('msg_header_x_originating_ip_s', ''),\r\n\t\t        MsgNormalizedHeaderReplyTo=column_ifexists('msg_normalizedHeader_reply_to_s', ''),\r\n\t\t        MsgNormalizedHeaderReplyToHashed=column_ifexists('msg_normalizedHeader_reply_toHashed_s', ''),\r\n\t\t        MsgHeaderReplyToHashed=column_ifexists('msg_header_reply_toHashed_s', ''),\r\n\t\t        MsgHeaderReplyTo=column_ifexists('msg_header_reply_to_s', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsEmail=column_ifexists('filter_modules_urldefense_counts_noRewriteIsEmail_d', ''),\r\n\t\t        FilterModulesPdrV2Rscore=column_ifexists('filter_modules_pdr_v2_rscore_d', ''),\r\n\t\t        FilterOrigGuid=column_ifexists('filter_origGuid_s', ''),\r\n\t\t        MsgNormalizedHeaderCc=column_ifexists('msg_normalizedHeader_cc_s', ''),\r\n\t\t        MsgNormalizedHeaderCcHashed=column_ifexists('msg_normalizedHeader_ccHashed_s', ''),\r\n\t\t        MsgParsedAddressesCcHashed=column_ifexists('msg_parsedAddresses_ccHashed_s', ''),\r\n\t\t        MsgParsedAddressesCc=column_ifexists('msg_parsedAddresses_cc_s', ''),\r\n\t\t        MsgHeaderCcHashed=column_ifexists('msg_header_ccHashed_s', ''),\r\n\t\t        MsgHeaderCc=column_ifexists('msg_header_cc_s', ''),\r\n\t\t        FilterModulesAvVirusNames=column_ifexists('filter_modules_av_virusNames_s', ''),\r\n\t\t        FilterThrottleIp=column_ifexists('filter_throttleIp_s', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme=column_ifexists('filter_modules_urldefense_counts_noRewriteIsUnsupportedScheme_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsSchemeless=column_ifexists('filter_modules_urldefense_counts_noRewriteIsSchemeless_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded=column_ifexists('filter_modules_urldefense_counts_noRewriteIsMaxLengthExceeded_d', ''),\r\n\t\t        FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain=column_ifexists('filter_modules_urldefense_counts_noRewriteIsExcludedDomain_d', ''),\r\n                PpsAgent=column_ifexists('pps_agent_s', ''),\r\n                EventOriginalTime=column_ifexists('ts_t', ''),\r\n                TlsCipher=column_ifexists('connection_tls_inbound_cipher_s', ''),\r\n                TlsCipherBits=column_ifexists('connection_tls_inbound_cipherBits_d', ''),\r\n                TlsVersion=column_ifexists('connection_tls_inbound_version_s', ''),\r\n                SrcIpAddr=column_ifexists('connection_ip_s', ''),\r\n                NetworkSessionId=column_ifexists('connection_sid_s', ''),\r\n                SrcDvcHostname=column_ifexists('connection_host_s', ''),\r\n                SrcGeoCountry=column_ifexists('connection_country_s', ''),\r\n                NetworkProtocol=column_ifexists('connection_protocol_s', ''),\r\n                NetworkConnectionState=column_ifexists('connection_resolveStatus_s', ''),\r\n                NetworkBytes=toreal( column_ifexists('sm_sizeBytes_s', '')),\r\n                NetworkDuration=column_ifexists('filter_durationSecs_d', ''),\r\n                EventStartTime=column_ifexists('filter_startTime_t', ''),\r\n                NetworkDirection=column_ifexists('filter_routeDirection_s', ''),\r\n                DstUserUpn=column_ifexists('envelope_rcpts_s', ''),\r\n                SrcUserUpn=column_ifexists('envelope_from_s', ''),\r\n                EventType=column_ifexists('event_type_s', ''),\r\n                EventVendor=\"Proofpoint\",\r\n                EventProduct=\"Proofpoint On Demand Email Security\"\r\n    | project\r\n                TimeGenerated, \r\n                EventVendor,\r\n                EventProduct,\r\n                FilterModulesUrldefenseCountsNoRewriteIsLargeMsgPartSize,\r\n                PpsVersion,\r\n                PpsCid,\r\n                MsgParts,\r\n                MetadataOriginDataAgent,\r\n                MetadataOriginDataVersion,\r\n                MetadataOriginDataCid,\r\n                ConnectionHelo,\r\n                MsgLang,\r\n                MsgNormalizedHeaderSubject,\r\n                MsgNormalizedHeaderMessageId,\r\n                MsgNormalizedHeaderTo,\r\n                MsgNormalizedHeadertoHashed,\r\n                MsgNormalizedHeaderFrom,\r\n                MsgNormalizedHeaderFromHashed,\r\n                MsgHeaderFrom,\r\n                MsgHeaderFromHashed,\r\n                MsgHeaderMessageId,\r\n                MsgHeaderSubject,\r\n                MsgHeaderTo,\r\n                MsgHeaderToHashed,\r\n                MsgParsedAddressesFromHashed,\r\n                MsgParsedAddressesFrom,\r\n                MsgParsedAddressesToHashed,\r\n                MsgParsedAddressesTo,\r\n                FilterActions,\r\n                FilterRoutes,\r\n                FilterQid,\r\n                FilterIsMsgEncrypted,\r\n                FilterIsMsgReinjected,\r\n                FilterQuarantineRule,\r\n                FilterQuarantineFolder,\r\n                FilterModulesDmarcSrvid,\r\n                FilterModulesDmarcRecords,\r\n                FilterModulesDmarcFilterdResult,\r\n                FilterModulesDmarcAuthResults,\r\n                FilterModulesSpfDomain,\r\n                FilterModulesSpfResult,\r\n                FilterModulesSpamTriggeredClassifier,\r\n                FilterModulesSpamSafeBlockedListMatches,\r\n                FilterModulesSpamVersionEngine,\r\n                FilterModulesSpamVersionDefinitions,\r\n                FilterModulesSpamScoresOverall,\r\n                FilterModulesSpamScoresEngine,\r\n                FilterModulesSpamScoresClassifiers,\r\n                FilterModulesSpamLangs,\r\n                FilterModulesUrldefenseVersionEngine,\r\n                FilterModulesUrldefenseCountsUnique,\r\n                FilterModulesUrldefenseCountsRewritten,\r\n                FilterModulesUrldefenseCountsTotal,\r\n                FilterModulesDkimv,\r\n                FilterModulesPdrV2Response,\r\n                FilterModulesZerohourScore,\r\n                FilterDisposition,\r\n                FilterSuborgsRcpts,\r\n                FilterSuborgsSender,\r\n                FilterMsgSizeBytes,\r\n                FilterVerifiedRcptsHashed,\r\n                FilterVerifiedRcpts,\r\n                Guid,\r\n                EnvelopeRcptsHashed,\r\n                EnvelopeFromHashed,\r\n                MsgNormalizedHeaderReturnPathHashed,\r\n                MsgNormalizedHeaderXMailer,\r\n                MsgNormalizedHeaderReturnPath,\r\n                MsgHeaderXMailer,\r\n                MsgHeaderReturnPathHashed,\r\n                MsgHeaderReturnPath,\r\n                FilterModulesSpamCharsets,\r\n                FilterModulesDmarcAlignment,\r\n                MsgNormalizedHeaderXOriginatingIp,\r\n                MsgHeaderXOriginatingIp,\r\n                MsgNormalizedHeaderReplyTo,\r\n                MsgNormalizedHeaderReplyToHashed,\r\n                MsgHeaderReplyToHashed,\r\n                MsgHeaderReplyTo,\r\n                FilterModulesUrldefenseCountsNoRewriteIsEmail,\r\n                FilterModulesPdrV2Rscore,\r\n                FilterOrigGuid,\r\n                MsgNormalizedHeaderCc,\r\n                MsgNormalizedHeaderCcHashed,\r\n                MsgParsedAddressesCcHashed,\r\n                MsgParsedAddressesCc,\r\n                MsgHeaderCcHashed,\r\n                MsgHeaderCc,\r\n                FilterModulesAvVirusNames,\r\n                FilterThrottleIp,\r\n                FilterModulesUrldefenseCountsNoRewriteIsUnsupportedScheme,\r\n                FilterModulesUrldefenseCountsNoRewriteIsSchemeless,\r\n                FilterModulesUrldefenseCountsNoRewriteIsMaxLengthExceeded,\r\n                FilterModulesUrldefenseCountsNoRewriteIsExcludedDomain,\r\n                PpsAgent,\r\n                SrcDvcHostname,\r\n                EventOriginalTime,\r\n                TlsCipher,\r\n                TlsCipherBits,\r\n                TlsVersion,\r\n                SrcIpAddr,\r\n                NetworkSessionId,\r\n                SrcGeoCountry,\r\n                NetworkProtocol,\r\n                NetworkConnectionState,\r\n                NetworkBytes,\r\n                NetworkDuration,\r\n                EventStartTime,\r\n                NetworkDirection,\r\n                DstUserUpn,\r\n                SrcUserUpn,\r\n                EventType\r\n\t| join kind=inner  (\r\n\t\tProofpointPOD_message_CL\r\n\t\t| extend Guid = column_ifexists('guid_s', ''),\r\n\t\t    MsgParts=column_ifexists('msgParts_s', '')\r\n\t\t| extend d = parse_json(MsgParts)\r\n\t\t| mv-apply d on (where isnotempty(d.urls)\r\n\t\t    | extend URL_LIST = tostring(d.urls))\r\n\t\t| extend e = parse_json(URL_LIST)\r\n\t\t| mv-apply e on (where isnotempty(e.url)\r\n\t\t    | extend URLLIST = tostring(e.url))\r\n\t\t| summarize make_set(URLLIST) by Guid\r\n        )\r\n        on Guid\r\n    | project-away Guid1\r\n    | project-rename Urls = set_URLLIST\r\n};\r\nunion isfuzzy=true ProofpointPOD_message_view, ProofpointPOD_maillog_view\r\n",
        "version": 1
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Proofpoint On demand(POD) Email Security",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 1 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName1'),'/',variables('huntingQueryVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScoreAdultValue_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_1",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'adult' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).adult > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'adult' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId1'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 1",
                "parentId": "[variables('huntingQueryId1')]",
                "contentId": "[variables('_huntingQuerycontentId1')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 2 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName2'),'/',variables('huntingQueryVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScoreMalwareValue_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_2",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'malware' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).malware > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'malware' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId2'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 2",
                "parentId": "[variables('huntingQueryId2')]",
                "contentId": "[variables('_huntingQuerycontentId2')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 3 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName3'),'/',variables('huntingQueryVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScorePhishValue_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_3",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'phish' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).phish > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'phish' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId3'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 3",
                "parentId": "[variables('huntingQueryId3')]",
                "contentId": "[variables('_huntingQuerycontentId3')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 4 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName4'),'/',variables('huntingQueryVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScoreSpamValue_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_4",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'spam' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).spam > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'spam' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId4'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 4",
                "parentId": "[variables('huntingQueryId4')]",
                "contentId": "[variables('_huntingQuerycontentId4')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 5 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName5'),'/',variables('huntingQueryVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighScoreSuspectValue_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_5",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Emails with high score of 'suspect' filter classifier value",
                "category": "Hunting Queries",
                "query": "let scoreThreshold = 80;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where todynamic(FilterModulesSpamScoresClassifiers).suspect > scoreThreshold\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails with high score of 'suspect' filter classifier value."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId5'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 5",
                "parentId": "[variables('huntingQueryId5')]",
                "contentId": "[variables('_huntingQuerycontentId5')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 6 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName6'),'/',variables('huntingQueryVersion6'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName6'))]"
      ],
      "properties": {
        "description": "ProofpointPODLargeOutboundEmails_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion6')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_6",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Large size outbound emails",
                "category": "Hunting Queries",
                "query": "let starttime = todatetime('{{StartTimeISO}}');\nlet endtime = todatetime('{{EndTimeISO}}');\nlet lookback = starttime - 14d;\nlet out_msg = ProofpointPOD\n| where TimeGenerated between (lookback..starttime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where SrcUserUpn != '';\nProofpointPOD\n| where TimeGenerated between(starttime..endtime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where SrcUserUpn != ''\n| summarize AvgMsgSize = toint(avg(NetworkBytes_real)) by SrcUserUpn\n| join out_msg on SrcUserUpn\n| where NetworkBytes_real > AvgMsgSize*2\n| project SrcUserUpn, AvgMsgSize, NetworkBytes_real\n| extend AccountCustomEntity = SrcUserUpn\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for emails which size is 2 times grater than average size of outbound email for user."
                  },
                  {
                    "name": "tactics",
                    "value": "Exfiltration"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId6'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 6",
                "parentId": "[variables('huntingQueryId6')]",
                "contentId": "[variables('_huntingQuerycontentId6')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 7 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName7'),'/',variables('huntingQueryVersion7'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName7'))]"
      ],
      "properties": {
        "description": "ProofpointPODRecipientsHighNumberDiscardReject_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion7')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_7",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Recipients with high number of discarded or rejected emails",
                "category": "Hunting Queries",
                "query": "let threshold = 10;\nProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where FilterDisposition !in ('reject', 'discard')\n| summarize count() by DstUserUpn\n| where count_ > threshold\n| extend AccountCustomEntity = DstUserUpn\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for recipients with high number of discarded or rejected emails."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId7'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 7",
                "parentId": "[variables('huntingQueryId7')]",
                "contentId": "[variables('_huntingQuerycontentId7')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 8 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName8'),'/',variables('huntingQueryVersion8'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName8'))]"
      ],
      "properties": {
        "description": "ProofpointPODRecipientsLargeNumberOfCorruptedEmails_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion8')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_8",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Recipients with large number of corrupted emails",
                "category": "Hunting Queries",
                "query": "ProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| extend isCorrupted = todynamic(MsgParts)[0]['isCorrupted']\n| where isCorrupted == 'true'\n| summarize count() by DstUserUpn\n| sort by count_\n| where count_ > 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for recipients with large number of corrupted emails."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId8'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 8",
                "parentId": "[variables('huntingQueryId8')]",
                "contentId": "[variables('_huntingQuerycontentId8')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 9 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName9'),'/',variables('huntingQueryVersion9'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName9'))]"
      ],
      "properties": {
        "description": "ProofpointPODSendersLargeNumberOfCorruptedEmails_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion9')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_9",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Senders with large number of corrupted messages",
                "category": "Hunting Queries",
                "query": "ProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| extend isCorrupted = todynamic(MsgParts)[0]['isCorrupted']\n| where isCorrupted == 'true'\n| summarize count() by SrcUserUpn\n| sort by count_\n| where count_ > 10\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Search for senders with large number of corrupted messages."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId9'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 9",
                "parentId": "[variables('huntingQueryId9')]",
                "contentId": "[variables('_huntingQuerycontentId9')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('huntingQueryTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Hunting Query 10 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Hunting Query template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('huntingQueryTemplateSpecName10'),'/',variables('huntingQueryVersion10'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "HuntingQuery"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('huntingQueryTemplateSpecName10'))]"
      ],
      "properties": {
        "description": "ProofpointPODSuspiciousFileTypesInAttachments_HuntingQueries Hunting Query with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('huntingQueryVersion10')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "Proofpoint_On_demand(POD)_Email_Security_Hunting_Query_10",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "ProofpointPOD - Suspicious file types in attachments",
                "category": "Hunting Queries",
                "query": "ProofpointPOD\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| extend attachedFileType = todynamic(MsgParts)[0]['detectedExt']\n| summarize count() by tostring(attachedFileType)\n| sort by count_\n",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": "Hunting for suspicious file types in attachments."
                  },
                  {
                    "name": "tactics",
                    "value": "InitialAccess"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('HuntingQuery-', last(split(variables('huntingQueryId10'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Hunting Query 10",
                "parentId": "[variables('huntingQueryId10')]",
                "contentId": "[variables('_huntingQuerycontentId10')]",
                "kind": "HuntingQuery",
                "version": "[variables('huntingQueryVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Analytics Rule 1 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName1'),'/',variables('analyticRuleVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "ProofpointPODBinaryInAttachment_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId1')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when email received with binary file as attachment.",
                "displayName": "ProofpointPOD - Binary file in attachment",
                "enabled": false,
                "query": "let lbtime = 10m;\nlet binaryTypes = dynamic(['zip', 'octet-stream', 'java-archive', 'rar', 'tar', 'x-7z-compressed', 'x-msdownload', 'portable-executable']);\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where FilterDisposition !in ('reject', 'discard')\n| extend attachedMimeType = tostring(todynamic(MsgParts)[0]['detectedMime'])\n| where attachedMimeType has_any (binaryTypes)\n| project SrcUserUpn, AccountCustomEntity = parse_json(DstUserUpn)[0], attachedMimeType, MsgHeaderSubject\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId1'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 1",
                "parentId": "[variables('analyticRuleId1')]",
                "contentId": "[variables('_analyticRulecontentId1')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Analytics Rule 2 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName2'),'/',variables('analyticRuleVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "ProofpointPODDataExfiltrationToPrivateEmail_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId2')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when sender sent email to the non-corporate domain and recipient's username is the same as sender's username.",
                "displayName": "ProofpointPOD - Possible data exfiltration to private email",
                "enabled": false,
                "query": "let lbtime = 10m;\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where array_length(todynamic(DstUserUpn)) == 1\n| extend sender = extract(@'\\A(.*?)@', 1, SrcUserUpn)\n| extend sender_domain = extract(@'@(.*)$', 1, SrcUserUpn)\n| extend recipient = extract(@'\\A(.*?)@', 1, tostring(todynamic(DstUserUpn)[0]))\n| extend recipient_domain = extract(@'@(.*)$', 1, tostring(todynamic(DstUserUpn)[0]))\n| where sender =~ recipient\n| where sender_domain != recipient_domain\n| project SrcUserUpn, DstUserUpn\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId2'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 2",
                "parentId": "[variables('analyticRuleId2')]",
                "contentId": "[variables('_analyticRulecontentId2')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Analytics Rule 3 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName3'),'/',variables('analyticRuleVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "ProofpointPODHighRiskNotDiscarded_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion3')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId3')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when email with high risk score was not rejected or discarded by filters.",
                "displayName": "ProofpointPOD - High risk message not discarded",
                "enabled": false,
                "query": "let lbtime = 10m;\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where FilterDisposition !in ('reject', 'discard')\n| where FilterModulesSpamScoresOverall == '100'\n| project SrcUserUpn, DstUserUpn\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId3'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 3",
                "parentId": "[variables('analyticRuleId3')]",
                "contentId": "[variables('_analyticRulecontentId3')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Analytics Rule 4 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName4'),'/',variables('analyticRuleVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "ProofpointPODMultipleArchivedAttachmentsToSameRecipient_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion4')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId4')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when multiple emails where sent to the same recipient with large archived attachments.",
                "displayName": "ProofpointPOD - Multiple archived attachments to the same recipient",
                "enabled": false,
                "query": "let lbtime = 30m;\nlet msgthreshold = 3;\nlet compressedTypes = dynamic(['zip', 'rar', 'tar', 'x-7z-compressed']);\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| extend attachedMimeType = todynamic(MsgParts)[0]['detectedMime']\n| where attachedMimeType has_any (compressedTypes)\n| summarize count(), make_set(attachedMimeType) by SrcUserUpn, DstUserUpn\n| where count_ > msgthreshold\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT30M",
                "queryPeriod": "PT30M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "Exfiltration"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId4'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 4",
                "parentId": "[variables('analyticRuleId4')]",
                "contentId": "[variables('_analyticRulecontentId4')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Analytics Rule 5 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName5'),'/',variables('analyticRuleVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "ProofpointPODMultipleLargeEmailsToSameRecipient_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion5')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId5')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when multiple emails with large size where sent to the same recipient.",
                "displayName": "ProofpointPOD - Multiple large emails to the same recipient",
                "enabled": false,
                "query": "let lbtime = 30m;\nlet msgthreshold = 3;\nlet msgszthreshold = 3000000;\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where NetworkBytes > msgszthreshold\n| summarize count() by SrcUserUpn, DstUserUpn\n| where count_ > msgthreshold\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT30M",
                "queryPeriod": "PT30M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "Exfiltration"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId5'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 5",
                "parentId": "[variables('analyticRuleId5')]",
                "contentId": "[variables('_analyticRulecontentId5')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Analytics Rule 6 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName6'),'/',variables('analyticRuleVersion6'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName6'))]"
      ],
      "properties": {
        "description": "ProofpointPODMultipleProtectedEmailsToUnknownRecipient_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion6')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId6')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when multiple protected messages where sent to early not seen recipient.",
                "displayName": "ProofpointPOD - Multiple protected emails to unknown recipient",
                "enabled": false,
                "query": "let lbtime = 30m;\nlet lbperiod = 14d;\nlet knownrecipients = ProofpointPOD\n| where TimeGenerated > ago(lbperiod)\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| where SrcUserUpn != ''\n| where array_length(todynamic(DstUserUpn)) == 1\n| summarize recipients = make_set(tostring(todynamic(DstUserUpn)[0])) by SrcUserUpn\n| extend commcol = SrcUserUpn;\nProofpointPOD\n| where TimeGenerated between (ago(lbtime) .. now())\n| where EventType == 'message'\n| where NetworkDirection == 'outbound'\n| extend isProtected = todynamic(MsgParts)[0]['isProtected']\n| extend mimePgp = todynamic(MsgParts)[0]['detectedMime']\n| where isProtected == 'true' or mimePgp == 'application/pgp-encrypted'\n| extend DstUserMail = tostring(todynamic(DstUserUpn)[0])\n| extend commcol = tostring(todynamic(DstUserUpn)[0])\n| join knownrecipients on commcol\n| where recipients !contains DstUserMail\n| project SrcUserUpn, DstUserMail\n| extend AccountCustomEntity = SrcUserUpn\n",
                "queryFrequency": "PT30M",
                "queryPeriod": "PT30M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "Exfiltration"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId6'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 6",
                "parentId": "[variables('analyticRuleId6')]",
                "contentId": "[variables('_analyticRulecontentId6')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Analytics Rule 7 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName7'),'/',variables('analyticRuleVersion7'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName7'))]"
      ],
      "properties": {
        "description": "ProofpointPODSuspiciousAttachment_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion7')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId7')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when email contains suspicious attachment (file type).",
                "displayName": "ProofpointPOD - Suspicious attachment",
                "enabled": false,
                "query": "let lbtime = 10m;\nlet disallowed_ext = dynamic(['ps1', 'exe', 'vbs', 'js', 'scr']);\nProofpointPOD\n| where TimeGenerated > ago(lbtime)\n| where EventType == 'message'\n| where NetworkDirection == 'inbound'\n| where FilterDisposition !in ('reject', 'discard')\n| extend attachedExt = todynamic(MsgParts)[0]['detectedExt']\n| where tolower(attachedExt) in (disallowed_ext)\n| project SrcUserUpn, AccountCustomEntity = parse_json(DstUserUpn)[0], attachedExt\n",
                "queryFrequency": "PT10M",
                "queryPeriod": "PT10M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "InitialAccess"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "FullName",
                        "columnName": "AccountCustomEntity"
                      }
                    ],
                    "entityType": "Account"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId7'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 7",
                "parentId": "[variables('analyticRuleId7')]",
                "contentId": "[variables('_analyticRulecontentId7')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('analyticRuleTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security Analytics Rule 8 with template",
        "displayName": "Proofpoint On demand(POD) Email Security Analytics Rule template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('analyticRuleTemplateSpecName8'),'/',variables('analyticRuleVersion8'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "AnalyticsRule"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('analyticRuleTemplateSpecName8'))]"
      ],
      "properties": {
        "description": "ProofpointPODWeakCiphers_AnalyticalRules Analytics Rule with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleVersion8')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('AnalyticRulecontentId8')]",
              "apiVersion": "2022-04-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Detects when weak TLS ciphers are used.",
                "displayName": "ProofpointPOD - Weak ciphers",
                "enabled": false,
                "query": "let lbtime = 1h;\nlet tls_ciphers = dynamic(['RC4-SHA', 'DES-CBC3-SHA']);\nProofpointPOD\n| where EventType == 'message'\n| where TlsCipher in (tls_ciphers)\n| extend IPCustomEntity = SrcIpAddr\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Low",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "ProofpointPOD_message_CL"
                    ],
                    "connectorId": "ProofpointPOD"
                  }
                ],
                "tactics": [
                  "CommandandControl"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "IPCustomEntity"
                      }
                    ],
                    "entityType": "IP"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleId8'),'/'))))]",
              "properties": {
                "description": "Proofpoint On demand(POD) Email Security Analytics Rule 8",
                "parentId": "[variables('analyticRuleId8')]",
                "contentId": "[variables('_analyticRulecontentId8')]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security data connector with template",
        "displayName": "Proofpoint On demand(POD) Email Security template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Proofpoint On demand(POD) Email Security data connector with template version 2.0.4",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "Proofpoint On Demand Email Security (using Azure Function)",
                  "publisher": "Proofpoint",
                  "descriptionMarkdown": "Proofpoint On Demand Email Security data connector provides the capability to get Proofpoint on Demand Email Protection data, allows users to check message traceability, monitoring into email activity, threats,and data exfiltration by attackers and malicious insiders. The connector provides ability to review events in your org on an accelerated basis, get event log files in hourly increments for recent activity.",
                  "additionalRequirementBanner": "These queries and workbooks are dependent on a parser based on Kusto to work as expected. ​Follow the steps to use this Kusto functions alias **ProofpointPOD** in queries and workbooks [Follow steps to get this Kusto functions>](https://aka.ms/sentinel-proofpointpod-parser)",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "ProofpointPOD_message_CL",
                      "baseQuery": "ProofpointPOD_message_CL"
                    },
                    {
                      "metricName": "Total data received",
                      "legend": "ProofpointPOD_maillog_CL",
                      "baseQuery": "ProofpointPOD_maillog_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Last ProofpointPOD message Events",
                      "query": "ProofpointPOD\n | where EventType == 'message'\n | sort by TimeGenerated desc"
                    },
                    {
                      "description": "Last ProofpointPOD maillog Events",
                      "query": "ProofpointPOD\n | where EventType == 'maillog'\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "ProofpointPOD_message_CL",
                      "lastDataReceivedQuery": "ProofpointPOD_message_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "ProofpointPOD_maillog_CL",
                      "lastDataReceivedQuery": "ProofpointPOD_maillog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "ProofpointPOD_message_CL\n      | union ProofpointPOD_maillog_CL \n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "Websocket API Credentials/permissions",
                        "description": "**ProofpointClusterID**, **ProofpointToken** is required. [See the documentation to learn more about API](https://proofpointcommunities.force.com/community/s/article/Proofpoint-on-Demand-Pod-Log-API)."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to the Proofpoint Websocket API to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": ">This data connector depends on a parser based on a Kusto Function to work as expected. [Follow these steps](https://aka.ms/sentinel-proofpointpod-parser) to create the Kusto functions alias, **ProofpointPOD**"
                    },
                    {
                      "description": "**STEP 1 - Configuration steps for the Proofpoint Websocket API**\n\n1. Proofpoint Websocket API service requires Remote Syslog Forwarding license. Please refer the [documentation](https://proofpointcommunities.force.com/community/s/article/Proofpoint-on-Demand-Pod-Log-API) on how to enable and check PoD Log API. \n2. You must provide your cluster id and security token."
                    },
                    {
                      "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Proofpoint On Demand Email Security data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the Proofpoint POD Log API credentials, readily available.",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "description": "Use this method for automated deployment of the Proofpoint On Demand Email Security data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-proofpointpod-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **ProofpointClusterID**, **ProofpointToken** and deploy. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
                      "title": "Option 1 - Azure Resource Manager (ARM) Template"
                    },
                    {
                      "description": "Use the following step-by-step instructions to deploy the Proofpoint On Demand Email Security data connector manually with Azure Functions (Deployment via Visual Studio Code).",
                      "title": "Option 2 - Manual Deployment of Azure Functions"
                    },
                    {
                      "description": "**1. Deploy a Function App**\n\n> NOTE:You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/functions-create-first-function-python#prerequisites) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-proofpointpod-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. ProofpointXXXXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
                    },
                    {
                      "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tProofpointClusterID\n\t\tProofpointToken\n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tlogAnalyticsUri (optional)\n - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Proofpoint On demand(POD) Email Security",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "tier": "Microsoft",
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "link": "https://support.microsoft.com/"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "Proofpoint On demand(POD) Email Security",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "tier": "Microsoft",
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "link": "https://support.microsoft.com/"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Proofpoint On Demand Email Security (using Azure Function)",
          "publisher": "Proofpoint",
          "descriptionMarkdown": "Proofpoint On Demand Email Security data connector provides the capability to get Proofpoint on Demand Email Protection data, allows users to check message traceability, monitoring into email activity, threats,and data exfiltration by attackers and malicious insiders. The connector provides ability to review events in your org on an accelerated basis, get event log files in hourly increments for recent activity.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "ProofpointPOD_message_CL",
              "baseQuery": "ProofpointPOD_message_CL"
            },
            {
              "metricName": "Total data received",
              "legend": "ProofpointPOD_maillog_CL",
              "baseQuery": "ProofpointPOD_maillog_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "ProofpointPOD_message_CL",
              "lastDataReceivedQuery": "ProofpointPOD_message_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "ProofpointPOD_maillog_CL",
              "lastDataReceivedQuery": "ProofpointPOD_maillog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "ProofpointPOD_message_CL\n      | union ProofpointPOD_maillog_CL \n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Last ProofpointPOD message Events",
              "query": "ProofpointPOD\n | where EventType == 'message'\n | sort by TimeGenerated desc"
            },
            {
              "description": "Last ProofpointPOD maillog Events",
              "query": "ProofpointPOD\n | where EventType == 'maillog'\n | sort by TimeGenerated desc"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "Websocket API Credentials/permissions",
                "description": "**ProofpointClusterID**, **ProofpointToken** is required. [See the documentation to learn more about API](https://proofpointcommunities.force.com/community/s/article/Proofpoint-on-Demand-Pod-Log-API)."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the Proofpoint Websocket API to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": ">This data connector depends on a parser based on a Kusto Function to work as expected. [Follow these steps](https://aka.ms/sentinel-proofpointpod-parser) to create the Kusto functions alias, **ProofpointPOD**"
            },
            {
              "description": "**STEP 1 - Configuration steps for the Proofpoint Websocket API**\n\n1. Proofpoint Websocket API service requires Remote Syslog Forwarding license. Please refer the [documentation](https://proofpointcommunities.force.com/community/s/article/Proofpoint-on-Demand-Pod-Log-API) on how to enable and check PoD Log API. \n2. You must provide your cluster id and security token."
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Proofpoint On Demand Email Security data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as the Proofpoint POD Log API credentials, readily available.",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "description": "Use this method for automated deployment of the Proofpoint On Demand Email Security data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-proofpointpod-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Workspace ID**, **Workspace Key**, **ProofpointClusterID**, **ProofpointToken** and deploy. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use the following step-by-step instructions to deploy the Proofpoint On Demand Email Security data connector manually with Azure Functions (Deployment via Visual Studio Code).",
              "title": "Option 2 - Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Deploy a Function App**\n\n> NOTE:You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/functions-create-first-function-python#prerequisites) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-proofpointpod-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. ProofpointXXXXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
            },
            {
              "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tProofpointClusterID\n\t\tProofpointToken\n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tlogAnalyticsUri (optional)\n - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
            }
          ],
          "id": "[variables('_uiConfigId1')]",
          "additionalRequirementBanner": "These queries and workbooks are dependent on a parser based on Kusto to work as expected. ​Follow the steps to use this Kusto functions alias **ProofpointPOD** in queries and workbooks [Follow steps to get this Kusto functions>](https://aka.ms/sentinel-proofpointpod-parser)"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.4",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Proofpoint On demand(POD) Email Security",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId1')]",
              "version": "[variables('parserVersion1')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId1')]",
              "version": "[variables('huntingQueryVersion1')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId2')]",
              "version": "[variables('huntingQueryVersion2')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId3')]",
              "version": "[variables('huntingQueryVersion3')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId4')]",
              "version": "[variables('huntingQueryVersion4')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId5')]",
              "version": "[variables('huntingQueryVersion5')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId6')]",
              "version": "[variables('huntingQueryVersion6')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId7')]",
              "version": "[variables('huntingQueryVersion7')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId8')]",
              "version": "[variables('huntingQueryVersion8')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId9')]",
              "version": "[variables('huntingQueryVersion9')]"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_huntingQuerycontentId10')]",
              "version": "[variables('huntingQueryVersion10')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId1')]",
              "version": "[variables('analyticRuleVersion1')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId2')]",
              "version": "[variables('analyticRuleVersion2')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId3')]",
              "version": "[variables('analyticRuleVersion3')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId4')]",
              "version": "[variables('analyticRuleVersion4')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId5')]",
              "version": "[variables('analyticRuleVersion5')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId6')]",
              "version": "[variables('analyticRuleVersion6')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId7')]",
              "version": "[variables('analyticRuleVersion7')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRulecontentId8')]",
              "version": "[variables('analyticRuleVersion8')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            }
          ]
        },
        "firstPublishDate": "2021-03-31",
        "providers": [
          "Proofpoint"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
