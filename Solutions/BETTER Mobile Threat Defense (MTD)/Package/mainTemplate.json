{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Better Mobile Security Inc",
    "comments": "Solution template for BETTER Mobile Threat Defense (MTD)"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "BETTER Mobile Threat Defense (MTD)",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "solutionId": "bettermobilesecurityinc.better_mtd_mss",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "uiConfigId1": "BetterMTD",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "BetterMTD",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1')))]",
    "dataConnectorVersion1": "1.0.0",
    "workbookVersion1": "1.1.0",
    "workbookContentId1": "BETTERMTDWorkbook",
    "workbookId1": "[resourceId('Microsoft.Insights/workbooks', variables('workbookContentId1'))]",
    "workbookTemplateSpecName1": "[concat(parameters('workspace'),'-wb-',uniquestring(variables('_workbookContentId1')))]",
    "_workbookContentId1": "[variables('workbookContentId1')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "BETTER Mobile Threat Defense (MTD) data connector with template",
        "displayName": "BETTER Mobile Threat Defense (MTD) template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "BETTER Mobile Threat Defense (MTD) data connector with template version 2.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "BETTER Mobile Threat Defense (MTD)",
                  "publisher": "BETTER Mobile",
                  "descriptionMarkdown": "The BETTER MTD Connector allows Enterprises to connect their Better MTD instances with Azure Sentinel, to view their data in Dashboards, create custom alerts, use it to trigger playbooks and expands threat hunting capabilities. This gives users more insight into their organization's mobile devices and ability to quickly analyze current mobile security posture which improves their overall SecOps capabilities.",
                  "graphQueries": [
                    {
                      "metricName": "Total incidents received",
                      "legend": "BetterMTDIncidentLog_CL",
                      "baseQuery": "BetterMTDIncidentLog_CL"
                    },
                    {
                      "metricName": "Total devcie enrolled",
                      "legend": "BetterMTDDeviceLog_CL",
                      "baseQuery": "BetterMTDDeviceLog_CL"
                    },
                    {
                      "metricName": "Total netflow traffic recieved",
                      "legend": "BetterMTDNetflowLog_CL",
                      "baseQuery": "BetterMTDNetflowLog_CL"
                    },
                    {
                      "metricName": "Total device applications",
                      "legend": "BetterMTDAppLog_CL",
                      "baseQuery": "BetterMTDAppLog_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "All threats in the past 24 hour",
                      "query": "BetterMTDIncidentLog_CL\n            | where TimeGenerated > ago(24h)\n            | sort by TimeGenerated\n            | limit 100"
                    },
                    {
                      "description": "Enrolled Devices in the past 24 hour",
                      "query": "BetterMTDDeviceLog_CL\n            | where TimeGenerated > ago(24h)\n            | sort by TimeGenerated\n            | limit 100"
                    },
                    {
                      "description": "Installed applications in the last 24 hour",
                      "query": "BetterMTDAppLog_CL\n            | where TimeGenerated > ago(24h)  and  AppStatus_s  == \"installed\" \n            | sort by TimeGenerated            \n| limit 100"
                    },
                    {
                      "description": "Blocked Network traffics in the last 24 hour",
                      "query": "BetterMTDNetflowLog_CL\n            | where TimeGenerated > ago(24h)  and  Status_s == \"blocked\"\n            | sort by TimeGenerated\n            | limit 100"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "BetterMTDIncidentLog_CL",
                      "lastDataReceivedQuery": "BetterMTDIncidentLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "BetterMTDDeviceLog_CL",
                      "lastDataReceivedQuery": "BetterMTDDeviceLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "BetterMTDAppLog_CL",
                      "lastDataReceivedQuery": "BetterMTDAppLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "BetterMTDNetflowLog_CL",
                      "lastDataReceivedQuery": "BetterMTDNetflowLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "BetterMTDIncidentLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "BetterMTDDeviceLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "BetterMTDAppLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                        "BetterMTDNetflowLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": "1. In **Better MTD Console**, click on **Integration** on the side bar.\n2. Select  **Others** tab.\n3. Click the **ADD ACCOUNT** button and Select **Azure Sentinel** from the available integrations.\n4. Create the Integration:\n  - set `ACCOUNT NAME` to a descriptive name that identifies the integration then click **Next**\n  - Enter your `WORKSPACE ID` and `PRIMARY KEY` from the fields below, click **Save**\n  - Click **Done**\n5.  Threat Policy setup (Which Incidents should be reported to `Azure Sentinel`):\n  - In **Better MTD Console**, click on **Policies** on the side bar\n  - Click on the **Edit** button of the Policy that you are using.\n  - For each Incident types that you want to be logged go to **Send to Integrations** field and select **Sentinel**\n6. For additional information, please refer to our [Documentation](https://mtd-docs.bmobi.net/integrations/how-to-setup-azure-sentinel-integration#mtd-integration-configuration).",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    }
                  ],
                  "metadata": {
                    "id": "31f0ea52-dcd4-443b-9d04-a3e709addebc",
                    "version": "1.0.0",
                    "kind": "dataConnector",
                    "source": {
                      "kind": "community"
                    },
                    "author": {
                      "name": "Better Mobile"
                    },
                    "support": {
                      "name": "Better Mobile",
                      "email": "support@better.mobi",
                      "tier": "developer"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "BETTER Mobile Threat Defense (MTD)",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Better Mobile Security Inc"
                },
                "support": {
                  "name": "Better Mobile Security Inc.",
                  "tier": "Partner",
                  "link": "https://www.better.mobi/about#contact-us"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "BETTER Mobile Threat Defense (MTD)",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Better Mobile Security Inc"
        },
        "support": {
          "name": "Better Mobile Security Inc.",
          "tier": "Partner",
          "link": "https://www.better.mobi/about#contact-us"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "BETTER Mobile Threat Defense (MTD)",
          "publisher": "BETTER Mobile",
          "descriptionMarkdown": "The BETTER MTD Connector allows Enterprises to connect their Better MTD instances with Azure Sentinel, to view their data in Dashboards, create custom alerts, use it to trigger playbooks and expands threat hunting capabilities. This gives users more insight into their organization's mobile devices and ability to quickly analyze current mobile security posture which improves their overall SecOps capabilities.",
          "graphQueries": [
            {
              "metricName": "Total incidents received",
              "legend": "BetterMTDIncidentLog_CL",
              "baseQuery": "BetterMTDIncidentLog_CL"
            },
            {
              "metricName": "Total devcie enrolled",
              "legend": "BetterMTDDeviceLog_CL",
              "baseQuery": "BetterMTDDeviceLog_CL"
            },
            {
              "metricName": "Total netflow traffic recieved",
              "legend": "BetterMTDNetflowLog_CL",
              "baseQuery": "BetterMTDNetflowLog_CL"
            },
            {
              "metricName": "Total device applications",
              "legend": "BetterMTDAppLog_CL",
              "baseQuery": "BetterMTDAppLog_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "BetterMTDIncidentLog_CL",
              "lastDataReceivedQuery": "BetterMTDIncidentLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "BetterMTDDeviceLog_CL",
              "lastDataReceivedQuery": "BetterMTDDeviceLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "BetterMTDAppLog_CL",
              "lastDataReceivedQuery": "BetterMTDAppLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "BetterMTDNetflowLog_CL",
              "lastDataReceivedQuery": "BetterMTDNetflowLog_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "BetterMTDIncidentLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "BetterMTDDeviceLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "BetterMTDAppLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)",
                "BetterMTDNetflowLog_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "All threats in the past 24 hour",
              "query": "BetterMTDIncidentLog_CL\n            | where TimeGenerated > ago(24h)\n            | sort by TimeGenerated\n            | limit 100"
            },
            {
              "description": "Enrolled Devices in the past 24 hour",
              "query": "BetterMTDDeviceLog_CL\n            | where TimeGenerated > ago(24h)\n            | sort by TimeGenerated\n            | limit 100"
            },
            {
              "description": "Installed applications in the last 24 hour",
              "query": "BetterMTDAppLog_CL\n            | where TimeGenerated > ago(24h)  and  AppStatus_s  == \"installed\" \n            | sort by TimeGenerated            \n| limit 100"
            },
            {
              "description": "Blocked Network traffics in the last 24 hour",
              "query": "BetterMTDNetflowLog_CL\n            | where TimeGenerated > ago(24h)  and  Status_s == \"blocked\"\n            | sort by TimeGenerated\n            | limit 100"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": "1. In **Better MTD Console**, click on **Integration** on the side bar.\n2. Select  **Others** tab.\n3. Click the **ADD ACCOUNT** button and Select **Azure Sentinel** from the available integrations.\n4. Create the Integration:\n  - set `ACCOUNT NAME` to a descriptive name that identifies the integration then click **Next**\n  - Enter your `WORKSPACE ID` and `PRIMARY KEY` from the fields below, click **Save**\n  - Click **Done**\n5.  Threat Policy setup (Which Incidents should be reported to `Azure Sentinel`):\n  - In **Better MTD Console**, click on **Policies** on the side bar\n  - Click on the **Edit** button of the Policy that you are using.\n  - For each Incident types that you want to be logged go to **Send to Integrations** field and select **Sentinel**\n6. For additional information, please refer to our [Documentation](https://mtd-docs.bmobi.net/integrations/how-to-setup-azure-sentinel-integration#mtd-integration-configuration).",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            }
          ],
          "id": "[variables('_uiConfigId1')]"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('workbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "properties": {
        "description": "BETTER Mobile Threat Defense (MTD) Workbook with template",
        "displayName": "BETTER Mobile Threat Defense (MTD) workbook template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('workbookTemplateSpecName1'),'/',variables('workbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Workbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('workbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "BETTER_MTD_WorkbookWorkbook Workbook with template version 2.0.1",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('workbookVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "name": "[variables('workbookContentId1')]",
              "location": "[parameters('workspace-location')]",
              "kind": "shared",
              "apiVersion": "2021-08-01",
              "metadata": {
                "description": "Workbook using the BETTER Mobile Threat Defense (MTD) connector, to give insights into your mobile devices, installed application and overall device security posture."
              },
              "properties": {
                "displayName": "[parameters('workbook1-name')]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Better Mobile Threat Defense (MTD)\"},\"name\":\"text - Banner\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"521734b3-6af4-48dc-b622-3f3dd3e1bdeb\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"time_token\",\"label\":\"Timerange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":7776000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Overview - Parameters\"},{\"type\":1,\"content\":{\"json\":\"### Devices\"},\"name\":\"text - devices Header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BetterMTDDeviceLog_CL\\r\\n| distinct DeviceId_d, DevicePlatform_s\\r\\n| summarize count() by DevicePlatform_s\\r\\n| render piechart\",\"size\":1,\"title\":\"Device Distribution by Platform\",\"noDataMessage\":\"No device has Enrolled in the given time range\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"query - Device Distribution by Platform\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5\",\"maxWidth\":\"25%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"datatable (Count:long, threat_status:string, pos:long) [0,\\\"Safe\\\",1, 0,\\\"Medium Risk\\\",2, 0,\\\"High Risk\\\",3]\\n|union\\n(\\nBetterMTDDeviceLog_CL\\n| distinct DeviceUDID_g, ThreatLevel_s\\n| extend threat_status = case(ThreatLevel_s == 'High' , \\\"High Risk\\\",\\n                        ThreatLevel_s == 'Medium' , \\\"Medium Risk\\\",\\n                        ThreatLevel_s == 'Low' ,\\\"Safe\\\",\\n                        \\\"Pass\\\"\\n                         )\\n| where threat_status != \\\"Pass\\\"\\n| extend pos = case(threat_status==\\\"High Risk\\\", 3, threat_status==\\\"Medium Risk\\\", 2, 1)\\n| summarize Count = count() by threat_status, pos\\n)\\n| summarize Count=sum(Count) by threat_status, pos\\n| sort by pos asc\",\"size\":4,\"showAnalytics\":true,\"title\":\"Devices Count By Threat Level\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"exportFieldName\":\"threat_status\",\"exportParameterName\":\"threat_status\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"threat_status\",\"formatter\":18,\"formatOptions\":{\"showIcon\":true,\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High Risk\",\"representation\":\"red\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium Risk\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Safe\",\"representation\":\"green\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3},\"emptyValCustomText\":\"0\"}},\"showBorder\":true,\"sortCriteriaField\":\"status_count\",\"sortOrderField\":1},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"status\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"status_count\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"status\",\"staticNodeSize\":100,\"colorSettings\":{\"nodeColorField\":\"status\",\"type\":1,\"colorPalette\":\"default\"},\"hivesMargin\":5}},\"customWidth\":\"50\",\"name\":\"Overview - Devices Count By Threat Level\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"50%\"}},{\"type\":1,\"content\":{\"json\":\"### Incidents\"},\"name\":\"text - Threat Header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BetterMTDIncidentLog_CL\\r\\n| distinct ThreatId_d, ThreatCategory_s\\r\\n| summarize count() by ThreatCategory_s\\r\\n| render piechart \\r\\n\",\"size\":1,\"title\":\"Incident Distribution by Threat Type\",\"noDataMessage\":\"No Threat has been detected in the given time range\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"query - Incident Distribution by Threat Type\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"25%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BetterMTDIncidentLog_CL\\r\\n | distinct ThreatId_d, DevicePlatform_s\\r\\n| summarize count() by DevicePlatform_s\\r\\n| render piechart \\r\\n\",\"size\":1,\"title\":\"Incident Distribution by Platform\",\"noDataMessage\":\"No Threat has been detected in the given time range\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"query - Incident Distribution by Platform\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"25%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"datatable (Count:long, severity:string, status_count:long) [0,\\\"Low\\\",1, 0,\\\"Medium\\\",2, 0,\\\"High\\\",3]\\n|union\\n(\\nBetterMTDIncidentLog_CL\\n| distinct ThreatId_d, ThreatSeverity_s, Status_s\\n| extend severity = case(ThreatSeverity_s == 'high' , \\\"High\\\",\\n                        ThreatSeverity_s == 'medium' , \\\"Medium\\\",\\n                        ThreatSeverity_s == 'low' ,\\\"Low\\\",\\n                        \\\"Pass\\\"\\n                         )\\n| where severity != \\\"Pass\\\" \\n| extend status_count = case(severity==\\\"High\\\", 3, severity==\\\"Medium\\\", 2, 1)\\n| summarize Count = count() by severity, status_count\\n)\\n| summarize Count=sum(Count) by severity, status_count\\n| sort by status_count asc\",\"size\":4,\"showAnalytics\":true,\"title\":\"Incidents Count By Severity\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"exportFieldName\":\"severity\",\"exportParameterName\":\"severity\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"severity\",\"formatter\":18,\"formatOptions\":{\"showIcon\":true,\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"yellow\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"green\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"representation\":\"blue\",\"text\":\"{0}{1}\"}]}},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3},\"emptyValCustomText\":\"0\"}},\"showBorder\":true,\"sortCriteriaField\":\"status_count\",\"sortOrderField\":1},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"status\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true}},\"centerContent\":{\"columnMatch\":\"status_count\",\"formatter\":1,\"formatOptions\":{\"showIcon\":true},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"status\",\"staticNodeSize\":100,\"colorSettings\":{\"nodeColorField\":\"status\",\"type\":1,\"colorPalette\":\"default\"},\"hivesMargin\":5}},\"customWidth\":\"50\",\"name\":\"Overview - Incidents Count By Severity\",\"styleSettings\":{\"progressStyle\":\"squares\",\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"50%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BetterMTDIncidentLog_CL\\r\\n| summarize count() by UserEmail_s \\r\\n| top 10 by count_\\r\\n\",\"size\":1,\"title\":\"Top 10 Users by Threat Count\",\"noDataMessage\":\"No Threat is Detected\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"showExpandCollapseGrid\":true,\"gridSettings\":{\"filter\":true,\"labelSettings\":[{\"columnId\":\"UserEmail_s\",\"label\":\"User Email\"},{\"columnId\":\"count_\",\"label\":\"Count\"}]}},\"customWidth\":\"50\",\"name\":\"query - Top 10 Users by Threat Count\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"40%\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BetterMTDIncidentLog_CL\\r\\n| distinct ThreatId_d, ThreatType_s\\r\\n| summarize count() by ThreatType_s\\r\\n| take 10 \\r\\n| render barchart   \\r\\n\",\"size\":3,\"title\":\"Top 10 Threat Types\",\"noDataMessage\":\"No threat has been detected in the given time range\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - Top 10 Threat Types\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"50%\"}},{\"type\":1,\"content\":{\"json\":\"### Applications\"},\"name\":\"text - App Header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BetterMTDAppLog_CL\\r\\n| where AppStatus_s == \\\"installed\\\"\\r\\n| summarize count() by AppName_s, AppStatus_s, BundleId_s\\r\\n| top 10 by count_ \",\"size\":1,\"title\":\"Top 10 Installed Apps by Count\",\"noDataMessage\":\"No App is installed in the given time period\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"count_\",\"formatter\":20,\"formatOptions\":{\"min\":0,\"palette\":\"blue\",\"aggregation\":\"Count\"}}],\"labelSettings\":[{\"columnId\":\"AppName_s\",\"label\":\"App Name\"},{\"columnId\":\"AppStatus_s\",\"label\":\"App Status\"},{\"columnId\":\"BundleId_s\",\"label\":\"Bundele Id\"},{\"columnId\":\"count_\",\"label\":\"Count\"}]}},\"customWidth\":\"50\",\"name\":\"query - Top 10 Installed Apps by Count\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"50%\"}},{\"type\":1,\"content\":{\"json\":\"### Netflow\"},\"name\":\"text - netflow Header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BetterMTDNetflowLog_CL\\r\\n| summarize AggregateValue = count() by Status_s\\r\\n| render piechart \",\"size\":1,\"title\":\"Netflow Count by Status\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"query - Netflow Count by Status\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"25%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BetterMTDNetflowLog_CL\\r\\n| where Status_s == \\\"blocked\\\"\\r\\n| where not(ipv4_is_match(\\\"10.0.0.0\\\",Destination_s,8) or ipv4_is_match(\\\"172.16.0.0\\\",Destination_s,12) or ipv4_is_match(\\\"192.168.0.0\\\",Destination_s,16))\\r\\n| where isnotempty(DestinationCountryCode_s)\\r\\n| summarize Total = count() by ['destination_country_code'] = DestinationCountryCode_s\\r\\n| top 25 by Total\",\"size\":0,\"title\":\"Netflow Destination on Map\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"CountryRegion\",\"locInfoColumn\":\"destination_country_code\",\"sizeSettings\":\"Total\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"Total\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"Total\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"}}},\"name\":\"query - Netflow Destination on Map\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"75%\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"BetterMTDNetflowLog_CL\\r\\n| project Status_s, DeviceName_s, Username_s, SourceClient_s, SourceCountry_s, Destination_s, DestinationCountry_s\\r\\n| take 100\\r\\n\",\"size\":1,\"title\":\"Netflow Monitor\",\"noDataMessage\":\"No Netflow Log Detected\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"filter\":true,\"sortBy\":[{\"itemKey\":\"SourceCountry_s\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"Status_s\",\"label\":\"Status\"},{\"columnId\":\"DeviceName_s\",\"label\":\"Device Name\"},{\"columnId\":\"Username_s\",\"label\":\"Username\"},{\"columnId\":\"SourceClient_s\",\"label\":\"Source Client\"},{\"columnId\":\"SourceCountry_s\",\"label\":\"Source Country\"},{\"columnId\":\"Destination_s\",\"label\":\"Destination\"},{\"columnId\":\"DestinationCountry_s\",\"label\":\"Destination Country\"}]},\"sortBy\":[{\"itemKey\":\"SourceCountry_s\",\"sortOrder\":1}],\"tileSettings\":{\"showBorder\":false}},\"customWidth\":\"100\",\"name\":\"query - Netflow Monitor\",\"styleSettings\":{\"margin\":\"5px\",\"padding\":\"5px\",\"maxWidth\":\"100%\",\"showBorder\":true}},{\"type\":1,\"content\":{\"json\":\"### Total Log Count\"},\"name\":\"text - log overview\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nunion withsource=LogTableName *\\n| where LogTableName == \\\"BetterMTDAppLog_CL\\\" or LogTableName == \\\"BetterMTDDeviceLog_CL\\\" or LogTableName == \\\"BetterMTDIncidentLog_CL\\\" or LogTableName == \\\"BetterMTDNetflowLog_CL\\\"\\n| summarize count() by LogTableName\\n| render piechart\",\"size\":1,\"title\":\"BETTER MTD Log Count by Type\",\"noDataMessage\":\"No Logs Recieved from BETTER MTD\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"time_token\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"LogTableName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"yellowOrangeRed\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":true,\"sortCriteriaField\":\"count_\",\"sortOrderField\":1}},\"customWidth\":\"50\",\"name\":\"query - BETTER MTD Log Count by Type\"}],\"fromTemplateId\":\"sentinel-BetterMTD\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
                "version": "1.0",
                "sourceId": "[variables('workspaceResourceId')]",
                "category": "sentinel"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Workbook-', last(split(variables('workbookId1'),'/'))))]",
              "properties": {
                "description": "@{workbookKey=BETTERMTDWorkbook; logoFileName=BETTER_MTD_logo.svg; description=Workbook using the BETTER Mobile Threat Defense (MTD) connector, to give insights into your mobile devices, installed application and overall device security posture.; dataTypesDependencies=System.Object[]; dataConnectorsDependencies=System.Object[]; previewImagesFileNames=System.Object[]; version=1.1.0; title=BETTER Mobile Threat Defense (MTD); templateRelativePath=BETTER_MTD_Workbook.json; subtitle=; provider=BETTER Mobile}.description",
                "parentId": "[variables('workbookId1')]",
                "contentId": "[variables('_workbookContentId1')]",
                "kind": "Workbook",
                "version": "[variables('workbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "BETTER Mobile Threat Defense (MTD)",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Better Mobile Security Inc"
                },
                "support": {
                  "name": "Better Mobile Security Inc.",
                  "tier": "Partner",
                  "link": "https://www.better.mobi/about#contact-us"
                },
                "dependencies": {
                  "operator": "AND",
                  "criteria": [
                    {
                      "contentId": "BetterMTDDeviceLog_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "BetterMTDAppLog_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "BetterMTDIncidentLog_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "BetterMTDNetflowLog_CL",
                      "kind": "DataType"
                    },
                    {
                      "contentId": "BetterMTD",
                      "kind": "DataConnector"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.1",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "BETTER Mobile Threat Defense (MTD)",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Better Mobile Security Inc"
        },
        "support": {
          "name": "Better Mobile Security Inc.",
          "tier": "Partner",
          "link": "https://www.better.mobi/about#contact-us"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId1')]",
              "version": "[variables('workbookVersion1')]"
            }
          ]
        },
        "firstPublishDate": "2022-05-02",
        "providers": [
          "Better Mobile Security Inc."
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
