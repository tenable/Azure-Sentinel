{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "e59f0f7f-fd05-4ec8-9f59-e4d9c3b589f2",
            "cellValue": "selected",
            "linkTarget": "parameter",
            "linkLabel": "Current RBAC Delegation",
            "subTarget": "RBACDelegation",
            "preText": "RBAC Delegation",
            "postText": "",
            "style": "link"
          },
          {
            "id": "26056188-7abf-4913-a927-806099e616eb",
            "cellValue": "selected",
            "linkTarget": "parameter",
            "linkLabel": "Custom Roles",
            "subTarget": "CustomRole",
            "style": "link"
          },
          {
            "id": "8def944a-53fe-4544-bc8f-5b3ca66eda34",
            "cellValue": "selected",
            "linkTarget": "parameter",
            "linkLabel": "Default Groups content",
            "subTarget": "DefaultGroup",
            "preText": "Default Group",
            "style": "link"
          },
          {
            "id": "2c47423c-479f-46a4-9732-ef87636c10c4",
            "cellValue": "selected",
            "linkTarget": "parameter",
            "linkLabel": "Least privileges analysis",
            "subTarget": "LeastprivilegesTemp",
            "preText": "Least privileges",
            "style": "link"
          },
          {
            "id": "5eeebe10-be67-4f8a-9d91-4bc6c70c3e16",
            "cellValue": "selected",
            "linkTarget": "parameter",
            "linkLabel": "Workbook Help",
            "subTarget": "start",
            "style": "link"
          }
        ]
      },
      "name": "links - 3"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "9ae328d6-99c8-4c44-8d59-42ca4d999098",
            "version": "KqlParameterItem/1.0",
            "name": "EnvironmentList",
            "label": "Environment",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "ESI_ExchConfigAvailableEnvironments(Target=\"Online\") | where ESIEnvironment != \"\"",
            "typeSettings": {
              "limitSelectTo": 1,
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "All",
              "showDefault": false
            },
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "a88b4e41-eb2f-41bf-92d8-27c83650a4b8",
            "version": "KqlParameterItem/1.0",
            "name": "DateOfConfiguration",
            "label": "Collection time",
            "type": 2,
            "isRequired": true,
            "query": "let _configurationEnv = split(iff(isnull({EnvironmentList}) or isempty({EnvironmentList}) or tolower({EnvironmentList}) == \"all\",\"All\",tostring({EnvironmentList})),',');\r\nESIExchangeOnlineConfig_CL\r\n| extend ScopedEnvironment = iff(_configurationEnv contains \"All\", \"All\",ESIEnvironment_s) \r\n| where ScopedEnvironment in (_configurationEnv)\r\n| extend Collection = format_datetime(todatetime(EntryDate_s), 'yyyy-MM-dd')\r\n| summarize Collection = max(Collection)\r\n| project Collection = \"lastdate\", Selected = true\r\n| join kind= fullouter  ( ESIExchangeOnlineConfig_CL | extend ScopedEnvironment = iff(_configurationEnv contains \"All\", \"All\",ESIEnvironment_s) \r\n| where ScopedEnvironment in (_configurationEnv)\r\n| where TimeGenerated > ago(90d)\r\n| extend Collection = format_datetime(todatetime(EntryDate_s), 'yyyy-MM-dd')\r\n| summarize by Collection\r\n) on Collection\r\n| project Value = iif(Selected,Collection,Collection1), Label = iif(Selected,\"Last Known date\",Collection1), Selected\r\n| sort by Selected, Value desc",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          {
            "id": "8ac96eb3-918b-4a36-bcc4-df50d8f46175",
            "version": "KqlParameterItem/1.0",
            "name": "Help",
            "label": "Show Help",
            "type": 10,
            "isRequired": true,
            "query": "{\"version\":\"1.0.0\",\"content\":\"[\\r\\n { \\\"value\\\": \\\"Yes\\\", \\\"label\\\": \\\"Yes\\\"},\\r\\n {\\\"value\\\": \\\"No\\\", \\\"label\\\": \\\"No\\\", \\\"selected\\\":true }\\r\\n]\\r\\n\",\"transformers\":null}",
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 2592000000
            },
            "queryType": 8
          }
        ],
        "style": "above",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "TimeRange"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Custom Delegation",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "The current delegation are compared to an export of default delegation available on Exchange Online",
              "style": "info"
            },
            "name": "text - 2"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Custom Delegation on User Accounts",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": " Custom Delegation on User Accounts"
                  },
                  "name": "text - 2 - Copy"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "d9d4e0a2-b75d-4825-9f4e-7606516500e1",
                        "version": "KqlParameterItem/1.0",
                        "name": "RoleAssignee",
                        "type": 2,
                        "query": "let DefMRA = externaldata (Name:string)[h\"https://raw.githubusercontent.com/nlepagnez/ESI-PublicContent/main/Operations/Watchlists/standardMRAOnline.csv\"]with(format=\"csv\",ignoreFirstRecord=true)| summarize make_list(Name);\r\nExchangeConfiguration(SpecificSectionList=\"MRA\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| where CmdletResultValue.Name !in (DefMRA) and CmdletResultValue.RoleAssigneeType == \"User\"\r\n| project CmdletResultValue\r\n| extend RoleAssigneeName = tostring(CmdletResultValue.RoleAssigneeName)\r\n| distinct RoleAssigneeName\r\n",
                        "value": null,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 5"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let DefMRA = externaldata (Name:string)[h\"https://raw.githubusercontent.com/nlepagnez/ESI-PublicContent/main/Operations/Watchlists/standardMRAOnline.csv\"]with(format=\"csv\",ignoreFirstRecord=true)| summarize make_list(Name);\r\nExchangeConfiguration(SpecificSectionList=\"MRA\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| search \"*{RoleAssignee}\"\r\n| where CmdletResultValue.Name !in (DefMRA) and CmdletResultValue.RoleAssigneeType == \"User\" and CmdletResultValue.Name !contains \"Deleg\"\r\n| project CmdletResultValue\r\n| extend Name = tostring(CmdletResultValue.Name)\r\n| extend Role = tostring(CmdletResultValue.Role)\r\n| extend RoleAssigneeName = tostring(CmdletResultValue.RoleAssigneeName)\r\n| project Name, Role, RoleAssigneeName\r\n| sort by RoleAssigneeName asc\r\n",
                    "size": 3,
                    "showAnalytics": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "CmdletName",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "31.5ch"
                          }
                        },
                        {
                          "columnMatch": "Total",
                          "formatter": 0,
                          "formatOptions": {
                            "customColumnWidthSetting": "9.3ch"
                          }
                        },
                        {
                          "columnMatch": "Count",
                          "formatter": 21,
                          "formatOptions": {
                            "palette": "blue",
                            "customColumnWidthSetting": "330px"
                          }
                        },
                        {
                          "columnMatch": "Anomalies",
                          "formatter": 10,
                          "formatOptions": {
                            "palette": "redBright",
                            "customColumnWidthSetting": "330px"
                          }
                        }
                      ],
                      "sortBy": [
                        {
                          "itemKey": "RoleAssigneeName",
                          "sortOrder": 1
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "RoleAssigneeName",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "name": "query - 2",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "name": "Custom Delegation on User Accounts"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Explanations",
              "expandable": true,
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "This section displays all the nonstandard delegations done directly to a user account.\r\n\r\nDetailed information for the user accounts will be displayed.\r\n\r\nThis status is done by comparing current delegation with the default delegation for Exchange 2019 CU11.\r\n\r\nThese types of delegations are not available on the Exchange Admin Center.\r\n\r\nUsual results :\r\n\r\n  - Delegations done directly to service account. Being able to see this delegation will help to sanityze the environment as some delegations may be no more necessary\r\n\r\n  - Delegation done by mistake directly to Administrator Accounts\r\n\r\n  - Suspicious delegations\r\n\r\n\r\nDetailed information for the user accounts will be displayed in below sections\r\n"
                  },
                  "name": "text - 0"
                }
              ]
            },
            "name": "group - 3"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Custom Delegation on Groups",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "Custom Delegation on Groups"
                  },
                  "name": "text - 2"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "c548eb09-54e3-41bf-a99d-be3534f7018b",
                        "version": "KqlParameterItem/1.0",
                        "name": "RoleAssignee",
                        "type": 2,
                        "query": "let DefMRA = externaldata (Name:string)[h\"https://raw.githubusercontent.com/nlepagnez/ESI-PublicContent/main/Operations/Watchlists/standardMRAOnline.csv\"]with(format=\"csv\",ignoreFirstRecord=true)| summarize make_list(Name);\r\nExchangeConfiguration(SpecificSectionList=\"MRA\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| where CmdletResultValue.Name !in (DefMRA) and CmdletResultValue.RoleAssigneeType == \"RoleGroup\"  and CmdletResultValue.RoleAssigneeName !contains \"RIM-MailboxAdmins\"\r\n| project CmdletResultValue\r\n| extend RoleAssigneeName = tostring(CmdletResultValue.RoleAssigneeName)\r\n| distinct RoleAssigneeName",
                        "value": null,
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 4"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let DefMRA = externaldata (Name:string)[h\"https://raw.githubusercontent.com/nlepagnez/ESI-PublicContent/main/Operations/Watchlists/standardMRAOnline.csv\"]with(format=\"csv\",ignoreFirstRecord=true)| summarize make_list(Name);\r\nlet RoleG = ExchangeConfiguration(SpecificSectionList=\"MRA\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n   | project RoleAssigneeName=tostring(CmdletResultValue.Name), LinkedGroup = tostring(CmdletResultValue.RoleAssigneeType);\r\nExchangeConfiguration(SpecificSectionList=\"MRA\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| search \"*{RoleAssignee}\"\r\n| where CmdletResultValue.Name !in (DefMRA) and CmdletResultValue.RoleAssigneeType == \"RoleGroup\"  and CmdletResultValue.RoleAssigneeName !contains \"RIM-MailboxAdmins\" and CmdletResultValue.Name !contains \"Deleg\"\r\n| project CmdletResultValue\r\n| extend ManagementRoleAssignment = tostring(CmdletResultValue.Name)\r\n| extend Role = tostring(CmdletResultValue.Role)\r\n| extend RoleAssigneeName = tostring(CmdletResultValue.RoleAssigneeName)\r\n|lookup RoleG on RoleAssigneeName \r\n| extend LinkedGroup = iff(tostring(LinkedGroup)==12, \"Yes\",\"No\")\r\n| project-away CmdletResultValue\r\n| sort by RoleAssigneeName asc",
                    "size": 3,
                    "showAnalytics": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "sortBy": [
                        {
                          "itemKey": "RoleAssigneeName",
                          "sortOrder": 1
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "RoleAssigneeName",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "name": "query - 1",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "name": "Custom Delegation on Groups"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Explanations",
              "expandable": true,
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "This section displays all the nonstandard delegations done for standard and non standard groups. Indeed, default groups have a list of default delegations but an Exchange administrators can add also new roles to the default groups.\r\n\r\nThis status is done by comparing current delegation with the default delegation for Exchange 2019 CU11.\r\n\r\nUsual results :\r\n\r\n  - Delegations done for Organization Management to role like Mailbox Import Export or Mailbox Search\r\n\r\n  - Delegation done by mistake\r\n\r\n  - Suspicious delegations\r\n\r\nDetailed information for the user accounts present in the groups will be displayed in below sections\r\n"
                  },
                  "name": "text - 0"
                }
              ]
            },
            "name": "group - 4"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selected",
        "comparison": "isEqualTo",
        "value": "RBACDelegation"
      },
      "name": "Custom Delegation",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Information for Role Assignee",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Information for Role Assignee User account",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "Detailed Information on User account Role Assignee"
                  },
                  "name": "text - 0"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "27e4c2e9-d113-4bf9-808f-0f8f68b5152e",
                        "version": "KqlParameterItem/1.0",
                        "name": "RoleAssignee",
                        "type": 2,
                        "isRequired": true,
                        "query": "let DefMRA = externaldata (Name:string)[h\"https://raw.githubusercontent.com/nlepagnez/ESI-PublicContent/main/Operations/Watchlists/standardMRAOnline.csv\"]with(format=\"csv\",ignoreFirstRecord=true)| summarize make_list(Name);\r\nExchangeConfiguration(SpecificSectionList=\"MRA\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| where CmdletResultValue.Name !in (DefMRA) and CmdletResultValue.RoleAssigneeType == \"User\"\r\n| project CmdletResultValue\r\n| extend RoleAssigneeName = tostring(CmdletResultValue.RoleAssigneeName)\r\n| distinct RoleAssigneeName",
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 1"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "ExchangeConfiguration(SpecificSectionList=\"DirectRoleAssignments\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| where CmdletResultValue.SamAccountName contains \"{RoleAssignee}\"\r\n| project CmdletResultValue\r\n| extend Account = tostring(CmdletResultValue.SamAccountName)\r\n| extend LastLogon = CmdletResultValue.LastLogonString\r\n| extend LastPwdSet = CmdletResultValue.LastPwdSetString\r\n| extend Enabled = tostring(CmdletResultValue.Enabled)\r\n| extend DN = tostring(CmdletResultValue.DN)\r\n| project-away  CmdletResultValue\r\n| sort by Account asc",
                    "size": 3,
                    "showAnalytics": true,
                    "color": "green",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "query - 2",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "name": "Information for Role Assignee User account"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Explanations",
              "expandable": true,
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "This section displays detailed information for user account found with non standard delegation :\r\n  - Last logon\r\n  - Last Password changed\r\n  - Account enabled"
                  },
                  "name": "text - 0"
                }
              ]
            },
            "name": "group - 2"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Information for Role Assignee group",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "Detailed information for Group delegation"
                  },
                  "name": "text - 0"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "75c3cdf3-d0c3-46c3-83ae-429979774234",
                        "version": "KqlParameterItem/1.0",
                        "name": "RoleAssignee",
                        "type": 2,
                        "isRequired": true,
                        "query": "let DefMRA = externaldata (Name:string)[h\"https://raw.githubusercontent.com/nlepagnez/ESI-PublicContent/main/Operations/Watchlists/standardMRAOnline.csv\"]with(format=\"csv\",ignoreFirstRecord=true)| summarize make_list(Name);\r\nExchangeConfiguration(SpecificSectionList=\"MRA\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| where CmdletResultValue.Name !in (DefMRA) and CmdletResultValue.RoleAssigneeType == \"RoleGroup\"  and CmdletResultValue.RoleAssigneeName !contains \"RIM-MailboxAdmins\"\r\n| project CmdletResultValue\r\n| extend RoleAssigneeName = tostring(CmdletResultValue.RoleAssigneeName)\r\n| distinct RoleAssigneeName",
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 1"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "ExchangeConfiguration(SpecificSectionList=\"ExGroup\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| where CmdletResultValue.Parentgroup contains \"{RoleAssignee}\"\r\n| where CmdletResultValue.Level != 0\r\n| project CmdletResultValue\r\n| extend Level_ = tostring(CmdletResultValue.Level)\r\n| extend Parentgroup = tostring(CmdletResultValue.Parentgroup)\r\n| extend MemberPath = tostring(CmdletResultValue.MemberPath)\r\n| extend LastLogon = CmdletResultValue.LastLogonString\r\n| extend LastPwdSet = CmdletResultValue.LastPwdSetString\r\n| extend Enabled = tostring(CmdletResultValue.Enabled)\r\n| extend DN = tostring(CmdletResultValue.DN)\r\n| project-away  CmdletResultValue\r\n| sort by Parentgroup asc",
                    "size": 3,
                    "showAnalytics": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "query - 2",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "name": "Information for Role Assignee group"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Explanations",
              "expandable": true,
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "This section displays detailed information for user account present in the found groups with non standard delegation :\r\n  - Last logon\r\n  - Last Password changed\r\n  - Account enabled"
                  },
                  "name": "text - 0"
                }
              ]
            },
            "name": "group - 3"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selected",
        "comparison": "isEqualTo",
        "value": "RBACDelegation"
      },
      "name": "Information for Role Assignee",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let StandardGroup = dynamic([\"Organization Management\",\"View-Only Organization Management\",\"Help Desk\",\"Records Management\",\"Discovery Management\",\"Hygiene Management\",\"Compliance Management\",\"Security Reader\",\"Security Administrator\",\"Security Operator\",\"TenantAdmins_-xxx\",\"RIM-MailboxAdminsaxxx\"]);\r\nExchangeConfiguration(SpecificSectionList=\"RoleGroupMember\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| where CmdletResultValue.RoleGroup in (StandardGroup)\r\n| project CmdletResultValue\r\n| extend RoleGroup = tostring(CmdletResultValue.RoleGroup)\r\n| summarize Total = count() by RoleGroup\r\n| extend Comment = case (Total>0 and RoleGroup contains \"Discovery Management\", \"❌ This group should be empty Just in time should be used\", Total>5 and RoleGroup contains \"Organization Management\", \"❌ The content of this group should limited to only Level 3 Administrators\", Total>0 and RoleGroup contains \"Hygiene Management\", \"❌ This group should be empty or only contains Exchange server and/or Exchange antivirus Spam accounts\", \"Remember to regularly review the content of the group\")\r\n| sort by RoleGroup asc",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Number of members for high privileges groups",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "query - 1",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "title": "Explanations",
                    "expandable": true,
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "All the default Exchange groups located in the default Exchange OU : Microsoft Exchange Security Groups are displayed with their number of members.\r\n\r\nIt is very important to monitor the content of Exchange groups and raise an alert when a new member is added.\r\n\r\nFor critical groups, a warning is display if the number exceeded a define thresold :\r\n  - Discovery Management: This group should be empty, so a warning is displayed when the group is not empty\r\n\r\n  - Organization Management : This group should only contain only Exchange expert. No service account should be member of this groupe. A warning is display when the total numer of member exceeded 5\r\n  - Hygiene Management : This group can acces and moidify the content of all mailboxes using EWS. A warning is display when the group is not empty. This warning can be ignored if the accounts are the Antispam service account or Exchange servers Computer accounts"
                        },
                        "name": "text - 0"
                      }
                    ]
                  },
                  "name": "group - 1"
                }
              ]
            },
            "name": "Summarize Number of Member Per Group"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let StandardGroup = dynamic([\"Organization Management\",\"View-Only Organization Management\",\"Help Desk\",\"Records Management\",\"Discovery Management\",\"Hygiene Management\",\"Compliance Management\",\"Security Reader\",\"Security Administrator\",\"Security Operator\",\"TenantAdmins_-xxx\",\"RIM-MailboxAdminsaxxx\"]);\r\nExchangeConfiguration(SpecificSectionList=\"RoleGroupMember\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| where CmdletResultValue.RoleGroup in (StandardGroup)\r\n| project CmdletResultValue\r\n| extend RoleGroup = tostring(CmdletResultValue.RoleGroup)\r\n| extend Members = tostring(CmdletResultValue.Identity)\r\n//| extend Level = tostring(CmdletResultValue.Level)\r\n//| extend LastLogon = CmdletResultValue.LastLogonString\r\n//| extend LastPwdSet = CmdletResultValue.LastPwdSetString\r\n//| extend Enabled = tostring(CmdletResultValue.Enabled)\r\n//| extend DN = tostring(CmdletResultValue.DN)\r\n| project-away  CmdletResultValue\r\n| sort by RoleGroup, Members asc",
              "size": 3,
              "showAnalytics": true,
              "title": "Default Exchange groups content",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "RoleGroup",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "RoleGroup",
                  "sortOrder": 1
                }
              ]
            },
            "name": "query - 1",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Explanations",
              "expandable": true,
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "This section the content of the groups with detailed information.\r\n\r\nIt is recommended to check the Last logon and last password change informations."
                  },
                  "name": "text - 0"
                }
              ]
            },
            "name": "group - 2"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selected",
        "comparison": "isEqualTo",
        "value": "DefaultGroup"
      },
      "name": "group - 4"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "### How to user this tab\r\n**1 - Select an account** : All the Cmdlet launched by the account during the selected time frame will be displayer.\r\n\r\n**2 - Select a cmdlet** : All the roles that contain will be displayed\r\n\r\n**3 - Review the list of roles** : This table contains all the roles that contain the selected Cmdlet\r\n\r\n",
              "style": "info"
            },
            "name": "text - 1"
          },
          {
            "type": 1,
            "content": {
              "json": "### How to undertand the \"List of Roles with this CmdLet\" table ? \r\n\r\n**WeightRole :** Display the wieight of this role based on its importance in terms of security risk\r\n\r\n**SumRole :** Among all the Cmdlet launched by the account during the defined time frame, this role available for x cmdlet. This role include x cmdlet run by the user.\r\n\r\n**OrgMgmtRole :** This role is really in the scope of Organization Management group. If the selected Cmdlet is not included is any other role, it make sense that this user is member of the Organization Management group\r\n\r\n ",
              "style": "upsell"
            },
            "name": "text - 2"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let CounUserCmdlet = (ExchangeAdminAuditLogs\r\n| where Status == \"Success\"\r\n| extend Caller = tostring(split(Caller,\"/\")[countof(Caller,\"/\")])\r\n| summarize Count=count() by Caller);\r\nExchangeConfiguration(SpecificSectionList=\"ExGroup\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| search CmdletResultValue.Parentgroup == \"Organization Management\"\r\n| where CmdletResultValue.Level != 0\r\n| where CmdletResultValue.ObjectClass == \"user\"\r\n//| project CmdletResultValue,Count\r\n| extend Account = tostring(CmdletResultValue.SamAccountName)\r\n| join kind=leftouter (CounUserCmdlet) on $left.Account == $right.Caller\r\n| project Account,Count\r\n//| project-away  CmdletResultValue\r\n| sort by Account asc",
                    "size": 3,
                    "title": "Organization Management Members",
                    "exportFieldName": "Account",
                    "exportParameterName": "Account",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Count",
                          "formatter": 3,
                          "formatOptions": {
                            "palette": "purple"
                          }
                        }
                      ]
                    }
                  },
                  "customWidth": "20",
                  "name": "query - 1",
                  "styleSettings": {
                    "maxWidth": "100%",
                    "showBorder": true
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "ExchangeAdminAuditLogs\r\n| where Caller contains \"{Account}\"\r\n| where Status == \"Success\"\r\n| distinct CmdletName\r\n| sort by CmdletName asc",
                    "size": 3,
                    "title": "List of CmdLet run by the account",
                    "exportFieldName": "CmdletName",
                    "exportParameterName": "CmdletName",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "sortBy": [
                        {
                          "itemKey": "CmdletName",
                          "sortOrder": 1
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "CmdletName",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "customWidth": "33",
                  "name": "query - 3",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let RBACRoleCmdlet = _GetWatchlist('RBACRoleCmdlet');\r\nlet UserRoleList = ExchangeAdminAuditLogs | where Caller contains \"{Account}\" | where Status == \"Success\" | distinct CmdletName;\r\nlet countRole = (RBACRoleCmdlet | where Name has_any (UserRoleList)| summarize SumRole = count()by Role);\r\nlet RolevsCmdlet = (RBACRoleCmdlet | where Name has_any (UserRoleList)| summarize make_set(Name) by Role);\r\nRolevsCmdlet\r\n| join kind=leftouter  ( countRole ) on Role\r\n| project Role,CmdletList=set_Name,SumRole\r\n| join kind=leftouter  ( RBACRoleCmdlet ) on Role\r\n| where Name has \"{CmdletName}\"\r\n| extend PossibleRoles = Role\r\n| extend OrgMgmtRole = OrgM\r\n| extend RoleWeight = Priority\r\n|distinct PossibleRoles,RoleWeight,tostring(SumRole),OrgMgmtRole,tostring(CmdletList)\r\n|sort by SumRole,RoleWeight\r\n",
                    "size": 3,
                    "title": "List of Roles with this CmdLet",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "sortBy": [
                        {
                          "itemKey": "PossibleRoles",
                          "sortOrder": 1
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "PossibleRoles",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "customWidth": "40",
                  "name": "query - 3",
                  "styleSettings": {
                    "margin": "0",
                    "maxWidth": "100%",
                    "showBorder": true
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "let RBACRoleCmdlet = _GetWatchlist('RBACRoleCmdlet');\r\nlet UserRoleList = ExchangeAdminAuditLogs | where TimeGenerated {TimeRange} | where Caller contains \"{Account}\" | where Status == \"Success\" | distinct CmdletName;\r\nlet countRole = (RBACRoleCmdlet | where Name has_any (UserRoleList)| summarize SumRole = count()by Role);\r\nlet RolevsCmdlet = (RBACRoleCmdlet | where Name has_any (UserRoleList)| summarize make_set(Name) by Role);\r\nRolevsCmdlet\r\n| join kind=leftouter  ( countRole ) on Role\r\n| project Role,CmdletList=set_Name,SumRole\r\n| join kind=leftouter  ( RBACRoleCmdlet ) on Role\r\n| extend Roles = Role\r\n| extend OrgMgmtRole = OrgM\r\n| extend RoleWeight = Priority\r\n| extend CmdletList=tostring(CmdletList)\r\n| summarize by Roles,CmdletList,RoleWeight,tostring(SumRole),OrgMgmtRole\r\n| distinct Roles,RoleWeight,tostring(SumRole),OrgMgmtRole,tostring(CmdletList)\r\n|sort by Roles asc",
                    "size": 0,
                    "title": "Recommended Roles for selected users",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "sortBy": [
                        {
                          "itemKey": "Roles",
                          "sortOrder": 1
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "Roles",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "name": "query - 3"
                }
              ]
            },
            "name": "group - 0"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selected",
        "comparison": "isEqualTo",
        "value": "Leastprivileges"
      },
      "name": "group - 5"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Let start with Least Privileges with RBAC",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Workbook goals\r\nThe goals of this workbook is to show you the current RBAC delegation\r\n\r\n\r\nThis workbook will display :\r\n\r\n  - NonStandrd RBAC delegation\r\n\r\n  - Exchange default group content\r\n\r\n  - Analysis of the actions performed by Organization Management members to remove them from the groups\r\n\r\n----\r\n\r\n## Tabs\r\n\r\n### Current RBAC Delegation\r\n\r\nThis tab will show all the nonstandard RBAC delegation.\r\n\r\n**Most of the time RBAC are done and forgotten... This tab will provide a clear statut of the delegation and help with the remediation.**\r\n\r\nBy nonstandard, it means that the current delegation are compared to the delegation from Exchange 2019 CU11.\r\n\r\nNonstandard delegation for standard groups like Organization Management will also be displayed.\r\n\r\nDetail information for  found will be displayed : Last logon, last password changed...\r\n\r\n### Default Group content\r\n\r\nThis tab will show the number of members for default Exchange groups and their content.\r\n\r\nMost of the time, the content of common Exchange groups but Exchange is shipped with many groups that have very high privileges and its interesting to see that they are not empty as expected.\r\n\r\n\r\n\r\n### Least privileges analysis\r\n\r\nThis tab will analysis for each account found in the Organization Management groups :\r\n\r\n  - All the Cmdlets launch by an account for the define time frame\r\n  \r\n  - For each cmdlet the list of role where the cmdlet is present\r\n\t- Each role will be displayed with a weight depending on the criticity of the role. Low number : critical role\r\n\t- Role that are clearly Organization Management role will be displayed with the number : 1\r\n\r\n  - Proposition of custom RBAC delegations dependant of the result of the analysis\r\n\r\n"
            },
            "name": "text - 0"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selected",
        "comparison": "isEqualTo",
        "value": "start"
      },
      "name": "group - 6"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Custom Role details",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "List of Custom Roles",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "This section shows the Custom management roles that exist in your environnment and the name of the parent's role"
                  },
                  "name": "text - 0"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "ExchangeConfiguration(SpecificSectionList=\"MRCustom\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| extend Identity = CmdletResultValue.Name\r\n| extend ParentRole = CmdletResultValue.Parent.Name\r\n| extend WhenCreated = WhenCreated\r\n| project Identity, ParentRole, WhenCreated, WhenChanged",
                    "size": 1,
                    "showAnalytics": true,
                    "timeContext": {
                      "durationMs": 86400000
                    },
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "query - 1"
                }
              ]
            },
            "name": "List of Custom Roles"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Details for Custom Roles Cmdlets ",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "This section displays for the chosen custom management roles all Cmdlets and their parameters associated with this custom role.\r\nRemember that for a cmdlet, some parameters can be removed."
                  },
                  "name": "text - 0"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "07c8ac83-371d-4702-ab66-72aeb2a20053",
                        "version": "KqlParameterItem/1.0",
                        "name": "CustomRole",
                        "type": 2,
                        "isRequired": true,
                        "query": "ExchangeConfiguration(SpecificSectionList=\"MRCustom\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| extend Identity = CmdletResultValue.Name\r\n| project Identity",
                        "typeSettings": {
                          "additionalResourceOptions": [],
                          "showDefault": false
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces",
                        "value": null
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "ExchangeConfiguration(SpecificSectionList=\"MRCustomDetails\",SpecificConfigurationDate=\"{DateOfConfiguration:value}\",SpecificConfigurationEnv={EnvironmentList},Target = \"Online\")\r\n| where (replace_string(replace_string(tostring(split(CmdletResultValue.Role.DistinguishedName,\",\",0)),\"[\\\"CN=\",\"\"),\"\\\"]\",\"\")) contains \"{CustomRole}\"\r\n| extend CustomRoleName = replace_string(replace_string(tostring(split(CmdletResultValue.Role.DistinguishedName,\",\",0)),\"[\\\"CN=\",\"\"),\"\\\"]\",\"\")\r\n| extend CmdletName = CmdletResultValue.Name\r\n| extend Parameters = CmdletResultValue.Parameters\r\n| project CmdletName,Parameters",
                    "size": 1,
                    "showAnalytics": true,
                    "timeContext": {
                      "durationMs": 86400000
                    },
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "query - 1"
                }
              ]
            },
            "name": "Details for Custom Roles Cmdlets "
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selected",
        "comparison": "isEqualTo",
        "value": "CustomRole"
      },
      "name": "Custom Role"
    }
  ],
  "fromTemplateId": "sentinel-MicrosoftExchangeLeastPrivilegewithRBAC-Online",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}