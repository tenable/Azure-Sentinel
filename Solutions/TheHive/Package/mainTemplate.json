{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for TheHive"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "solutionId": "azuresentinel.azure-sentinel-solution-thehive",
    "_solutionId": "[variables('solutionId')]",
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "uiConfigId1": "TheHiveProjectTheHive",
    "_uiConfigId1": "[variables('uiConfigId1')]",
    "dataConnectorContentId1": "TheHiveProjectTheHive",
    "_dataConnectorContentId1": "[variables('dataConnectorContentId1')]",
    "dataConnectorId1": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
    "_dataConnectorId1": "[variables('dataConnectorId1')]",
    "dataConnectorTemplateSpecName1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId1')))]",
    "dataConnectorVersion1": "1.0.0",
    "parserVersion1": "1.0.0",
    "parserContentId1": "TheHive-Parser",
    "_parserContentId1": "[variables('parserContentId1')]",
    "parserName1": "TheHive Data Parser",
    "_parserName1": "[concat(parameters('workspace'),'/',variables('parserName1'))]",
    "parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
    "_parserId1": "[variables('parserId1')]",
    "parserTemplateSpecName1": "[concat(parameters('workspace'),'-pr-',uniquestring(variables('_parserContentId1')))]",
    "TheHiveConnector": "TheHiveConnector",
    "_TheHiveConnector": "[variables('TheHiveConnector')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "TheHiveConnector",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'-lc-',uniquestring(variables('_playbookContentId1')))]",
    "TheHive-CreateAlert": "TheHive-CreateAlert",
    "_TheHive-CreateAlert": "[variables('TheHive-CreateAlert')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "TheHive-CreateAlert",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2')))]",
    "TheHive-CreateCase": "TheHive-CreateCase",
    "_TheHive-CreateCase": "[variables('TheHive-CreateCase')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "TheHive-CreateCase",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3')))]",
    "TheHive-LockUser": "TheHive-LockUser",
    "_TheHive-LockUser": "[variables('TheHive-LockUser')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "TheHive-LockUser",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('dataConnectorTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "properties": {
        "description": "TheHive data connector with template",
        "displayName": "TheHive template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('dataConnectorTemplateSpecName1'),'/',variables('dataConnectorVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "DataConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('dataConnectorTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "TheHive data connector with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId1')]",
                  "title": "TheHive Project - TheHive (using Azure Function)",
                  "publisher": "TheHive Project",
                  "descriptionMarkdown": "The [TheHive](http://thehive-project.org/) data connector provides the capability to ingest common TheHive events into Microsoft Sentinel through Webhooks. TheHive can notify external system of modification events (case creation, alert update, task assignment) in real time. When a change occurs in the TheHive, an HTTPS POST request with event information is sent to a callback data connector URL.  Refer to [Webhooks documentation](https://docs.thehive-project.org/thehive/legacy/thehive3/admin/webhooks/) for more information. The connector provides ability to get events which helps to examine potential security risks, analyze your team's use of collaboration, diagnose configuration problems and more.",
                  "additionalRequirementBanner": ">This data connector depends on a parser based on a Kusto Function to work as expected [**TheHive**](https://aka.ms/sentinel-TheHive-parser) which is deployed with the Microsoft Sentinel Solution.",
                  "graphQueries": [
                    {
                      "metricName": "Total data received",
                      "legend": "TheHive_CL",
                      "baseQuery": "TheHive_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "TheHive Events - All Activities.",
                      "query": "TheHive\n | sort by TimeGenerated desc"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "TheHive_CL",
                      "lastDataReceivedQuery": "TheHive_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "TheHive_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "Webhooks Credentials/permissions",
                        "description": "**TheHiveBearerToken**, **Callback URL** are required for working Webhooks. See the documentation to learn more about [configuring Webhooks](https://docs.thehive-project.org/thehive/installation-and-configuration/configuration/webhooks/)."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This data connector uses Azure Functions based on HTTP Trigger for waiting POST requests with logs to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
                    },
                    {
                      "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected [**TheHive**](https://aka.ms/sentinel-TheHive-parser) which is deployed with the Microsoft Sentinel Solution."
                    },
                    {
                      "description": "**STEP 1 - Configuration steps for the TheHive**\n\n Follow the [instructions](https://docs.thehive-project.org/thehive/installation-and-configuration/configuration/webhooks/) to configure Webhooks.\n\n1. Authentication method is *Beared Auth*.\n2. Generate the **TheHiveBearerToken** according to your password policy.\n3. Setup Webhook notifications in the *application.conf* file including **TheHiveBearerToken** parameter."
                    },
                    {
                      "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the TheHive data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following).",
                      "instructions": [
                        {
                          "parameters": {
                            "fillWith": [
                              "WorkspaceId"
                            ],
                            "label": "Workspace ID"
                          },
                          "type": "CopyableLabel"
                        },
                        {
                          "parameters": {
                            "fillWith": [
                              "PrimaryKey"
                            ],
                            "label": "Primary Key"
                          },
                          "type": "CopyableLabel"
                        }
                      ]
                    },
                    {
                      "description": "Use this method for automated deployment of the TheHive data connector using an ARM Template.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-TheHive-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n> **NOTE:** Within the same resource group, you can't mix Windows and Linux apps in the same region. Select existing resource group without Windows apps in it or create new resource group.\n3. Enter the **TheHiveBearerToken** and deploy. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.\n6. After deploying open Function App page, select your app, go to the **Functions** and click **Get Function Url** copy it and follow p.7 from STEP 1.",
                      "title": "Option 1 - Azure Resource Manager (ARM) Template"
                    },
                    {
                      "description": "Use the following step-by-step instructions to deploy the TheHive data connector manually with Azure Functions (Deployment via Visual Studio Code).",
                      "title": "Option 2 - Manual Deployment of Azure Functions"
                    },
                    {
                      "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/functions-create-first-function-python#prerequisites) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-TheHive-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. TheHiveXXXXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
                    },
                    {
                      "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select ** New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tTheHiveBearerToken\n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tlogAnalyticsUri (optional)\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n4. Once all application settings have been entered, click **Save**."
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
                "contentId": "[variables('_dataConnectorContentId1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "TheHive",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId1'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId1')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId1'))]",
        "contentId": "[variables('_dataConnectorContentId1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "TheHive",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId1'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "TheHive Project - TheHive (using Azure Function)",
          "publisher": "TheHive Project",
          "descriptionMarkdown": "The [TheHive](http://thehive-project.org/) data connector provides the capability to ingest common TheHive events into Microsoft Sentinel through Webhooks. TheHive can notify external system of modification events (case creation, alert update, task assignment) in real time. When a change occurs in the TheHive, an HTTPS POST request with event information is sent to a callback data connector URL.  Refer to [Webhooks documentation](https://docs.thehive-project.org/thehive/legacy/thehive3/admin/webhooks/) for more information. The connector provides ability to get events which helps to examine potential security risks, analyze your team's use of collaboration, diagnose configuration problems and more.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "TheHive_CL",
              "baseQuery": "TheHive_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "TheHive_CL",
              "lastDataReceivedQuery": "TheHive_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "TheHive_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "TheHive Events - All Activities.",
              "query": "TheHive\n | sort by TimeGenerated desc"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "Webhooks Credentials/permissions",
                "description": "**TheHiveBearerToken**, **Callback URL** are required for working Webhooks. See the documentation to learn more about [configuring Webhooks](https://docs.thehive-project.org/thehive/installation-and-configuration/configuration/webhooks/)."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This data connector uses Azure Functions based on HTTP Trigger for waiting POST requests with logs to pull its logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected [**TheHive**](https://aka.ms/sentinel-TheHive-parser) which is deployed with the Microsoft Sentinel Solution."
            },
            {
              "description": "**STEP 1 - Configuration steps for the TheHive**\n\n Follow the [instructions](https://docs.thehive-project.org/thehive/installation-and-configuration/configuration/webhooks/) to configure Webhooks.\n\n1. Authentication method is *Beared Auth*.\n2. Generate the **TheHiveBearerToken** according to your password policy.\n3. Setup Webhook notifications in the *application.conf* file including **TheHiveBearerToken** parameter."
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the TheHive data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following).",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "description": "Use this method for automated deployment of the TheHive data connector using an ARM Template.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-TheHive-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n> **NOTE:** Within the same resource group, you can't mix Windows and Linux apps in the same region. Select existing resource group without Windows apps in it or create new resource group.\n3. Enter the **TheHiveBearerToken** and deploy. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.\n6. After deploying open Function App page, select your app, go to the **Functions** and click **Get Function Url** copy it and follow p.7 from STEP 1.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use the following step-by-step instructions to deploy the TheHive data connector manually with Azure Functions (Deployment via Visual Studio Code).",
              "title": "Option 2 - Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/functions-create-first-function-python#prerequisites) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-TheHive-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. TheHiveXXXXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Microsoft Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
            },
            {
              "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select ** New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tTheHiveBearerToken\n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tlogAnalyticsUri (optional)\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n4. Once all application settings have been entered, click **Save**."
            }
          ],
          "id": "[variables('_uiConfigId1')]",
          "additionalRequirementBanner": ">This data connector depends on a parser based on a Kusto Function to work as expected [**TheHive**](https://aka.ms/sentinel-TheHive-parser) which is deployed with the Microsoft Sentinel Solution."
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('parserTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "properties": {
        "description": "TheHive Data Parser with template",
        "displayName": "TheHive Data Parser template"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('parserTemplateSpecName1'),'/',variables('parserVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Parser"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('parserTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "TheHive Data Parser with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserVersion1')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('_parserName1')]",
              "apiVersion": "2020-08-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "TheHive Data Parser",
                "category": "Samples",
                "functionAlias": "TheHive",
                "query": "\nlet TheHive_view  = view () { \r\n    TheHive_CL\r\n    | extend \r\n                EventVendor=\"TheHive Project\",\r\n                EventProduct=\"TheHive\",\r\n                ObjectUpdatedBy=column_ifexists('object_updatedBy_s', ''),\r\n                ObjectUpdatedAt=unixtime_milliseconds_todatetime(column_ifexists('object_updatedAt_d', '')),\r\n                Operation=column_ifexists('operation_s', ''),\r\n                ObjectType=column_ifexists('objectType_s', column_ifexists('object__type_s', '')),\r\n                ObjectId=column_ifexists('objectId_s', column_ifexists('object_id_s', '')),\r\n                StartDate=unixtime_milliseconds_todatetime(column_ifexists('startDate_d', '')),\r\n                RequestId=column_ifexists('requestId_s', ''),\r\n                DetailsDescription=column_ifexists('details_description_s', ''),\r\n                DetailsFlag=column_ifexists('details_flag_b', ''),\r\n                DetailsTitle=column_ifexists('details_title_s', ''),\r\n                DetailsStatus=column_ifexists('details_status_s', ''),\r\n                DetailsOwner=column_ifexists('details_owner_s', ''),\r\n                DetailsCaseId=column_ifexists('details_caseId_d', ''),\r\n                DetailsSeverity=column_ifexists('details_severity_d', ''),\r\n                DetailsTlp=column_ifexists('details_tlp_d', ''),\r\n                DetailsStartDate=unixtime_milliseconds_todatetime(column_ifexists('details_startDate_d', '')),\r\n                DetailsTags=column_ifexists('details_tags_s', ''),\r\n                Base=column_ifexists('base_b', ''),\r\n                RootId=column_ifexists('rootId_s', ''),\r\n                ObjectCreatedBy=column_ifexists('object_createdBy_s', ''),\r\n                ObjectDescription=column_ifexists('object_description_s', ''),\r\n                ObjectFlag=column_ifexists('object_flag_b', ''),\r\n                ObjectUser=column_ifexists('object_user_s', ''),\r\n                ObjectTitle=column_ifexists('object_title_s', ''),\r\n                ObjectStatus=column_ifexists('object_status_s', ''),\r\n                ObjectOwner=column_ifexists('object_owner_s', ''),\r\n                ObjectCreatedAt=unixtime_milliseconds_todatetime(column_ifexists('object_createdAt_d', '')),\r\n                ObjectCaseId=column_ifexists('object_caseId_d', ''),\r\n                ObjectSeverity=column_ifexists('object_severity_d', ''),\r\n                ObjectTlp=column_ifexists('object_tlp_d', ''),\r\n                ObjectStartDate=unixtime_milliseconds_todatetime(column_ifexists('object_startDate_d', '')),\r\n                ObjectTags=column_ifexists('object_tags_s', '')\r\n    | project\r\n                TimeGenerated, \r\n                EventVendor,\r\n                EventProduct,\r\n                ObjectUpdatedBy,\r\n                ObjectUpdatedAt,\r\n                Operation,\r\n                ObjectType,\r\n                ObjectId,\r\n                StartDate,\r\n                RequestId,\r\n                DetailsDescription,\r\n                DetailsFlag,\r\n                DetailsTitle,\r\n                DetailsStatus,\r\n                DetailsOwner,\r\n                DetailsCaseId,\r\n                DetailsSeverity,\r\n                DetailsTlp,\r\n                DetailsStartDate,\r\n                DetailsTags,\r\n                Base,\r\n                RootId,\r\n                ObjectCreatedBy,\r\n                ObjectDescription,\r\n                ObjectFlag,\r\n                ObjectUser,\r\n                ObjectTitle,\r\n                ObjectStatus,\r\n                ObjectOwner,\r\n                ObjectCreatedAt,\r\n                ObjectCaseId,\r\n                ObjectSeverity,\r\n                ObjectTlp,\r\n                ObjectStartDate,\r\n                ObjectTags    \r\n};\r\nTheHive_view",
                "version": 1,
                "tags": [
                  {
                    "name": "description",
                    "value": "TheHive Data Parser"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
              "dependsOn": [
                "[variables('_parserName1')]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
                "contentId": "[variables('_parserContentId1')]",
                "kind": "Parser",
                "version": "[variables('parserVersion1')]",
                "source": {
                  "name": "TheHive",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2021-06-01",
      "name": "[variables('_parserName1')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "TheHive Data Parser",
        "category": "Samples",
        "functionAlias": "TheHive",
        "query": "\nlet TheHive_view  = view () { \r\n    TheHive_CL\r\n    | extend \r\n                EventVendor=\"TheHive Project\",\r\n                EventProduct=\"TheHive\",\r\n                ObjectUpdatedBy=column_ifexists('object_updatedBy_s', ''),\r\n                ObjectUpdatedAt=unixtime_milliseconds_todatetime(column_ifexists('object_updatedAt_d', '')),\r\n                Operation=column_ifexists('operation_s', ''),\r\n                ObjectType=column_ifexists('objectType_s', column_ifexists('object__type_s', '')),\r\n                ObjectId=column_ifexists('objectId_s', column_ifexists('object_id_s', '')),\r\n                StartDate=unixtime_milliseconds_todatetime(column_ifexists('startDate_d', '')),\r\n                RequestId=column_ifexists('requestId_s', ''),\r\n                DetailsDescription=column_ifexists('details_description_s', ''),\r\n                DetailsFlag=column_ifexists('details_flag_b', ''),\r\n                DetailsTitle=column_ifexists('details_title_s', ''),\r\n                DetailsStatus=column_ifexists('details_status_s', ''),\r\n                DetailsOwner=column_ifexists('details_owner_s', ''),\r\n                DetailsCaseId=column_ifexists('details_caseId_d', ''),\r\n                DetailsSeverity=column_ifexists('details_severity_d', ''),\r\n                DetailsTlp=column_ifexists('details_tlp_d', ''),\r\n                DetailsStartDate=unixtime_milliseconds_todatetime(column_ifexists('details_startDate_d', '')),\r\n                DetailsTags=column_ifexists('details_tags_s', ''),\r\n                Base=column_ifexists('base_b', ''),\r\n                RootId=column_ifexists('rootId_s', ''),\r\n                ObjectCreatedBy=column_ifexists('object_createdBy_s', ''),\r\n                ObjectDescription=column_ifexists('object_description_s', ''),\r\n                ObjectFlag=column_ifexists('object_flag_b', ''),\r\n                ObjectUser=column_ifexists('object_user_s', ''),\r\n                ObjectTitle=column_ifexists('object_title_s', ''),\r\n                ObjectStatus=column_ifexists('object_status_s', ''),\r\n                ObjectOwner=column_ifexists('object_owner_s', ''),\r\n                ObjectCreatedAt=unixtime_milliseconds_todatetime(column_ifexists('object_createdAt_d', '')),\r\n                ObjectCaseId=column_ifexists('object_caseId_d', ''),\r\n                ObjectSeverity=column_ifexists('object_severity_d', ''),\r\n                ObjectTlp=column_ifexists('object_tlp_d', ''),\r\n                ObjectStartDate=unixtime_milliseconds_todatetime(column_ifexists('object_startDate_d', '')),\r\n                ObjectTags=column_ifexists('object_tags_s', '')\r\n    | project\r\n                TimeGenerated, \r\n                EventVendor,\r\n                EventProduct,\r\n                ObjectUpdatedBy,\r\n                ObjectUpdatedAt,\r\n                Operation,\r\n                ObjectType,\r\n                ObjectId,\r\n                StartDate,\r\n                RequestId,\r\n                DetailsDescription,\r\n                DetailsFlag,\r\n                DetailsTitle,\r\n                DetailsStatus,\r\n                DetailsOwner,\r\n                DetailsCaseId,\r\n                DetailsSeverity,\r\n                DetailsTlp,\r\n                DetailsStartDate,\r\n                DetailsTags,\r\n                Base,\r\n                RootId,\r\n                ObjectCreatedBy,\r\n                ObjectDescription,\r\n                ObjectFlag,\r\n                ObjectUser,\r\n                ObjectTitle,\r\n                ObjectStatus,\r\n                ObjectOwner,\r\n                ObjectCreatedAt,\r\n                ObjectCaseId,\r\n                ObjectSeverity,\r\n                ObjectTlp,\r\n                ObjectStartDate,\r\n                ObjectTags    \r\n};\r\nTheHive_view",
        "version": 1
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('_parserId1'),'/'))))]",
      "dependsOn": [
        "[variables('_parserId1')]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), variables('parserName1'))]",
        "contentId": "[variables('_parserContentId1')]",
        "kind": "Parser",
        "version": "[variables('parserVersion1')]",
        "source": {
          "kind": "Solution",
          "name": "TheHive",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "LogicAppsCustomConnector"
      },
      "properties": {
        "description": "TheHiveConnector",
        "displayName": "TheHiveConnector"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName1'),'/',variables('playbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "LogicAppsCustomConnector"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "TheHiveConnector Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "ConnectorName": {
              "defaultValue": "TheHive",
              "type": "string"
            },
            "API Hostname": {
              "type": "String",
              "defaultValue": "testhost.com",
              "metadata": {
                "description": "Hostname of the TheHive instance."
              }
            },
            "API Port": {
              "type": "String",
              "defaultValue": "9000",
              "metadata": {
                "description": "Port number of TheHive API. By default 9060."
              }
            },
            "Http Scheme": {
              "type": "String",
              "allowedValues": [
                "http",
                "https"
              ],
              "metadata": {
                "description": "Http scheme for request execution."
              }
            }
          },
          "variables": {
            "serviceUrl": "[[uri(concat(parameters('Http Scheme'), '://', parameters('API Hostname'), ':'), parameters('API Port'))]",
            "operationId-create_alert": "create_alert",
            "_operationId-create_alert": "[[variables('operationId-create_alert')]",
            "operationId-create_case": "create_case",
            "_operationId-create_case": "[[variables('operationId-create_case')]",
            "operationId-create_task": "create_task",
            "_operationId-create_task": "[[variables('operationId-create_task')]",
            "operationId-list_observables": "list_observables",
            "_operationId-list_observables": "[[variables('operationId-list_observables')]",
            "operationId-lock_user": "lock_user",
            "_operationId-lock_user": "[[variables('operationId-lock_user')]",
            "operationId-create_observable_case": "create_observable_case",
            "_operationId-create_observable_case": "[[variables('operationId-create_observable_case')]",
            "operationId-create_observable_alert": "create_observable_alert",
            "_operationId-create_observable_alert": "[[variables('operationId-create_observable_alert')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId": "TheHiveConnector",
            "playbookId": "[[resourceId('Microsoft.Web/customApis', parameters('ConnectorName'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/customApis",
              "apiVersion": "2016-06-01",
              "name": "[[parameters('ConnectorName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "connectionParameters": {
                  "username": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "username",
                      "description": "The username for this api",
                      "tooltip": "Provide the username",
                      "constraints": {
                        "tabIndex": 2,
                        "clearText": true,
                        "required": "true"
                      }
                    }
                  },
                  "password": {
                    "type": "securestring",
                    "uiDefinition": {
                      "displayName": "password",
                      "description": "The password for this api",
                      "tooltip": "Provide the password",
                      "constraints": {
                        "tabIndex": 3,
                        "clearText": false,
                        "required": "true"
                      }
                    }
                  },
                  "authType": {
                    "type": "string",
                    "allowedValues": [
                      {
                        "value": "basic"
                      }
                    ],
                    "uiDefinition": {
                      "displayName": "Authentication Type",
                      "description": "Authentication type to connect to your API",
                      "tooltip": "Authentication type to connect to your API",
                      "constraints": {
                        "tabIndex": 1,
                        "required": "true",
                        "allowedValues": [
                          {
                            "text": "basic",
                            "value": "basic"
                          }
                        ]
                      }
                    }
                  },
                  "gateway": {
                    "type": "gatewaySetting",
                    "gatewaySettings": {
                      "dataSourceType": "CustomConnector"
                    },
                    "uiDefinition": {
                      "constraints": {
                        "tabIndex": 4,
                        "required": "true",
                        "capability": [
                          "gateway"
                        ]
                      }
                    }
                  }
                },
                "capabilities": [
                  "gateway"
                ],
                "brandColor": "#FFFFFF",
                "description": "Connector for TheHive API",
                "displayName": "[[parameters('ConnectorName')]",
                "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGUAAABzCAYAAACB88xJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAwmSURBVHhe7Z35kyRFHcX9j9Q1QEEkBBVQFDVQwQvxxAvvQFBRPBARL1AxvPAKdEFXMSRUUDG8XRXcnvvo6emd6Tl6uiuzqkZ+bvPVRC+dVa+qK4/qqVn6h09sxM6rzKx6XXl+M+sp/fDxwZR6MTWlhkxNqSFTU2rI1JQaMjWlhkxNqSFTU2rI1JQaMjWlhkxNqSFTU2rI1JQaMjWlhhyaKXLzxwPZvrN2iM59g6C3TMs8KQ7FlGj1/YP9U0+tLdHKe2i5J8XETRGbJ+iDqBty62e0/JNgoqYEUgzihVfSh1A34oUrVXn79D6qZqKmyPbdmZtn9fphETfOTZXtq/Q+qmZipgS9pcH+7IXaTUerH6Taw0JufF8r3/7Mearcs1RbJRMzJVy7Rb9hRb+/RrWHCaqt0TKGqzdRXZVMxBSx+2ftRpObbX+Fag+bYPv3mbKK7YeptiomYkq08g7tJuPZ51NdXYhW3quVN1q6luqqonJTROen2g0C2fk51dYF0V/OlnnjB1RbBZWagi5luo6e9K/OlnD9Dq3c8dxlgyDYoFrfVGqKbH9NuzEQdP9FtXUjkDLTWwxbn6Na31RmStBbUDd1gX5TzZuptq6IzZ9o5Qeie5JqfVKZKeHazdrNxI3zBn2xS7UMsf2bpKpDm8T+bkqS3sr1A7l5D/17HtHia7T7iFbfR3U+qcSUYOeP2o2AcOPbVMvAAxy9Vuz+lepK02+qgeCznyjL2me5jhDsZLvzovMA1fqiElPi5eu0m4jmr6S6POTGPfr1jp2DsHmjlp6JKSBs3qBdHy9elbQ5TOsD76aIznHtBoDc+S3V5iH2TmXSsH5bRFd7S5K0OmZVIu0it++mWh94NSWQvUE8/zKt8BiIMe048HZo6Vi+LWH7Li2deO5SqhuHXE+lM/Mc1ZlZpFpXvJqSfgAg2Jun2nHgzUinhbaBaXMhbwmqRqodA6qrePYFWlrozDCtK95MCXpzSQ9LK/T67VRblvTbgraB6fLIzCbMnJ8YxbRlYLMTYucRqnXBmylR86NaYTEC7st9qi2L69uCqmr0WrzJTGdCtPRGLc1o+S1U54IXU9jMKgIjmNYU2wdLDXV4S4awLnK4eS/V2uLFFPxaRgsZLb2Z6mxIVxm2pphWfUWEax/X0o7nXzwIgi2qtcHZFLwRowUEous42EsxHGckPTCDXzvGI8l1C2qc5OEtGXLQRX7amfsFcv0OqrXBzRSxO4gXrtAKh18R1XoGsVli61fqzfmy6na/cxC2Pq3eqhPq/2eo3jey/XXtvv/XeMYg6P6Hak1xMgUPZLRg8cwF6jVuU61Phm9AHvHS65J2jl3ri6SLPP8SLV9fMQfWpuAXGTeeqRUqPP0tqvVGvzWI5l6k5VlE2PoMT8cTtIus3l6mNcHalKh5k1aYaOEqqvOG2NHyK0vVayDxytu1/DCr3A/dhgJWpiCQYLQgQGw/SLW+iBauzuRZlmD3nzRNH9AussGMOMPKlGjpTVohqo7fCk9/U8vPFLQxfdGjafsg00WevUj10FaotgzGpsjNH2kF2D/19EGw91+q9UU8//JUnub4Gswy0EWOG8/S8gtbn6LaMpiZIrZVQ3u5nnn7S1zrCTZtbkPUvIGm74t0FxkEO3+i2nEYmRKuf1HLNFIj2b6srloAGHuM5mmN5ZR9WQ66yPobHalOANOOo7QpQfcx9Yqeo2UqO/dRrU/SS8O2oJ5n6fuEdpE7x6m2iNKmhGuf1DKLlq+jOu+Irnqgl2h524CNSjR9z2S6yCvvoroiSpuSiUhXDRvCiJjWN4hO1PK2gKXrmwABGplYMfMBbPk2JVCNfGpaIWx+mGsrQG7dn+lklCFcfjdNrwrCtVu1vDHjYTMXZ9TQiw4JTlN1PtNWRbDziOrp3Kmqz7dlVjpBPH+5eji3qLLen/TcWBpVIPYeVfnrM8fh+heodhxGpoBMBP3iq6nuyUakag3tucxdoqozu9hjY1OwVjKaOZBqxM20TxZ48OF3qLYMxqaAqKVPnaMaqSrc5iiQrj2ihVep8VtEtWWwMqUftNVg7DK9IM2PcO1Zjtx6QHsOQHbctnvbmaKQGz/MFsYwEvJsIF58rfYMouW3Up0J1qYABEhoBVIFZLqzlezkLHqjv6NaE5xMEaSBk1WtPgqp8vuD6mZ+fhAE61wzAqY30Nj6WjfPIHrZ+ITmh7jWECdTQHr6Zd9zjK3Y/vUgXL1xEM8+N0k/WRshOsawTNH8FckKpOj+nepsoLPCnnapOZsS9FdVn/xirXCIlmTasmAghhnpWD3M0XSByRp42PxY5vpo8RrVHqo3yHIMATCdMvyRDAlbt1KtDc6mALnxXa2AwKbRl6o+xipmOq0hyW4wcl0eYu8xmk7C3KUH4yuLpYdw7TY9rdkLlVH+Zg+8mALSwdjx0uupjiE2j2euZ4St2+j1suDwgfTWjDTxwkuTniS7lnFg9DEtDWy4ZVpbvJkidh7SCgqCMevUCKiLVj+QuS6PvAa+aHqcRXAyosVr1T2MXylMh8Oiiu2LPaq1xZspIByNvJ99XuEMqdz6hdE6SV50O4zF33MDFcR2Jq0isH++6EipJN5t9qIzenSLmc4Fr6YAzIyiR5ZbpagbRojp6IMoQ14DL1u3J38vihVgDX4RiGErahMxM46Zaqw0sr+74t2UIkT332oEfA19EEVgHYWlB84sKql/2d8BxjfpNMvgM2jbhImZggMz49RWt7LInBOPsGai6TonqA6Ma/DzsN1r6cJETMHAjd1wKRrH8hv4xTdo2qIHyAZ7ZUHAyKSi+UHlprierJq35BzsnqT6QFWRVN+bp3oTkAZL2zeVmuLjqNu8LQ3omubB9ADr9SwPEyZhTGWm+DAE1RNL2xYca8vyMaJxbuXGVGKKr8OgTUbapVDd8fTinA3oNFRpjHdTnBr1EWI1+MSeFJaHC9JX+RAwEmzTPFzxagq6vewGbMib53IFe1VYfjaEq37WT9J4MyUZGFqOQxhIj+Xjg/T+Gheq2HXgxxScFWkxUs8jXC6YYGzflUxxPPFvPux6wOILXLAJ4i7Ciyn4tbDC2oIIEZYPVjSZPo+8jwhggcvnWx3PXqwGuC2alw3OpuDY8fQuJhcwFd6TMc0rff7LOJL4K5IOiAwnKcdhG6LKcDYlSp0V6UrRof8YI7BrihDdf9C0JDlPxoUkIHHPzy4EJ1OwfYwV0Bqc2pATdIF2AHNbxhScyRJ5/myIr337TqZEK+7TFqMgSJrlUxXh6eynQ5xoHEuWi1leJjiZMroC5wMfgWwmJGcnk3K4ULR8UBZrU3zfULR4Nc2natInqbpS1BUvi70pW7+khbJFnnY7pcEWHDfIymMLjkdh+ZhgbYogsV7WqC618aGdHknHRLuAzgXLwwT7N8XjHFLur6vfUl3avylOJotXQffRgeg1krERup/oqSGKJQjWktVJDAqDoDMIxI5i7yDQTgo17glVevmH2MhOdqu1LT4O6LFv6EUv6cKygpkid/hCVnpzkiu50+1qsIqgPHaNKQidonkYYG+KAsHWrGAmFDXw+2SjqQsIfWL5gPD0N+g1pvgIbncyhe1iMiVv+RZfI2J6V/LOqEe1F8+9kF5TFuxKZmmb4mQKSH+/ygRRcJo2zoVk17giN75H8wPpDx8YMXNOUqWzdE1xNgXQQo6hqJeSHNqZCobwCctziO1Sts+9L15MAdKgTvb1mleFiTFx4/xkYxNLxxZvpgDsJz/YmKlvFRiC6PiibQt1AiNzBKmz+xiCmGh2rSteTTmDqltRTWDHFA67EWr0jw9wUm2NwdfqYE649gn1g7o+OaEIM8EINi+z79KWakyZ4sTUlBpSO1OwrMrqb98g/ovlXwdqZ4owDI6wxcdiVFXUsvrCIQHsQfrC56dEqqCWprBNrT7Bl05ZvnWhtg19vGh/jHoR+HJRIAOaZ12orSli9y/JfBJ7sC5UtXnUJ7U1BcjNe+mDteWonOBXa1OAr60LVX9LxSe1NwWYhqumQRQnS7euHAlTAA4bwHkv7KHngbMdxa7dRwAOkyNjyhAc8hYtvCLZRs2MwGdpYZ6PoLjD4siZcgaclLfXSGagMZOLozl8Hv52mBxdU85ipqbUkKkpNWRqSg2ZmlJDpqbUjscH/wfV/O1o6PFdEQAAAABJRU5ErkJggg==",
                "backendService": {
                  "serviceUrl": "[[variables('serviceUrl')]"
                },
                "apiType": "Rest",
                "swagger": {
                  "swagger": "2.0",
                  "info": {
                    "title": "Default title",
                    "version": "1.0"
                  },
                  "host": "[[concat(parameters('API Hostname'), ':', parameters('API Port'))]",
                  "basePath": "/",
                  "schemes": [
                    "[[parameters('Http Scheme')]"
                  ],
                  "paths": {
                    "/api/alert": {
                      "post": {
                        "responses": {
                          "201": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "_id": {
                                  "type": "string",
                                  "description": "_id"
                                },
                                "id": {
                                  "type": "string",
                                  "description": "id"
                                },
                                "createdBy": {
                                  "type": "string",
                                  "description": "createdBy"
                                },
                                "updatedBy": {
                                  "type": "string",
                                  "description": "updatedBy"
                                },
                                "createdAt": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "createdAt"
                                },
                                "updatedAt": {
                                  "type": "string",
                                  "description": "updatedAt"
                                },
                                "_type": {
                                  "type": "string",
                                  "description": "_type"
                                },
                                "type": {
                                  "type": "string",
                                  "description": "type"
                                },
                                "source": {
                                  "type": "string",
                                  "description": "source"
                                },
                                "sourceRef": {
                                  "type": "string",
                                  "description": "sourceRef"
                                },
                                "externalLink": {
                                  "type": "string",
                                  "description": "externalLink"
                                },
                                "case": {
                                  "type": "string",
                                  "description": "case"
                                },
                                "title": {
                                  "type": "string",
                                  "description": "title"
                                },
                                "description": {
                                  "type": "string",
                                  "description": "description"
                                },
                                "severity": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "severity"
                                },
                                "date": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "date"
                                },
                                "tags": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "tags"
                                },
                                "tlp": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "tlp"
                                },
                                "pap": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "pap"
                                },
                                "status": {
                                  "type": "string",
                                  "description": "status"
                                },
                                "follow": {
                                  "type": "boolean",
                                  "description": "follow"
                                },
                                "customFields": {
                                  "type": "object",
                                  "description": "customFields"
                                },
                                "caseTemplate": {
                                  "type": "string",
                                  "description": "caseTemplate"
                                },
                                "artifacts": {
                                  "type": "array",
                                  "description": "artifacts"
                                },
                                "similarCases": {
                                  "type": "array",
                                  "description": "similarCases"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Create alert",
                        "description": "Create an Alert.",
                        "operationId": "[[variables('_operationId-create_alert')]",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": false,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "artifacts": {
                                  "type": "array",
                                  "description": "artifacts"
                                },
                                "description": {
                                  "type": "string",
                                  "description": "description"
                                },
                                "severity": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "severity"
                                },
                                "source": {
                                  "type": "string",
                                  "description": "source"
                                },
                                "sourceRef": {
                                  "type": "string",
                                  "description": "sourceRef"
                                },
                                "tags": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "tags"
                                },
                                "title": {
                                  "type": "string",
                                  "description": "title"
                                },
                                "tlp": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "tlp"
                                },
                                "type": {
                                  "type": "string",
                                  "description": "type"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/api/case": {
                      "post": {
                        "responses": {
                          "201": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "_id": {
                                  "type": "string",
                                  "description": "_id"
                                },
                                "id": {
                                  "type": "string",
                                  "description": "id"
                                },
                                "createdBy": {
                                  "type": "string",
                                  "description": "createdBy"
                                },
                                "updatedBy": {
                                  "type": "string",
                                  "description": "updatedBy"
                                },
                                "createdAt": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "createdAt"
                                },
                                "updatedAt": {
                                  "type": "string",
                                  "description": "updatedAt"
                                },
                                "_type": {
                                  "type": "string",
                                  "description": "_type"
                                },
                                "caseId": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "caseId"
                                },
                                "title": {
                                  "type": "string",
                                  "description": "title"
                                },
                                "description": {
                                  "type": "string",
                                  "description": "description"
                                },
                                "severity": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "severity"
                                },
                                "startDate": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "startDate"
                                },
                                "endDate": {
                                  "type": "string",
                                  "description": "endDate"
                                },
                                "impactStatus": {
                                  "type": "string",
                                  "description": "impactStatus"
                                },
                                "resolutionStatus": {
                                  "type": "string",
                                  "description": "resolutionStatus"
                                },
                                "tags": {
                                  "type": "array",
                                  "description": "tags"
                                },
                                "flag": {
                                  "type": "boolean",
                                  "description": "flag"
                                },
                                "tlp": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "tlp"
                                },
                                "pap": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "pap"
                                },
                                "status": {
                                  "type": "string",
                                  "description": "status"
                                },
                                "summary": {
                                  "type": "string",
                                  "description": "summary"
                                },
                                "owner": {
                                  "type": "string",
                                  "description": "owner"
                                },
                                "customFields": {
                                  "type": "object",
                                  "description": "customFields"
                                },
                                "stats": {
                                  "type": "object",
                                  "description": "stats"
                                },
                                "permissions": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "permissions"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Create case",
                        "operationId": "[[variables('_operationId-create_case')]",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": false,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "title": {
                                  "type": "string",
                                  "description": "title"
                                },
                                "description": {
                                  "type": "string",
                                  "description": "description"
                                },
                                "Severity": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "Severity"
                                },
                                "tlp": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "tlp"
                                },
                                "pap": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "pap"
                                },
                                "startDate": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "startDate"
                                },
                                "tags": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "tags"
                                },
                                "flag": {
                                  "type": "boolean",
                                  "description": "flag"
                                },
                                "owner": {
                                  "type": "string",
                                  "description": "owner"
                                },
                                "tasks": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "title": {
                                        "type": "string",
                                        "description": "title"
                                      },
                                      "description": {
                                        "type": "string",
                                        "description": "description"
                                      }
                                    }
                                  },
                                  "description": "tasks"
                                },
                                "customFields": {
                                  "type": "object",
                                  "properties": {
                                    "cvss": {
                                      "type": "object",
                                      "properties": {
                                        "integer": {
                                          "type": "integer",
                                          "format": "int32",
                                          "description": "integer"
                                        }
                                      },
                                      "description": "cvss"
                                    },
                                    "businessUnit": {
                                      "type": "object",
                                      "properties": {
                                        "string": {
                                          "type": "string",
                                          "description": "string"
                                        }
                                      },
                                      "description": "businessUnit"
                                    }
                                  },
                                  "description": "customFields"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/api/case/{id}/task": {
                      "post": {
                        "responses": {
                          "201": {
                            "description": "default",
                            "schema": {
                              "type": "object",
                              "properties": {
                                "id": {
                                  "type": "string",
                                  "description": "id"
                                },
                                "_id": {
                                  "type": "string",
                                  "description": "_id"
                                },
                                "createdBy": {
                                  "type": "string",
                                  "description": "createdBy"
                                },
                                "createdAt": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "createdAt"
                                },
                                "_type": {
                                  "type": "string",
                                  "description": "_type"
                                },
                                "title": {
                                  "type": "string",
                                  "description": "title"
                                },
                                "group": {
                                  "type": "string",
                                  "description": "group"
                                },
                                "description": {
                                  "type": "string",
                                  "description": "description"
                                },
                                "owner": {
                                  "type": "string",
                                  "description": "owner"
                                },
                                "status": {
                                  "type": "string",
                                  "description": "status"
                                },
                                "flag": {
                                  "type": "boolean",
                                  "description": "flag"
                                },
                                "startDate": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "startDate"
                                },
                                "endDate": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "endDate"
                                },
                                "order": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "order"
                                },
                                "dueDate": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "dueDate"
                                }
                              }
                            }
                          }
                        },
                        "summary": "Create task",
                        "operationId": "[[variables('_operationId-create_task')]",
                        "parameters": [
                          {
                            "name": "id",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": false,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "title": {
                                  "type": "string",
                                  "description": "title"
                                },
                                "group": {
                                  "type": "string",
                                  "description": "group"
                                },
                                "description": {
                                  "type": "string",
                                  "description": "description"
                                },
                                "owner": {
                                  "type": "string",
                                  "description": "owner"
                                },
                                "status": {
                                  "type": "string",
                                  "description": "status"
                                },
                                "flag": {
                                  "type": "boolean",
                                  "description": "flag"
                                },
                                "startDate": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "startDate"
                                },
                                "endDate": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "endDate"
                                },
                                "order": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "order"
                                },
                                "dueDate": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "dueDate"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/api/v1/query": {
                      "post": {
                        "responses": {
                          "201": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "_id": {
                                    "type": "string",
                                    "description": "_id"
                                  },
                                  "_type": {
                                    "type": "string",
                                    "description": "_type"
                                  },
                                  "_createdBy": {
                                    "type": "string",
                                    "description": "_createdBy"
                                  },
                                  "_updatedBy": {
                                    "type": "string",
                                    "description": "_updatedBy"
                                  },
                                  "_createdAt": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "_createdAt"
                                  },
                                  "_updatedAt": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "_updatedAt"
                                  },
                                  "dataType": {
                                    "type": "string",
                                    "description": "dataType"
                                  },
                                  "data": {
                                    "type": "string",
                                    "description": "data"
                                  },
                                  "startDate": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "startDate"
                                  },
                                  "tlp": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "tlp"
                                  },
                                  "tags": {
                                    "type": "array",
                                    "description": "tags"
                                  },
                                  "ioc": {
                                    "type": "boolean",
                                    "description": "ioc"
                                  },
                                  "sighted": {
                                    "type": "boolean",
                                    "description": "sighted"
                                  },
                                  "reports": {
                                    "type": "object",
                                    "description": "reports"
                                  },
                                  "message": {
                                    "type": "string",
                                    "description": "message"
                                  },
                                  "extraData": {
                                    "type": "object",
                                    "description": "extraData"
                                  },
                                  "attachment": {
                                    "type": "object",
                                    "properties": {
                                      "_id": {
                                        "type": "string",
                                        "description": "_id"
                                      },
                                      "_type": {
                                        "type": "string",
                                        "description": "_type"
                                      },
                                      "_createdBy": {
                                        "type": "string",
                                        "description": "_createdBy"
                                      },
                                      "_createdAt": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "_createdAt"
                                      },
                                      "name": {
                                        "type": "string",
                                        "description": "name"
                                      },
                                      "hashes": {
                                        "type": "array",
                                        "items": {
                                          "type": "string"
                                        },
                                        "description": "hashes"
                                      },
                                      "size": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "size"
                                      },
                                      "contentType": {
                                        "type": "string",
                                        "description": "contentType"
                                      },
                                      "id": {
                                        "type": "string",
                                        "description": "id"
                                      }
                                    },
                                    "description": "attachment"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "List observables",
                        "operationId": "[[variables('_operationId-list_observables')]",
                        "description": "List last 30 observables for a case",
                        "parameters": [
                          {
                            "name": "body",
                            "in": "body",
                            "required": false,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "query": {
                                  "type": "array",
                                  "items": {
                                    "type": "object",
                                    "properties": {
                                      "_name": {
                                        "type": "string",
                                        "description": "_name"
                                      },
                                      "idOrName": {
                                        "type": "string",
                                        "description": "idOrName"
                                      },
                                      "_fields": {
                                        "type": "array",
                                        "items": {
                                          "type": "object",
                                          "properties": {
                                            "startDate": {
                                              "type": "string",
                                              "description": "startDate"
                                            }
                                          }
                                        },
                                        "description": "_fields"
                                      },
                                      "from": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "from"
                                      },
                                      "to": {
                                        "type": "integer",
                                        "format": "int32",
                                        "description": "to"
                                      }
                                    }
                                  },
                                  "description": "query"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/api/v1/user/{id}": {
                      "patch": {
                        "responses": {
                          "204": {
                            "description": "default"
                          }
                        },
                        "summary": "Lock user",
                        "operationId": "[[variables('_operationId-lock_user')]",
                        "parameters": [
                          {
                            "name": "id",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": false,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "locked": {
                                  "type": "boolean",
                                  "description": "locked"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/api/v0/case/{caseId}/artifact": {
                      "post": {
                        "responses": {
                          "201": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "_id": {
                                    "type": "string",
                                    "description": "_id"
                                  },
                                  "id": {
                                    "type": "string",
                                    "description": "id"
                                  },
                                  "createdBy": {
                                    "type": "string",
                                    "description": "createdBy"
                                  },
                                  "createdAt": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "createdAt"
                                  },
                                  "_type": {
                                    "type": "string",
                                    "description": "_type"
                                  },
                                  "ip": {
                                    "type": "string",
                                    "description": "ip"
                                  },
                                  "data": {
                                    "type": "string",
                                    "description": "data"
                                  },
                                  "startDate": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "startDate"
                                  },
                                  "tlp": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "tlp"
                                  },
                                  "tags": {
                                    "type": "array",
                                    "description": "tags"
                                  },
                                  "ioc": {
                                    "type": "boolean",
                                    "description": "ioc"
                                  },
                                  "sighted": {
                                    "type": "boolean",
                                    "description": "sighted"
                                  },
                                  "message": {
                                    "type": "string",
                                    "description": "message"
                                  },
                                  "reports": {
                                    "type": "object",
                                    "description": "reports"
                                  },
                                  "stats": {
                                    "type": "object",
                                    "description": "stats"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Create observable for a case",
                        "description": "Creates an observable which can be linked to a case",
                        "operationId": "[[variables('_operationId-create_observable_case')]",
                        "parameters": [
                          {
                            "name": "caseId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": false,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "dataType": {
                                  "type": "string",
                                  "description": "dataType"
                                },
                                "tlp": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "tlp"
                                },
                                "ioc": {
                                  "type": "boolean",
                                  "description": "ioc"
                                },
                                "sighted": {
                                  "type": "boolean",
                                  "description": "sighted"
                                },
                                "tags": {
                                  "type": "array",
                                  "description": "tags"
                                },
                                "data": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "data"
                                }
                              }
                            }
                          }
                        ]
                      }
                    },
                    "/api/v0/alert/{alertId}/artifact": {
                      "post": {
                        "responses": {
                          "201": {
                            "description": "default",
                            "schema": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "_id": {
                                    "type": "string",
                                    "description": "_id"
                                  },
                                  "id": {
                                    "type": "string",
                                    "description": "id"
                                  },
                                  "createdBy": {
                                    "type": "string",
                                    "description": "createdBy"
                                  },
                                  "createdAt": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "createdAt"
                                  },
                                  "_type": {
                                    "type": "string",
                                    "description": "_type"
                                  },
                                  "ip": {
                                    "type": "string",
                                    "description": "ip"
                                  },
                                  "data": {
                                    "type": "string",
                                    "description": "data"
                                  },
                                  "startDate": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "startDate"
                                  },
                                  "tlp": {
                                    "type": "integer",
                                    "format": "int32",
                                    "description": "tlp"
                                  },
                                  "tags": {
                                    "type": "array",
                                    "description": "tags"
                                  },
                                  "ioc": {
                                    "type": "boolean",
                                    "description": "ioc"
                                  },
                                  "sighted": {
                                    "type": "boolean",
                                    "description": "sighted"
                                  },
                                  "message": {
                                    "type": "string",
                                    "description": "message"
                                  },
                                  "reports": {
                                    "type": "object",
                                    "description": "reports"
                                  },
                                  "stats": {
                                    "type": "object",
                                    "description": "stats"
                                  }
                                }
                              }
                            }
                          }
                        },
                        "summary": "Create observable for an alert",
                        "description": "Creates an observable which can be linked to an alert.",
                        "operationId": "[[variables('_operationId-create_observable_alert')]",
                        "parameters": [
                          {
                            "name": "alertId",
                            "in": "path",
                            "required": true,
                            "type": "string"
                          },
                          {
                            "name": "body",
                            "in": "body",
                            "required": false,
                            "schema": {
                              "type": "object",
                              "properties": {
                                "dataType": {
                                  "type": "string",
                                  "description": "dataType"
                                },
                                "tlp": {
                                  "type": "integer",
                                  "format": "int32",
                                  "description": "tlp"
                                },
                                "ioc": {
                                  "type": "boolean",
                                  "description": "ioc"
                                },
                                "sighted": {
                                  "type": "boolean",
                                  "description": "sighted"
                                },
                                "tags": {
                                  "type": "array",
                                  "description": "tags"
                                },
                                "data": {
                                  "type": "array",
                                  "items": {
                                    "type": "string"
                                  },
                                  "description": "data"
                                }
                              }
                            }
                          }
                        ]
                      }
                    }
                  },
                  "securityDefinitions": {
                    "basic_auth": {
                      "type": "basic"
                    }
                  },
                  "security": [
                    {}
                  ]
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('LogicAppsCustomConnector-', last(split(variables('playbookId'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "LogicAppsCustomConnector",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "TheHive",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "TheHive-CreateAlert playbook",
        "displayName": "TheHive-CreateAlert playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName2'),'/',variables('playbookVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "TheHive-CreateAlert Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "TheHive-CreateAlert",
              "type": "String"
            },
            "ConnectorName": {
              "defaultValue": "TheHive",
              "type": "string"
            },
            "onPremiseGatewayName": {
              "defaultValue": "",
              "type": "String",
              "metadata": {
                "description": "Provide the On-premises data gateway that will be used with The Hive connector. Data gateway should be deployed under the same subscription and resource group as playbook."
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "TheHiveConnectionName": "[[concat('thehive-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TheHiveConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('TheHiveConnectionName')]",
                "parameterValues": {
                  "authType": "basic",
                  "gateway": {
                    "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/connectionGateways/',parameters('onPremiseGatewayName'))]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TheHiveConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_alert": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Create_alert": {
                      "runAfter": {
                        "Parse_custom_details": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "description": "@triggerBody()?['Description']",
                          "source": "@{body('Parse_custom_details')?['source'][0]}",
                          "sourceRef": "@{body('Parse_custom_details')?['sourceRef'][0]}",
                          "title": "@triggerBody()?['AlertDisplayName']",
                          "type": "@triggerBody()?['AlertType']"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['TheHive']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/alert"
                      }
                    },
                    "Parse_custom_details": {
                      "runAfter": {
                        "Parse_extended_properties": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Parse_extended_properties')?['Custom Details']",
                        "schema": {
                          "properties": {
                            "source": {
                              "items": {
                                "type": "string"
                              },
                              "type": "array"
                            },
                            "sourceRef": {
                              "items": {
                                "type": "string"
                              },
                              "type": "array"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Parse_extended_properties": {
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@triggerBody()?['ExtendedProperties']",
                        "schema": {
                          "properties": {
                            "Alert generation status": {
                              "type": "string"
                            },
                            "Analytic Rule Ids": {
                              "type": "string"
                            },
                            "Analytic Rule Name": {
                              "type": "string"
                            },
                            "Correlation Id": {
                              "type": "string"
                            },
                            "Custom Details": {
                              "type": "string"
                            },
                            "Data Sources": {
                              "type": "string"
                            },
                            "Event Grouping": {
                              "type": "string"
                            },
                            "ProcessedBySentinel": {
                              "type": "string"
                            },
                            "Query": {
                              "type": "string"
                            },
                            "Query End Time UTC": {
                              "type": "string"
                            },
                            "Query Period": {
                              "type": "string"
                            },
                            "Query Start Time UTC": {
                              "type": "string"
                            },
                            "Search Query Results Overall Count": {
                              "type": "string"
                            },
                            "Trigger Operator": {
                              "type": "string"
                            },
                            "Trigger Threshold": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "TheHive": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TheHiveConnectionName'))]",
                        "connectionName": "[[variables('TheHiveConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "TheHive",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_TheHiveConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "The Hive - Create alert",
            "description": "Once a new Microsoft Sentinel incident is created, this playbook gets triggered and performs the following actions:\n 1. Parses alert extended properties. \n 2. Parses alert custom details.\n 3. Creates alert in TheHive with description, source, sourceRef, title and type passed.",
            "prerequisites": [
              "1. TheHive API Connector has to be deployed prior to the deployment of this playbook under the same subscription.",
			  "2. Data gateway should be deployed under the same subscription and resource group as playbooks.",
              "3. TheHive API credentials are required. Refer to the TheHive API Connector documentation."
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, authorize each connection..",
              "1.  Click the Microsoft Sentinel connection resource",
              "2.  Click edit API connection",
              "3.  Click Authorize",
              "4.  Sign in",
              "3.  Click Save",
              "4.  Repeat steps for other connections",
              "**b. Configurations in Sentinel**",
              "1. In Microsoft Sentinel, analytical rules should be configured to trigger an alert. An alert should contain source and sourceRef custom entities. [Docomentation about custom entities values](https://docs.thehive-project.org/thehive/legacy/thehive3/api/alert/)",
              "2.  Configure the automation rules to trigger the playbook."
            ],
            "lastUpdateTime": "2022-08-11T12:00:00Z",
            "tags": [
              "Incident management"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "TheHive-CreateAlert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "TheHive-CreateCase playbook",
        "displayName": "TheHive-CreateCase playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName3'),'/',variables('playbookVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "TheHive-CreateCase Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "TheHive-CreateCase",
              "type": "String"
            },
            "ConnectorName": {
              "defaultValue": "TheHive",
              "type": "string"
            },
            "onPremiseGatewayName": {
              "defaultValue": "",
              "type": "String",
              "metadata": {
                "description": "Provide the On-premises data gateway that will be used with The Hive connector. Data gateway should be deployed under the same subscription and resource group as playbook."
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "TheHiveConnectionName": "[[concat('thehive-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TheHiveConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('TheHiveConnectionName')]",
                "parameterValues": {
                  "authType": "basic",
                  "gateway": {
                    "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/connectionGateways/',parameters('onPremiseGatewayName'))]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TheHiveConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "runAfter": {
                        "create_case": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      }
                    },
                    "Entities_-_Get_IPs": {
                      "runAfter": {
                        "create_case": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "For_each_": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "create_observable_for_a_case": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "data": "@items('For_each_')?['Address']",
                              "dataType": "ip"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['TheHive']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/api/v0/case/@{encodeURIComponent(body('create_case')?['caseId'])}/artifact"
                          }
                        }
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_2": {
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "actions": {
                        "create_observable_for_a_case_2": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "data": [
                                "@items('For_each_2')?['HostName']"
                              ],
                              "dataType": "hostname"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['TheHive']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/api/v0/case/@{encodeURIComponent(body('create_case')?['caseId'])}/artifact"
                          }
                        }
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "create_case": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "description": "@triggerBody()?['object']?['properties']?['description']",
                          "title": "@triggerBody()?['object']?['properties']?['title']"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['TheHive']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/case"
                      }
                    },
                    "create_task": {
                      "runAfter": {
                        "create_case": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "description": "@body('create_case')?['description']",
                          "title": "@body('create_case')?['title']"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['TheHive']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/case/@{encodeURIComponent(body('create_case')?['caseId'])}/task"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "TheHive": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TheHiveConnectionName'))]",
                        "connectionName": "[[variables('TheHiveConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "TheHive",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_TheHiveConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "The Hive - Create case",
            "description": "Once a new Microsoft Sentinel incident is created, this playbook gets triggered and performs the following actions:\n 1. Creates case in TheHive instance with enriched description and title.\n2. Gets Hosts, IPs entities.\n3. Creates task and bind it to case.\n4. Creates observables with hosts and IPs for created case.",
            "prerequisites": [
              "1. TheHive API Connector has to be deployed prior to the deployment of this playbook under the same subscription.",
			  "2. Data gateway should be deployed under the same subscription and resource group as playbooks.",
              "3. TheHive API credentials are required. Refer to the TheHive API Connector documentation."
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, authorize each connection..",
              "1.  Click the Microsoft Sentinel connection resource",
              "2.  Click edit API connection",
              "3.  Click Authorize",
              "4.  Sign in",
              "3.  Click Save",
              "4.  Repeat steps for other connections",
              "**b. Configurations in Sentinel**",
              "1. In Microsoft Sentinel, analytical rules should be configured to trigger an alert. An alert should contain source and sourceRef custom entities. [Docomentation about custom entities values](https://docs.thehive-project.org/thehive/legacy/thehive3/api/alert/)",
              "2.  Configure the automation rules to trigger the playbook."
            ],
            "lastUpdateTime": "2022-08-11T12:00:00Z",
            "entities": [
              "host",
              "ip"
            ],
            "tags": [
              "Incident management"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "TheHive-CreateCase",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "TheHive-LockUser playbook",
        "displayName": "TheHive-LockUser playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName4'),'/',variables('playbookVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "TheHive-LockUser Playbook with template version 2.0.2",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "TheHive-LockUser",
              "type": "String"
            },
            "ConnectorName": {
              "defaultValue": "TheHive",
              "type": "string"
            },
            "onPremiseGatewayName": {
              "defaultValue": "",
              "type": "String",
              "metadata": {
                "description": "Provide the On-premises data gateway that will be used with The Hive connector. Data gateway should be deployed under the same subscription and resource group as playbook."
              }
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "TheHiveConnectionName": "[[concat('thehive-connection-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('TheHiveConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('TheHiveConnectionName')]",
                "parameterValues": {
                  "authType": "basic",
                  "gateway": {
                    "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Web/connectionGateways/',parameters('onPremiseGatewayName'))]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('TheHiveConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_incident": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      }
                    }
                  },
                  "actions": {
                    "Parse_Alerts_to_get_UserId_or_UserLogin": {
                      "foreach": "@triggerBody()?['object']?['properties']?['Alerts']",
                      "actions": {
                        "Condition": {
                          "actions": {
                            "Lock_users_by_UserId": {
                              "foreach": "@body('Parse_Alert_Custom_Details')?['UserId']",
                              "actions": {
                                "Add_comment_to_incident_(V3)_5": {
                                  "runAfter": {
                                    "Lock_user_by_id": [
                                      "Failed",
                                      "TimedOut"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>User @{items('Lock_users_by_UserId')} was not locked due to error</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  }
                                },
                                "Add_comment_to_incident_(V3)_6": {
                                  "runAfter": {
                                    "Add_comment_to_incident_(V3)_5": [
                                      "Skipped"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>User @{items('Lock_users_by_UserId')} was locked</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  }
                                },
                                "Lock_user_by_id": {
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "locked": true
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['TheHive']['connectionId']"
                                      }
                                    },
                                    "method": "patch",
                                    "path": "/api/v1/user/@{encodeURIComponent(items('Lock_users_by_UserId'))}"
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Lock_every_user_by_UserLogin": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Add_comment_to_incident_(V3)_4": {
                                "type": "ApiConnection",
                                "inputs": {
                                  "body": {
                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                    "message": "<p>The incident does not contain users with UserId.</p>"
                                  },
                                  "host": {
                                    "connection": {
                                      "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                  },
                                  "method": "post",
                                  "path": "/Incidents/Comment"
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "contains": [
                                  "@body('Parse_Alert_Custom_Details')",
                                  "UserId"
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Lock_every_user_by_UserLogin": {
                          "actions": {
                            "Lock_users_by_UserLogin": {
                              "foreach": "@body('Parse_Alert_Custom_Details')?['UserLogin']",
                              "actions": {
                                "Add_comment_to_incident_(V3)": {
                                  "runAfter": {
                                    "Lock_user_by_login": [
                                      "Failed",
                                      "TimedOut"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>User @{items('Lock_users_by_UserLogin')} was not locked due to error</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  }
                                },
                                "Add_comment_to_incident_(V3)_2": {
                                  "runAfter": {
                                    "Add_comment_to_incident_(V3)": [
                                      "Skipped"
                                    ]
                                  },
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "incidentArmId": "@triggerBody()?['object']?['id']",
                                      "message": "<p>User @{items('Lock_users_by_UserLogin')} was locked</p>"
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                      }
                                    },
                                    "method": "post",
                                    "path": "/Incidents/Comment"
                                  }
                                },
                                "Lock_user_by_login": {
                                  "type": "ApiConnection",
                                  "inputs": {
                                    "body": {
                                      "locked": true
                                    },
                                    "host": {
                                      "connection": {
                                        "name": "@parameters('$connections')['TheHive']['connectionId']"
                                      }
                                    },
                                    "method": "patch",
                                    "path": "/api/v1/user/@{encodeURIComponent(items('Lock_users_by_UserLogin'))}"
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Parse_Alert_Custom_Details": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "Add_comment_to_incident_(V3)_3": {
                                "type": "ApiConnection",
                                "inputs": {
                                  "body": {
                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                    "message": "<p>The incident does not contain users with UserLogin.</p>"
                                  },
                                  "host": {
                                    "connection": {
                                      "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                  },
                                  "method": "post",
                                  "path": "/Incidents/Comment"
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "contains": [
                                  "@body('Parse_Alert_Custom_Details')",
                                  "UserLogin"
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Parse_Alert_Custom_Details": {
                          "type": "ParseJson",
                          "inputs": {
                            "content": "@items('Parse_Alerts_to_get_UserId_or_UserLogin')?['properties']?['additionalData']?['Custom Details']",
                            "schema": {
                              "properties": {
                                "UserId": {
                                  "items": {
                                    "type": "string"
                                  },
                                  "type": "array"
                                },
                                "UserLogin": {
                                  "items": {
                                    "type": "string"
                                  },
                                  "type": "array"
                                }
                              },
                              "type": "object"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "TheHive": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('TheHiveConnectionName'))]",
                        "connectionName": "[[variables('TheHiveConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', parameters('ConnectorName'))]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "TheHive",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "LogicAppsCustomConnector",
                      "contentId": "[variables('_TheHiveConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "The Hive - Lock user",
            "description": "Once a new Microsoft Sentinel incident is created, this playbook gets triggered and performs the following actions:\n 1. Parses alerts custom details \n 2. Locks Users by UserId or UserLogin passed from alert.",
            "prerequisites": [
              "1. TheHive API Connector has to be deployed prior to the deployment of this playbook under the same subscription.",
			  "2. Data gateway should be deployed under the same subscription and resource group as playbooks.",
              "3. TheHive API credentials are required. Refer to the TheHive API Connector documentation."
            ],
            "postDeployment": [
              "**a. Authorize connections**",
              "Once deployment is complete, authorize each connection..",
              "1.  Click the Microsoft Sentinel connection resource",
              "2.  Click edit API connection",
              "3.  Click Authorize",
              "4.  Sign in",
              "3.  Click Save",
              "4.  Repeat steps for other connections",
              "**b. Configurations in Sentinel**",
              "1. In Microsoft Sentinel, analytical rules should be configured to trigger an alert. An alert should contain source and sourceRef custom entities. [Docomentation about custom entities values](https://docs.thehive-project.org/thehive/legacy/thehive3/api/alert/)",
              "2.  Configure the automation rules to trigger the playbook."
            ],
            "lastUpdateTime": "2022-08-11T12:00:00Z",
            "tags": [
              "Remediation"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "TheHive-LockUser",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.2",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "TheHive",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId1')]",
              "version": "[variables('dataConnectorVersion1')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_parserContentId1')]",
              "version": "[variables('parserVersion1')]"
            },
            {
              "kind": "LogicAppsCustomConnector",
              "contentId": "[variables('_TheHiveConnector')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_TheHive-CreateAlert')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_TheHive-CreateCase')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_TheHive-LockUser')]",
              "version": "[variables('playbookVersion4')]"
            }
          ]
        },
        "firstPublishDate": "2021-10-23",
        "providers": [
          "TheHive"
        ],
        "categories": {
          "domains": [
            "Application"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
