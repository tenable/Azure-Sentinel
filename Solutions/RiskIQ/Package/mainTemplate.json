{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for RiskIQ"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "solutionId": "azuresentinel.azure-sentinel-solution-riskiq",
    "_solutionId": "[variables('solutionId')]",
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "RiskIQ-Base": "RiskIQ-Base",
    "_RiskIQ-Base": "[variables('RiskIQ-Base')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "RiskIQ-Base",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1')))]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "RiskIQ-Automated-Triage-alert-trigger": "RiskIQ-Automated-Triage-alert-trigger",
    "_RiskIQ-Automated-Triage-alert-trigger": "[variables('RiskIQ-Automated-Triage-alert-trigger')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "RiskIQ-Automated-Triage-alert-trigger",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2')))]",
    "RiskIQ-Automated-Triage-incident-trigger": "RiskIQ-Automated-Triage-incident-trigger",
    "_RiskIQ-Automated-Triage-incident-trigger": "[variables('RiskIQ-Automated-Triage-incident-trigger')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "RiskIQ-Automated-Triage-incident-trigger",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3')))]",
    "RiskIQ-Data-PassiveDns-Domain": "RiskIQ-Data-PassiveDns-Domain",
    "_RiskIQ-Data-PassiveDns-Domain": "[variables('RiskIQ-Data-PassiveDns-Domain')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "RiskIQ-Data-PassiveDns-Domain",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4')))]",
    "RiskIQ-Data-PassiveDns-Ip": "RiskIQ-Data-PassiveDns-Ip",
    "_RiskIQ-Data-PassiveDns-Ip": "[variables('RiskIQ-Data-PassiveDns-Ip')]",
    "playbookVersion5": "1.0",
    "playbookContentId5": "RiskIQ-Data-PassiveDns-Ip",
    "_playbookContentId5": "[variables('playbookContentId5')]",
    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5')))]",
    "RiskIQ-Data-PassiveDns": "RiskIQ-Data-PassiveDns",
    "_RiskIQ-Data-PassiveDns": "[variables('RiskIQ-Data-PassiveDns')]",
    "playbookVersion6": "1.0",
    "playbookContentId6": "RiskIQ-Data-PassiveDns",
    "_playbookContentId6": "[variables('playbookContentId6')]",
    "playbookId6": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId6'))]",
    "playbookTemplateSpecName6": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId6')))]",
    "RiskIQ-Data-Summary-Domain-alert-trigger": "RiskIQ-Data-Summary-Domain-alert-trigger",
    "_RiskIQ-Data-Summary-Domain-alert-trigger": "[variables('RiskIQ-Data-Summary-Domain-alert-trigger')]",
    "playbookVersion7": "1.0",
    "playbookContentId7": "RiskIQ-Data-Summary-Domain-alert-trigger",
    "_playbookContentId7": "[variables('playbookContentId7')]",
    "playbookId7": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId7'))]",
    "playbookTemplateSpecName7": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId7')))]",
    "RiskIQ-Data-Summary-Domain-incident-trigger": "RiskIQ-Data-Summary-Domain-incident-trigger",
    "_RiskIQ-Data-Summary-Domain-incident-trigger": "[variables('RiskIQ-Data-Summary-Domain-incident-trigger')]",
    "playbookVersion8": "1.0",
    "playbookContentId8": "RiskIQ-Data-Summary-Domain-incident-trigger",
    "_playbookContentId8": "[variables('playbookContentId8')]",
    "playbookId8": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId8'))]",
    "playbookTemplateSpecName8": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId8')))]",
    "RiskIQ-Data-Summary-Ip-alert-trigger": "RiskIQ-Data-Summary-Ip-alert-trigger",
    "_RiskIQ-Data-Summary-Ip-alert-trigger": "[variables('RiskIQ-Data-Summary-Ip-alert-trigger')]",
    "playbookVersion9": "1.0",
    "playbookContentId9": "RiskIQ-Data-Summary-Ip-alert-trigger",
    "_playbookContentId9": "[variables('playbookContentId9')]",
    "playbookId9": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId9'))]",
    "playbookTemplateSpecName9": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId9')))]",
    "RiskIQ-Data-Summary-Ip-incident-trigger": "RiskIQ-Data-Summary-Ip-incident-trigger",
    "_RiskIQ-Data-Summary-Ip-incident-trigger": "[variables('RiskIQ-Data-Summary-Ip-incident-trigger')]",
    "playbookVersion10": "1.0",
    "playbookContentId10": "RiskIQ-Data-Summary-Ip-incident-trigger",
    "_playbookContentId10": "[variables('playbookContentId10')]",
    "playbookId10": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId10'))]",
    "playbookTemplateSpecName10": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId10')))]",
    "RiskIQ-Data-Summary-alert-trigger": "RiskIQ-Data-Summary-alert-trigger",
    "_RiskIQ-Data-Summary-alert-trigger": "[variables('RiskIQ-Data-Summary-alert-trigger')]",
    "playbookVersion11": "1.0",
    "playbookContentId11": "RiskIQ-Data-Summary-alert-trigger",
    "_playbookContentId11": "[variables('playbookContentId11')]",
    "playbookId11": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId11'))]",
    "playbookTemplateSpecName11": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId11')))]",
    "RiskIQ-Data-Summary-incident-trigger": "RiskIQ-Data-Summary-incident-trigger",
    "_RiskIQ-Data-Summary-incident-trigger": "[variables('RiskIQ-Data-Summary-incident-trigger')]",
    "playbookVersion12": "1.0",
    "playbookContentId12": "RiskIQ-Data-Summary-incident-trigger",
    "_playbookContentId12": "[variables('playbookContentId12')]",
    "playbookId12": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId12'))]",
    "playbookTemplateSpecName12": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId12')))]",
    "RiskIQ-Data-Whois-Domain": "RiskIQ-Data-Whois-Domain",
    "_RiskIQ-Data-Whois-Domain": "[variables('RiskIQ-Data-Whois-Domain')]",
    "playbookVersion13": "1.0",
    "playbookContentId13": "RiskIQ-Data-Whois-Domain",
    "_playbookContentId13": "[variables('playbookContentId13')]",
    "playbookId13": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId13'))]",
    "playbookTemplateSpecName13": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId13')))]",
    "RiskIQ-Data-Whois-IP": "RiskIQ-Data-Whois-IP",
    "_RiskIQ-Data-Whois-IP": "[variables('RiskIQ-Data-Whois-IP')]",
    "playbookVersion14": "1.0",
    "playbookContentId14": "RiskIQ-Data-Whois-IP",
    "_playbookContentId14": "[variables('playbookContentId14')]",
    "playbookId14": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId14'))]",
    "playbookTemplateSpecName14": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId14')))]",
    "RiskIQ-Data-Whois": "RiskIQ-Data-Whois",
    "_RiskIQ-Data-Whois": "[variables('RiskIQ-Data-Whois')]",
    "playbookVersion15": "1.0",
    "playbookContentId15": "RiskIQ-Data-Whois",
    "_playbookContentId15": "[variables('playbookContentId15')]",
    "playbookId15": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId15'))]",
    "playbookTemplateSpecName15": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId15')))]",
    "RiskIQ-Intel-Reputation-Domain-alert-trigger": "RiskIQ-Intel-Reputation-Domain-alert-trigger",
    "_RiskIQ-Intel-Reputation-Domain-alert-trigger": "[variables('RiskIQ-Intel-Reputation-Domain-alert-trigger')]",
    "playbookVersion16": "1.0",
    "playbookContentId16": "RiskIQ-Intel-Reputation-Domain-alert-trigger",
    "_playbookContentId16": "[variables('playbookContentId16')]",
    "playbookId16": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId16'))]",
    "playbookTemplateSpecName16": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId16')))]",
    "RiskIQ-Intel-Reputation-Domain-incident-trigger": "RiskIQ-Intel-Reputation-Domain-incident-trigger",
    "_RiskIQ-Intel-Reputation-Domain-incident-trigger": "[variables('RiskIQ-Intel-Reputation-Domain-incident-trigger')]",
    "playbookVersion17": "1.0",
    "playbookContentId17": "RiskIQ-Intel-Reputation-Domain-incident-trigger",
    "_playbookContentId17": "[variables('playbookContentId17')]",
    "playbookId17": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId17'))]",
    "playbookTemplateSpecName17": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId17')))]",
    "RiskIQ-Intel-Reputation-Ip-alert-trigger": "RiskIQ-Intel-Reputation-Ip-alert-trigger",
    "_RiskIQ-Intel-Reputation-Ip-alert-trigger": "[variables('RiskIQ-Intel-Reputation-Ip-alert-trigger')]",
    "playbookVersion18": "1.0",
    "playbookContentId18": "RiskIQ-Intel-Reputation-Ip-alert-trigger",
    "_playbookContentId18": "[variables('playbookContentId18')]",
    "playbookId18": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId18'))]",
    "playbookTemplateSpecName18": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId18')))]",
    "RiskIQ-Intel-Reputation-Ip-incident-trigger": "RiskIQ-Intel-Reputation-Ip-incident-trigger",
    "_RiskIQ-Intel-Reputation-Ip-incident-trigger": "[variables('RiskIQ-Intel-Reputation-Ip-incident-trigger')]",
    "playbookVersion19": "1.0",
    "playbookContentId19": "RiskIQ-Intel-Reputation-Ip-incident-trigger",
    "_playbookContentId19": "[variables('playbookContentId19')]",
    "playbookId19": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId19'))]",
    "playbookTemplateSpecName19": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId19')))]",
    "RiskIQ-Intel-Reputation-alert-trigger": "RiskIQ-Intel-Reputation-alert-trigger",
    "_RiskIQ-Intel-Reputation-alert-trigger": "[variables('RiskIQ-Intel-Reputation-alert-trigger')]",
    "playbookVersion20": "1.0",
    "playbookContentId20": "RiskIQ-Intel-Reputation-alert-trigger",
    "_playbookContentId20": "[variables('playbookContentId20')]",
    "playbookId20": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId20'))]",
    "playbookTemplateSpecName20": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId20')))]",
    "RiskIQ-Intel-Reputation-incident-trigger": "RiskIQ-Intel-Reputation-incident-trigger",
    "_RiskIQ-Intel-Reputation-incident-trigger": "[variables('RiskIQ-Intel-Reputation-incident-trigger')]",
    "playbookVersion21": "1.0",
    "playbookContentId21": "RiskIQ-Intel-Reputation-incident-trigger",
    "_playbookContentId21": "[variables('playbookContentId21')]",
    "playbookId21": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId21'))]",
    "playbookTemplateSpecName21": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId21')))]",
    "RiskIQ-Intel-Summary-Domain-alert-trigger": "RiskIQ-Intel-Summary-Domain-alert-trigger",
    "_RiskIQ-Intel-Summary-Domain-alert-trigger": "[variables('RiskIQ-Intel-Summary-Domain-alert-trigger')]",
    "playbookVersion22": "1.0",
    "playbookContentId22": "RiskIQ-Intel-Summary-Domain-alert-trigger",
    "_playbookContentId22": "[variables('playbookContentId22')]",
    "playbookId22": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId22'))]",
    "playbookTemplateSpecName22": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId22')))]",
    "RiskIQ-Intel-Summary-Domain-incident-trigger": "RiskIQ-Intel-Summary-Domain-incident-trigger",
    "_RiskIQ-Intel-Summary-Domain-incident-trigger": "[variables('RiskIQ-Intel-Summary-Domain-incident-trigger')]",
    "playbookVersion23": "1.0",
    "playbookContentId23": "RiskIQ-Intel-Summary-Domain-incident-trigger",
    "_playbookContentId23": "[variables('playbookContentId23')]",
    "playbookId23": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId23'))]",
    "playbookTemplateSpecName23": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId23')))]",
    "RiskIQ-Intel-Summary-Ip-alert-trigger": "RiskIQ-Intel-Summary-Ip-alert-trigger",
    "_RiskIQ-Intel-Summary-Ip-alert-trigger": "[variables('RiskIQ-Intel-Summary-Ip-alert-trigger')]",
    "playbookVersion24": "1.0",
    "playbookContentId24": "RiskIQ-Intel-Summary-Ip-alert-trigger",
    "_playbookContentId24": "[variables('playbookContentId24')]",
    "playbookId24": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId24'))]",
    "playbookTemplateSpecName24": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId24')))]",
    "RiskIQ-Intel-Summary-Ip-incident-trigger": "RiskIQ-Intel-Summary-Ip-incident-trigger",
    "_RiskIQ-Intel-Summary-Ip-incident-trigger": "[variables('RiskIQ-Intel-Summary-Ip-incident-trigger')]",
    "playbookVersion25": "1.0",
    "playbookContentId25": "RiskIQ-Intel-Summary-Ip-incident-trigger",
    "_playbookContentId25": "[variables('playbookContentId25')]",
    "playbookId25": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId25'))]",
    "playbookTemplateSpecName25": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId25')))]",
    "RiskIQ-Intel-Summary-alert-trigger": "RiskIQ-Intel-Summary-alert-trigger",
    "_RiskIQ-Intel-Summary-alert-trigger": "[variables('RiskIQ-Intel-Summary-alert-trigger')]",
    "playbookVersion26": "1.0",
    "playbookContentId26": "RiskIQ-Intel-Summary-alert-trigger",
    "_playbookContentId26": "[variables('playbookContentId26')]",
    "playbookId26": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId26'))]",
    "playbookTemplateSpecName26": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId26')))]",
    "RiskIQ-Intel-Summary-incident-trigger": "RiskIQ-Intel-Summary-incident-trigger",
    "_RiskIQ-Intel-Summary-incident-trigger": "[variables('RiskIQ-Intel-Summary-incident-trigger')]",
    "playbookVersion27": "1.0",
    "playbookContentId27": "RiskIQ-Intel-Summary-incident-trigger",
    "_playbookContentId27": "[variables('playbookContentId27')]",
    "playbookId27": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId27'))]",
    "playbookTemplateSpecName27": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId27')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Base playbook",
        "displayName": "RiskIQ-Base playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName1'),'/',variables('playbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "RiskIQ-Base Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Base",
              "type": "string"
            },
            "RiskiqEmail": {
              "defaultValue": "<your-email-here@example.com>",
              "type": "string"
            },
            "RiskiqApiKey": {
              "defaultValue": "<your-api-key-here>",
              "type": "string"
            }
          },
          "variables": {
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "RiskIQ-Shared",
                "parameterValues": {
                  "username": "[[parameters('RiskiqEmail')]",
                  "password": "[[parameters('RiskiqApiKey')]"
                },
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Get_account_metadata_and_settings": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/account"
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "manual": {
                      "kind": "Http",
                      "type": "Request"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Establish the needed base resources to leverage with all RiskIQ playbooks.",
            "title": "RiskIQ-Base",
            "description": "This playbook creates a shared API Connection for all RiskIQ playbooks to leverage. This eases the configuration process for a user during deployment of the RiskIQ solution. In time, this base playbook may be extended to set more functionality. You will need your API credentials (email/secret) when configuring this playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com).",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Base",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Automated-Triage playbook",
        "displayName": "RiskIQ-Automated-Triage playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName2'),'/',variables('playbookVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "RiskIQ-Automated-Triage Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Automated-Triage",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Init_Classification_Bit": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Init_Classification_Bit": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\nClassification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Append_host_classification": {
                          "inputs": {
                            "name": "classification_bit",
                            "value": "@body('Get_reputation_for_host')?['classification']"
                          },
                          "runAfter": {
                            "Set_host_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Append_host_classification": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation_for_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_host_variable": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": "@body('Get_reputation_for_host')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation_for_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br>\nClassification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Append_ip_classification": {
                          "inputs": {
                            "name": "classification_bit",
                            "value": "@body('Get_reputation')?['classification']"
                          },
                          "runAfter": {
                            "Set_ip_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Append_ip_classification": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_ip_variable": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": "@body('Get_reputation')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Classification_Bit": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "classification_bit",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Malicious_or_Suspicious": {
                      "actions": {
                        "Condition_2": {
                          "actions": {
                            "Update_incident": {
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                  "owner": "@body('Alert_-_Get_incident')?['properties']?['owner']?['objectId']",
                                  "ownerAction": "Unassign",
                                  "severity": "High",
                                  "status": "Active",
                                  "tagsToAdd": {
                                    "TagsToAdd": [
                                      {
                                        "Tag": "RiskIQ Malicious"
                                      }
                                    ]
                                  }
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "else": {
                            "actions": {
                              "Update_incident_2": {
                                "inputs": {
                                  "body": {
                                    "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                                    "owner": "@body('Alert_-_Get_incident')?['properties']?['owner']?['objectId']",
                                    "ownerAction": "Unassign",
                                    "severity": "Medium",
                                    "status": "Active",
                                    "tagsToAdd": {
                                      "TagsToAdd": [
                                        {
                                          "Tag": "RiskIQ Suspicious"
                                        }
                                      ]
                                    }
                                  },
                                  "host": {
                                    "connection": {
                                      "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                  },
                                  "method": "put",
                                  "path": "/Incidents"
                                },
                                "type": "ApiConnection"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "contains": [
                                  "@variables('classification_bit')",
                                  "MALICIOUS"
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        }
                      },
                      "expression": {
                        "or": [
                          {
                            "contains": [
                              "@variables('classification_bit')",
                              "MALICIOUS"
                            ]
                          },
                          {
                            "contains": [
                              "@variables('classification_bit')",
                              "SUSPICIOUS"
                            ]
                          }
                        ]
                      },
                      "runAfter": {
                        "For_each_Host": [
                          "Succeeded"
                        ],
                        "For_each_IP_Address": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated triage actions on the Microsoft Sentinels Incident based on RiskIQ Reputation data.",
            "title": "RiskIQ-Automated-Triage-Alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Indicators from an incident will be evaluated with RiskIQ reputation data. If any indicators are labeled as 'suspicious', the incident will be tagged as such and its severity will be marked as 'medium'. If any indicators are labeled as 'malicious', the incident will be tagged as such and its severity will be marked as 'high'. Regardless of the reputation state, comments will be added to the incident outlining the reputation details with links to further information if applicable.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Automated Triage Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Automated-Triage playbook",
        "displayName": "RiskIQ-Automated-Triage playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName3'),'/',variables('playbookVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "RiskIQ-Automated-Triage Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Automated-Triage",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Init_Classification_Bit": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Init_Classification_Bit": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\nClassification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Append_host_classification": {
                          "inputs": {
                            "name": "classification_bit",
                            "value": "@body('Get_reputation_for_host')?['classification']"
                          },
                          "runAfter": {
                            "Set_host_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Append_host_classification": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation_for_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_host_variable": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": "@body('Get_reputation_for_host')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation_for_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br>\nClassification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Append_ip_classification": {
                          "inputs": {
                            "name": "classification_bit",
                            "value": "@body('Get_reputation')?['classification']"
                          },
                          "runAfter": {
                            "Set_ip_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Append_ip_classification": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_ip_variable": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": "@body('Get_reputation')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Classification_Bit": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "classification_bit",
                            "type": "array"
                          }
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Malicious_or_Suspicious": {
                      "actions": {
                        "Condition_2": {
                          "actions": {
                            "Update_incident": {
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "owner": "@triggerBody()?['object']?['properties']?['owner']?['objectId']",
                                  "ownerAction": "Unassign",
                                  "severity": "High",
                                  "status": "Active",
                                  "tagsToAdd": {
                                    "TagsToAdd": [
                                      {
                                        "Tag": "RiskIQ Malicious"
                                      }
                                    ]
                                  }
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "else": {
                            "actions": {
                              "Update_incident_2": {
                                "inputs": {
                                  "body": {
                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                    "owner": "@triggerBody()?['object']?['properties']?['owner']?['objectId']",
                                    "ownerAction": "Unassign",
                                    "severity": "Medium",
                                    "status": "Active",
                                    "tagsToAdd": {
                                      "TagsToAdd": [
                                        {
                                          "Tag": "RiskIQ Suspicious"
                                        }
                                      ]
                                    }
                                  },
                                  "host": {
                                    "connection": {
                                      "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                  },
                                  "method": "put",
                                  "path": "/Incidents"
                                },
                                "type": "ApiConnection"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "contains": [
                                  "@variables('classification_bit')",
                                  "MALICIOUS"
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        }
                      },
                      "expression": {
                        "or": [
                          {
                            "contains": [
                              "@variables('classification_bit')",
                              "MALICIOUS"
                            ]
                          },
                          {
                            "contains": [
                              "@variables('classification_bit')",
                              "SUSPICIOUS"
                            ]
                          }
                        ]
                      },
                      "runAfter": {
                        "For_each_Host": [
                          "Succeeded"
                        ],
                        "For_each_IP_Address": [
                          "Succeeded"
                        ]
                      },
                      "type": "If"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated triage actions on the Microsoft Sentinels Incident based on RiskIQ Reputation data.",
            "title": "RiskIQ-Automated-Triage-Incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Indicators from an incident will be evaluated with RiskIQ reputation data. If any indicators are labeled as 'suspicious', the incident will be tagged as such and its severity will be marked as 'medium'. If any indicators are labeled as 'malicious', the incident will be tagged as such and its severity will be marked as 'high'. Regardless of the reputation state, comments will be added to the incident outlining the reputation details with links to further information if applicable.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Automated Triage Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-PassiveDns-Domain playbook",
        "displayName": "RiskIQ-Data-PassiveDns-Domain playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName4'),'/',variables('playbookVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-PassiveDns-Domain Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-PassiveDns-Domain",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Init_Lookback_Period": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Last week of Passive DNS for @{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}<br>\n@{variables('domain_comment')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Condition": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Condition": {
                          "actions": {
                            "Create_Host_HTML_table": {
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('domain_results')"
                              },
                              "type": "Table"
                            },
                            "Set_domain_comment": {
                              "inputs": {
                                "name": "domain_comment",
                                "value": "@body('Create_Host_HTML_table')"
                              },
                              "runAfter": {
                                "Create_Host_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            }
                          },
                          "else": {
                            "actions": {
                              "Set_domain_comment_empty": {
                                "inputs": {
                                  "name": "domain_comment",
                                  "value": "No results found."
                                },
                                "type": "SetVariable"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(variables('domain_results'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "runAfter": {
                            "For_each_host_resolve": [
                              "Succeeded"
                            ]
                          },
                          "type": "If"
                        },
                        "For_each_host_resolve": {
                          "actions": {
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "domain_results",
                                "value": {
                                  "First": "@body('Get_passive_DNS')?['firstSeen']",
                                  "Last": "@body('Get_passive_DNS')?['lastSeen']",
                                  "Type": "@items('For_each_host_resolve')?['recordType']",
                                  "Value": "@items('For_each_host_resolve')?['resolve']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_passive_DNS')?['results']",
                          "runAfter": {
                            "Get_passive_DNS": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_passive_DNS": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/dns/passive",
                            "queries": {
                              "query": "@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}",
                              "start": "@variables('lookback')",
                              "timeout": 7
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_domain_comment": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Lookback_Period": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "lookback",
                            "type": "string",
                            "value": "@{formatDateTime(addDays(utcNow(), -7), 'yyyy-MM-dd')}"
                          }
                        ]
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_domain_comment": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "domain_comment",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Init_domain_results": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_domain_results": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "domain_results",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-PassiveDns-Domain",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Passive DNS provides analysts with a means to see DNS data in a historic manner. This history can aid in creating analytical connections, especially if the operational security of a threat actor is poor. Leverage this playbook in order to enrich your incidents with raw passive DNS data related to indicators found within the incident.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data PassiveDns Domain",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-PassiveDns-Ip playbook",
        "displayName": "RiskIQ-Data-PassiveDns-Ip playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName5'),'/',variables('playbookVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-PassiveDns-Ip Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion5')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-PassiveDns-Ip",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Init_Lookback_Period": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_ip": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Last week of Passive DNS for @{items('For_each_ip')?['Address']}<br>\n@{variables('ip_comment')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Condition_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Condition_2": {
                          "actions": {
                            "Create_IP_HTML_table": {
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('ip_results')"
                              },
                              "type": "Table"
                            },
                            "Set_ip_comment": {
                              "inputs": {
                                "name": "ip_comment",
                                "value": "@body('Create_IP_HTML_table')"
                              },
                              "runAfter": {
                                "Create_IP_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            }
                          },
                          "else": {
                            "actions": {
                              "Set_variable": {
                                "inputs": {
                                  "name": "ip_comment",
                                  "value": "No results found."
                                },
                                "type": "SetVariable"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(variables('ip_results'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "runAfter": {
                            "For_each_ip_resolve": [
                              "Succeeded"
                            ]
                          },
                          "type": "If"
                        },
                        "For_each_ip_resolve": {
                          "actions": {
                            "Append_to_array_variable_2": {
                              "inputs": {
                                "name": "ip_results",
                                "value": {
                                  "First": "@item()?['firstSeen']",
                                  "Last": "@item()?['lastSeen']",
                                  "Type": "@items('For_each_ip_resolve')?['recordType']",
                                  "Value": "@items('For_each_ip_resolve')?['resolve']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_passive_DNS_2')?['results']",
                          "runAfter": {
                            "Get_passive_DNS_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_passive_DNS_2": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/dns/passive",
                            "queries": {
                              "query": "@items('For_each_ip')?['Address']",
                              "start": "@variables('lookback')",
                              "timeout": 7
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_ip_comment": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Lookback_Period": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "lookback",
                            "type": "string",
                            "value": "@{formatDateTime(addDays(utcNow(), -7), 'yyyy-MM-dd')}"
                          }
                        ]
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_ip_comment": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "ip_comment",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Init_ip_results": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_ip_results": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "ip_results",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId5')]",
                "contentId": "[variables('_playbookContentId5')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-PassiveDns-Ip",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Passive DNS provides analysts with a means to see DNS data in a historic manner. This history can aid in creating analytical connections, especially if the operational security of a threat actor is poor. Leverage this playbook in order to enrich your incidents with raw passive DNS data related to indicators found within the incident.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data PassiveDns Ip",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-PassiveDns playbook",
        "displayName": "RiskIQ-Data-PassiveDns playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName6'),'/',variables('playbookVersion6'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName6'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-PassiveDns Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion6')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-PassiveDns",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Init_Lookback_Period": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Init_Lookback_Period": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Last week of Passive DNS for @{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}<br>\n@{variables('domain_comment')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Condition": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Condition": {
                          "actions": {
                            "Create_Host_HTML_table": {
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('domain_results')"
                              },
                              "type": "Table"
                            },
                            "Set_domain_comment": {
                              "inputs": {
                                "name": "domain_comment",
                                "value": "@body('Create_Host_HTML_table')"
                              },
                              "runAfter": {
                                "Create_Host_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            }
                          },
                          "else": {
                            "actions": {
                              "Set_domain_comment_empty": {
                                "inputs": {
                                  "name": "domain_comment",
                                  "value": "No results found."
                                },
                                "type": "SetVariable"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(variables('domain_results'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "runAfter": {
                            "For_each_host_resolve": [
                              "Succeeded"
                            ]
                          },
                          "type": "If"
                        },
                        "For_each_host_resolve": {
                          "actions": {
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "domain_results",
                                "value": {
                                  "First": "@body('Get_passive_DNS')?['firstSeen']",
                                  "Last": "@body('Get_passive_DNS')?['lastSeen']",
                                  "Type": "@items('For_each_host_resolve')?['recordType']",
                                  "Value": "@items('For_each_host_resolve')?['resolve']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_passive_DNS')?['results']",
                          "runAfter": {
                            "Get_passive_DNS": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_passive_DNS": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/dns/passive",
                            "queries": {
                              "query": "@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}",
                              "start": "@variables('lookback')",
                              "timeout": 7
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_domain_comment": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_ip": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Last week of Passive DNS for @{items('For_each_ip')?['Address']}<br>\n@{variables('ip_comment')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Condition_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Condition_2": {
                          "actions": {
                            "Create_IP_HTML_table": {
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('ip_results')"
                              },
                              "type": "Table"
                            },
                            "Set_ip_comment": {
                              "inputs": {
                                "name": "ip_comment",
                                "value": "@body('Create_IP_HTML_table')"
                              },
                              "runAfter": {
                                "Create_IP_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            }
                          },
                          "else": {
                            "actions": {
                              "Set_variable": {
                                "inputs": {
                                  "name": "ip_comment",
                                  "value": "No results found."
                                },
                                "type": "SetVariable"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@length(variables('ip_results'))",
                                  0
                                ]
                              }
                            ]
                          },
                          "runAfter": {
                            "For_each_ip_resolve": [
                              "Succeeded"
                            ]
                          },
                          "type": "If"
                        },
                        "For_each_ip_resolve": {
                          "actions": {
                            "Append_to_array_variable_2": {
                              "inputs": {
                                "name": "ip_results",
                                "value": {
                                  "First": "@item()?['firstSeen']",
                                  "Last": "@item()?['lastSeen']",
                                  "Type": "@items('For_each_ip_resolve')?['recordType']",
                                  "Value": "@items('For_each_ip_resolve')?['resolve']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_passive_DNS_2')?['results']",
                          "runAfter": {
                            "Get_passive_DNS_2": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_passive_DNS_2": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/dns/passive",
                            "queries": {
                              "query": "@items('For_each_ip')?['Address']",
                              "start": "@variables('lookback')",
                              "timeout": 7
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_ip_comment": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Lookback_Period": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "lookback",
                            "type": "string",
                            "value": "@{formatDateTime(addDays(utcNow(), -7), 'yyyy-MM-dd')}"
                          }
                        ]
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_domain_comment": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "domain_comment",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Init_domain_results": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_domain_results": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "domain_results",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_ip_comment": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "ip_comment",
                            "type": "string"
                          }
                        ]
                      },
                      "runAfter": {
                        "Init_ip_results": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_ip_results": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "ip_results",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId6'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId6')]",
                "contentId": "[variables('_playbookContentId6')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-PassiveDns",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Passive DNS provides analysts with a means to see DNS data in a historic manner. This history can aid in creating analytical connections, especially if the operational security of a threat actor is poor. Leverage this playbook in order to enrich your incidents with raw passive DNS data related to indicators found within the incident.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data PassiveDns",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-Summary-Domain playbook",
        "displayName": "RiskIQ-Data-Summary-Domain playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName7'),'/',variables('playbookVersion7'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName7'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-Summary-Domain Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion7')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-Summary-Domain",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Host Summary<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Format_Host_Record": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Format_Host_Record": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": [
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['count']",
                                "Dataset": "Resolutions",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['count']",
                                "Dataset": "Certificates",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['count']",
                                "Dataset": "Trackers",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['count']",
                                "Dataset": "Components",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['count']",
                                "Dataset": "Host Pairs",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['count']",
                                "Dataset": "Cookies",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['count']",
                                "Dataset": "Hashes",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['count']",
                                "Dataset": "Articles",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['link']"
                              }
                            ]
                          },
                          "runAfter": {
                            "Get_summary_data_card_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Get_summary_data_card_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/cards/summary",
                            "queries": {
                              "query": "@items('For_each_Host')?['DnsDomain']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId7'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId7')]",
                "contentId": "[variables('_playbookContentId7')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-Summary-Domain-alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. The RiskIQ summary data will provide analysts with an understanding of what RiskIQ knows about a given indicator extracted from the incident in the form of result counts with corresponding data sets. Each data set will be linked, making it easy for an analyst to one-click pivot into a deeper investigation.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data Summary Domain Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-Summary-Domain playbook",
        "displayName": "RiskIQ-Data-Summary-Domain playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName8'),'/',variables('playbookVersion8'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName8'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-Summary-Domain Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion8')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-Summary-Domain",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>Host Summary<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Format_Host_Record": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Format_Host_Record": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": [
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['count']",
                                "Dataset": "Resolutions",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['count']",
                                "Dataset": "Certificates",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['count']",
                                "Dataset": "Trackers",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['count']",
                                "Dataset": "Components",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['count']",
                                "Dataset": "Host Pairs",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['count']",
                                "Dataset": "Cookies",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['count']",
                                "Dataset": "Hashes",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['count']",
                                "Dataset": "Articles",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['link']"
                              }
                            ]
                          },
                          "runAfter": {
                            "Get_summary_data_card_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Get_summary_data_card_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/cards/summary",
                            "queries": {
                              "query": "@items('For_each_Host')?['DnsDomain']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId8'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId8')]",
                "contentId": "[variables('_playbookContentId8')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-Summary-Domain-incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. The RiskIQ summary data will provide analysts with an understanding of what RiskIQ knows about a given indicator extracted from the incident in the form of result counts with corresponding data sets. Each data set will be linked, making it easy for an analyst to one-click pivot into a deeper investigation.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data Summary Domain Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-Summary-Ip playbook",
        "displayName": "RiskIQ-Data-Summary-Ip playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName9'),'/',variables('playbookVersion9'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName9'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-Summary-Ip Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion9')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-Summary-Ip",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>IP Summary<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Format_IP_Record": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Format_IP_Record": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": [
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['count']",
                                "Dataset": "Resolutions",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['count']",
                                "Dataset": "Certificates",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['count']",
                                "Dataset": "Trackers",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['count']",
                                "Dataset": "Components",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['count']",
                                "Dataset": "Host Pairs",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['count']",
                                "Dataset": "Cookies",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['count']",
                                "Dataset": "Services",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['count']",
                                "Dataset": "DNS",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['count']",
                                "Dataset": "Hashes",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['count']",
                                "Dataset": "Articles",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['link']"
                              }
                            ]
                          },
                          "runAfter": {
                            "Get_summary_data_card_ip": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Get_summary_data_card_ip": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/cards/summary",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId9'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId9')]",
                "contentId": "[variables('_playbookContentId9')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-Summary-Ip-Alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. The RiskIQ summary data will provide analysts with an understanding of what RiskIQ knows about a given indicator extracted from the incident in the form of result counts with corresponding data sets. Each data set will be linked, making it easy for an analyst to one-click pivot into a deeper investigation.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data Summary Ip Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-Summary-Ip playbook",
        "displayName": "RiskIQ-Data-Summary-Ip playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName10'),'/',variables('playbookVersion10'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName10'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-Summary-Ip Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion10')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-Summary-Ip",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>IP Summary<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Format_IP_Record": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Format_IP_Record": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": [
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['count']",
                                "Dataset": "Resolutions",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['count']",
                                "Dataset": "Certificates",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['count']",
                                "Dataset": "Trackers",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['count']",
                                "Dataset": "Components",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['count']",
                                "Dataset": "Host Pairs",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['count']",
                                "Dataset": "Cookies",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['count']",
                                "Dataset": "Services",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['count']",
                                "Dataset": "DNS",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['count']",
                                "Dataset": "Hashes",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['count']",
                                "Dataset": "Articles",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['link']"
                              }
                            ]
                          },
                          "runAfter": {
                            "Get_summary_data_card_ip": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Get_summary_data_card_ip": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/cards/summary",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId10'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId10')]",
                "contentId": "[variables('_playbookContentId10')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-Summary-Ip-Incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. The RiskIQ summary data will provide analysts with an understanding of what RiskIQ knows about a given indicator extracted from the incident in the form of result counts with corresponding data sets. Each data set will be linked, making it easy for an analyst to one-click pivot into a deeper investigation.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data Summary Ip Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName11')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-Summary playbook",
        "displayName": "RiskIQ-Data-Summary playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName11'),'/',variables('playbookVersion11'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName11'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-Summary Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion11')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-Summary",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Host Summary<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Format_Host_Record": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Format_Host_Record": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": [
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['count']",
                                "Dataset": "Resolutions",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['count']",
                                "Dataset": "Certificates",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['count']",
                                "Dataset": "Trackers",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['count']",
                                "Dataset": "Components",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['count']",
                                "Dataset": "Host Pairs",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['count']",
                                "Dataset": "Cookies",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['count']",
                                "Dataset": "Hashes",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['count']",
                                "Dataset": "Articles",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['link']"
                              }
                            ]
                          },
                          "runAfter": {
                            "Get_summary_data_card_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Get_summary_data_card_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/cards/summary",
                            "queries": {
                              "query": "@items('For_each_Host')?['DnsDomain']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>IP Summary<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Format_IP_Record": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Format_IP_Record": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": [
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['count']",
                                "Dataset": "Resolutions",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['count']",
                                "Dataset": "Certificates",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['count']",
                                "Dataset": "Trackers",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['count']",
                                "Dataset": "Components",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['count']",
                                "Dataset": "Host Pairs",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['count']",
                                "Dataset": "Cookies",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['count']",
                                "Dataset": "Services",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['count']",
                                "Dataset": "DNS",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['count']",
                                "Dataset": "Hashes",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['count']",
                                "Dataset": "Articles",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['link']"
                              }
                            ]
                          },
                          "runAfter": {
                            "Get_summary_data_card_ip": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Get_summary_data_card_ip": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/cards/summary",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId11'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId11')]",
                "contentId": "[variables('_playbookContentId11')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion11')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ Data Summary Alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. The RiskIQ summary data will provide analysts with an understanding of what RiskIQ knows about a given indicator extracted from the incident in the form of result counts with corresponding data sets. Each data set will be linked, making it easy for an analyst to one-click pivot into a deeper investigation.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data Summary Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName12')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-Summary playbook",
        "displayName": "RiskIQ-Data-Summary playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName12'),'/',variables('playbookVersion12'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName12'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-Summary Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion12')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-Summary",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>Host Summary<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Format_Host_Record": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Format_Host_Record": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": [
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['count']",
                                "Dataset": "Resolutions",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['count']",
                                "Dataset": "Certificates",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['count']",
                                "Dataset": "Trackers",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['count']",
                                "Dataset": "Components",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['count']",
                                "Dataset": "Host Pairs",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['count']",
                                "Dataset": "Cookies",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['count']",
                                "Dataset": "Hashes",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['count']",
                                "Dataset": "Articles",
                                "Link": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['link']"
                              }
                            ]
                          },
                          "runAfter": {
                            "Get_summary_data_card_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Get_summary_data_card_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/cards/summary",
                            "queries": {
                              "query": "@items('For_each_Host')?['DnsDomain']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>IP Summary<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Format_IP_Record": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Format_IP_Record": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": [
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['count']",
                                "Dataset": "Resolutions",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['count']",
                                "Dataset": "Certificates",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['count']",
                                "Dataset": "Trackers",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['count']",
                                "Dataset": "Components",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['count']",
                                "Dataset": "Host Pairs",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['count']",
                                "Dataset": "Cookies",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['count']",
                                "Dataset": "Services",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['count']",
                                "Dataset": "DNS",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['count']",
                                "Dataset": "Hashes",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['link']"
                              },
                              {
                                "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['count']",
                                "Dataset": "Articles",
                                "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['link']"
                              }
                            ]
                          },
                          "runAfter": {
                            "Get_summary_data_card_ip": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        },
                        "Get_summary_data_card_ip": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/cards/summary",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId12'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId12')]",
                "contentId": "[variables('_playbookContentId12')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion12')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ Data Summary Incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. The RiskIQ summary data will provide analysts with an understanding of what RiskIQ knows about a given indicator extracted from the incident in the form of result counts with corresponding data sets. Each data set will be linked, making it easy for an analyst to one-click pivot into a deeper investigation.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data Summary Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName13')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-Whois-Domain playbook",
        "displayName": "RiskIQ-Data-Whois-Domain playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName13'),'/',variables('playbookVersion13'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName13'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-Whois-Domain Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion13')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-Whois-Domain",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Associated WHOIS record for @{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}:<br>\n<br>\nRegistrar: @{body('Get_WHOIS')?['registrar']}<br>\nRegistered:@{body('Get_WHOIS')?['registered']}<br>\nExpires: @{body('Get_WHOIS')?['expiresAt']}<br>\nContact: @{body('Get_WHOIS')?['contactEmail']}<br>\nNameservers: @{body('Get_WHOIS')?['nameServers']}<br>\n<br>\nTo search on WHOIS data or view historic records, see https://community.riskiq.com/search/@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}/whois</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Get_WHOIS": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Get_WHOIS": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/whois",
                            "queries": {
                              "query": "@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId13'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId13')]",
                "contentId": "[variables('_playbookContentId13')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion13')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-Whois-Domain",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. WHOIS is akin to a phone book for the Internet; it reveals the owners behind domain registrations and IP address hosting. Analysts can leverage WHOIS, both active and historic, in order to identify analytical leads. This data can sometimes reveal the threat actor behind a given set of infrastructure or provide deeper context as to what else may be related. This playbook will query for WHOIS data from indicators contained within the incident and post the results in the form of a comment.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data Whois Domain",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName14')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-Whois-Ip playbook",
        "displayName": "RiskIQ-Data-Whois-Ip playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName14'),'/',variables('playbookVersion14'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName14'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-Whois-Ip Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion14')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-Whois-Ip",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_ip": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Associated WHOIS record for @{items('For_each_ip')?['Address']}:<br>\n<br>\nRegistrar: @{body('Get_WHOIS_IP')?['registrar']}<br>\nRegistered:@{body('Get_WHOIS_IP')?['registered']}<br>\nExpires: @{body('Get_WHOIS_IP')?['expiresAt']}<br>\nContact: @{body('Get_WHOIS_IP')?['contactEmail']}<br>\nNameservers: @{body('Get_WHOIS_IP')?['nameServers']}<br>\n<br>\nTo search on WHOIS data or view historic records, see https://community.riskiq.com/search/@{items('For_each_ip')?['Address']}/whois</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Get_WHOIS_IP": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Get_WHOIS_IP": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/whois",
                            "queries": {
                              "query": "@items('For_each_ip')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId14'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId14')]",
                "contentId": "[variables('_playbookContentId14')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion14')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-Whois-Ip",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. WHOIS is akin to a phone book for the Internet; it reveals the owners behind domain registrations and IP address hosting. Analysts can leverage WHOIS, both active and historic, in order to identify analytical leads. This data can sometimes reveal the threat actor behind a given set of infrastructure or provide deeper context as to what else may be related. This playbook will query for WHOIS data from indicators contained within the incident and post the results in the form of a comment.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data Whois Ip",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName15')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Data-Whois playbook",
        "displayName": "RiskIQ-Data-Whois playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName15'),'/',variables('playbookVersion15'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName15'))]"
      ],
      "properties": {
        "description": "RiskIQ-Data-Whois Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion15')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Data-Whois",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Associated WHOIS record for @{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}:<br>\n<br>\nRegistrar: @{body('Get_WHOIS')?['registrar']}<br>\nRegistered:@{body('Get_WHOIS')?['registered']}<br>\nExpires: @{body('Get_WHOIS')?['expiresAt']}<br>\nContact: @{body('Get_WHOIS')?['contactEmail']}<br>\nNameservers: @{body('Get_WHOIS')?['nameServers']}<br>\n<br>\nTo search on WHOIS data or view historic records, see https://community.riskiq.com/search/@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}/whois</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Get_WHOIS": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Get_WHOIS": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/whois",
                            "queries": {
                              "query": "@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_ip": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Associated WHOIS record for @{items('For_each_ip')?['Address']}:<br>\n<br>\nRegistrar: @{body('Get_WHOIS_IP')?['registrar']}<br>\nRegistered:@{body('Get_WHOIS_IP')?['registered']}<br>\nExpires: @{body('Get_WHOIS_IP')?['expiresAt']}<br>\nContact: @{body('Get_WHOIS_IP')?['contactEmail']}<br>\nNameservers: @{body('Get_WHOIS_IP')?['nameServers']}<br>\n<br>\nTo search on WHOIS data or view historic records, see https://community.riskiq.com/search/@{items('For_each_ip')?['Address']}/whois</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Get_WHOIS_IP": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Get_WHOIS_IP": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/whois",
                            "queries": {
                              "query": "@items('For_each_ip')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId15'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId15')]",
                "contentId": "[variables('_playbookContentId15')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion15')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Internet data.",
            "title": "RiskIQ-Data-Whois",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. WHOIS is akin to a phone book for the Internet; it reveals the owners behind domain registrations and IP address hosting. Analysts can leverage WHOIS, both active and historic, in order to identify analytical leads. This data can sometimes reveal the threat actor behind a given set of infrastructure or provide deeper context as to what else may be related. This playbook will query for WHOIS data from indicators contained within the incident and post the results in the form of a comment.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Data Whois",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName16')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Reputation-Domain playbook",
        "displayName": "RiskIQ-Intel-Reputation-Domain playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName16'),'/',variables('playbookVersion16'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName16'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Reputation-Domain Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion16')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Reputation-Domain",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\nClassification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Set_host_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation_for_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_host_variable": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": "@body('Get_reputation_for_host')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation_for_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId16'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId16')]",
                "contentId": "[variables('_playbookContentId16')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion16')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Reputation data.",
            "title": "RiskIQ-Intel-Reputation-Domain-Alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Reputation information provides analyst with a decision as to whether an indicator is considered benign, suspicious or malicious. Analysts can leverage this playbook in order to enrich indicators found within an incident. Each reputation result is contained within a comment and will include detailed scoring information noting why a given indicator is considered suspicious or malicious with links back to the RiskIQ platform for more information.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Reputation Domain Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName17')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Reputation-Domain playbook",
        "displayName": "RiskIQ-Intel-Reputation-Domain playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName17'),'/',variables('playbookVersion17'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName17'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Reputation-Domain Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion17')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Reputation-Domain",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\nClassification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Set_host_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation_for_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_host_variable": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": "@body('Get_reputation_for_host')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation_for_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId17'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId17')]",
                "contentId": "[variables('_playbookContentId17')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion17')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Reputation data.",
            "title": "RiskIQ-Intel-Reputation-Domain-Incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Reputation information provides analyst with a decision as to whether an indicator is considered benign, suspicious or malicious. Analysts can leverage this playbook in order to enrich indicators found within an incident. Each reputation result is contained within a comment and will include detailed scoring information noting why a given indicator is considered suspicious or malicious with links back to the RiskIQ platform for more information.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Reputation Domain Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName18')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Reputation-Ip playbook",
        "displayName": "RiskIQ-Intel-Reputation-Ip playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName18'),'/',variables('playbookVersion18'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName18'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Reputation-Ip Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion18')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Reputation-Ip",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br>\nClassification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Set_ip_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_ip_variable": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": "@body('Get_reputation')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId18'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId18')]",
                "contentId": "[variables('_playbookContentId18')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion18')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Reputation data.",
            "title": "RiskIQ-Intel-Reputation-Ip-Alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Reputation information provides analyst with a decision as to whether an indicator is considered benign, suspicious or malicious. Analysts can leverage this playbook in order to enrich indicators found within an incident. Each reputation result is contained within a comment and will include detailed scoring information noting why a given indicator is considered suspicious or malicious with links back to the RiskIQ platform for more information.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Reputation Ip Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName19')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Reputation-Ip playbook",
        "displayName": "RiskIQ-Intel-Reputation-Ip playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName19'),'/',variables('playbookVersion19'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName19'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Reputation-Ip Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion19')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Reputation-Ip",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br>\nClassification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Set_ip_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_ip_variable": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": "@body('Get_reputation')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId19'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId19')]",
                "contentId": "[variables('_playbookContentId19')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion19')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Reputation data.",
            "title": "RiskIQ-Intel-Reputation-Ip-Incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Reputation information provides analyst with a decision as to whether an indicator is considered benign, suspicious or malicious. Analysts can leverage this playbook in order to enrich indicators found within an incident. Each reputation result is contained within a comment and will include detailed scoring information noting why a given indicator is considered suspicious or malicious with links back to the RiskIQ platform for more information.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Reputation Ip Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName20')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Reputation playbook",
        "displayName": "RiskIQ-Intel-Reputation playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName20'),'/',variables('playbookVersion20'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName20'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Reputation Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion20')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Reputation",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\nClassification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Set_host_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation_for_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_host_variable": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": "@body('Get_reputation_for_host')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation_for_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br>\nClassification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Set_ip_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_ip_variable": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": "@body('Get_reputation')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId20'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId20')]",
                "contentId": "[variables('_playbookContentId20')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion20')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Reputation data.",
            "title": "RiskIQ-Intel-Reputation-Alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Reputation information provides analyst with a decision as to whether an indicator is considered benign, suspicious or malicious. Analysts can leverage this playbook in order to enrich indicators found within an incident. Each reputation result is contained within a comment and will include detailed scoring information noting why a given indicator is considered suspicious or malicious with links back to the RiskIQ platform for more information.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Reputation Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName21')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Reputation playbook",
        "displayName": "RiskIQ-Intel-Reputation playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName21'),'/',variables('playbookVersion21'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName21'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Reputation Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion21')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Reputation",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\nClassification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "Set_host_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation_for_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_host_variable": {
                          "inputs": {
                            "name": "result_output_host",
                            "value": "@body('Get_reputation_for_host')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation_for_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br>\nClassification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "Set_ip_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "Get_reputation": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/reputation",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        },
                        "Set_ip_variable": {
                          "inputs": {
                            "name": "result_output_ip",
                            "value": "@body('Get_reputation')?['rules']"
                          },
                          "runAfter": {
                            "Get_reputation": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId21'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId21')]",
                "contentId": "[variables('_playbookContentId21')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion21')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Reputation data.",
            "title": "RiskIQ-Intel-Reputation-Incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. Reputation information provides analyst with a decision as to whether an indicator is considered benign, suspicious or malicious. Analysts can leverage this playbook in order to enrich indicators found within an incident. Each reputation result is contained within a comment and will include detailed scoring information noting why a given indicator is considered suspicious or malicious with links back to the RiskIQ platform for more information.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Reputation Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName22')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Summary-Domain playbook",
        "displayName": "RiskIQ-Intel-Summary-Domain playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName22'),'/',variables('playbookVersion22'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName22'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Summary-Domain Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion22')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Summary-Domain",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Threat Article Results: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "For_each_host_article": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "For_each_host_article": {
                          "actions": {
                            "Append_to_host_array": {
                              "inputs": {
                                "name": "result_output_host",
                                "value": {
                                  "Link": "@item()['link']",
                                  "Title": "@item()['title']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_articles_by_indicator_host')?['articles']",
                          "runAfter": {
                            "Get_articles_by_indicator_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_articles_by_indicator_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/articles/indicator",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId22'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId22')]",
                "contentId": "[variables('_playbookContentId22')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion22')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Intelligence data.",
            "title": "RiskIQ-Intel-Summary-Domain-Alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. RiskIQ intelligence provides analyst with deeper context around vulnerabilities, threat actors, their campaigns or other noteworthy context found from analyzing the Internet. Analysts can leverage this playbook to add context to indicators found within incidents. Each comment added to the incident will link to a more detailed intelligence card from RiskIQ.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Summary Domain Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName23')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Summary-Domain playbook",
        "displayName": "RiskIQ-Intel-Summary-Domain playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName23'),'/',variables('playbookVersion23'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName23'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Summary-Domain Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion23')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Summary-Domain",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>Threat Article Results: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "For_each_host_article": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "For_each_host_article": {
                          "actions": {
                            "Append_to_host_array": {
                              "inputs": {
                                "name": "result_output_host",
                                "value": {
                                  "Link": "@item()['link']",
                                  "Title": "@item()['title']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_articles_by_indicator_host')?['articles']",
                          "runAfter": {
                            "Get_articles_by_indicator_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_articles_by_indicator_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/articles/indicator",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId23'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId23')]",
                "contentId": "[variables('_playbookContentId23')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion23')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Intelligence data.",
            "title": "RiskIQ-Intel-Summary-Domain-Incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. RiskIQ intelligence provides analyst with deeper context around vulnerabilities, threat actors, their campaigns or other noteworthy context found from analyzing the Internet. Analysts can leverage this playbook to add context to indicators found within incidents. Each comment added to the incident will link to a more detailed intelligence card from RiskIQ.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Summary Domain Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName24')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Summary-Ip playbook",
        "displayName": "RiskIQ-Intel-Summary-Ip playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName24'),'/',variables('playbookVersion24'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName24'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Summary-Ip Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion24')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Summary-Ip",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Threat Article Results: @{items('For_each_IP_Address')?['Address']}<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "For_each_ip_article": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "For_each_ip_article": {
                          "actions": {
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "result_output_ip",
                                "value": {
                                  "Link": "@item()['link']",
                                  "Title": "@item()['title']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_articles_by_indicator_ip')?['articles']",
                          "runAfter": {
                            "Get_articles_by_indicator_ip": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_articles_by_indicator_ip": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/articles/indicator",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId24'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId24')]",
                "contentId": "[variables('_playbookContentId24')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion24')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Intelligence data.",
            "title": "RiskIQ-Intel-Summary-Ip-Alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. RiskIQ intelligence provides analyst with deeper context around vulnerabilities, threat actors, their campaigns or other noteworthy context found from analyzing the Internet. Analysts can leverage this playbook to add context to indicators found within incidents. Each comment added to the incident will link to a more detailed intelligence card from RiskIQ.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Summary Ip Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName25')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Summary-Ip playbook",
        "displayName": "RiskIQ-Intel-Summary-Ip playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName25'),'/',variables('playbookVersion25'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName25'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Summary-Ip Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion25')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Summary-Ip",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>Threat Article Results: @{items('For_each_IP_Address')?['Address']}<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "For_each_ip_article": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "For_each_ip_article": {
                          "actions": {
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "result_output_ip",
                                "value": {
                                  "Link": "@item()['link']",
                                  "Title": "@item()['title']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_articles_by_indicator_ip')?['articles']",
                          "runAfter": {
                            "Get_articles_by_indicator_ip": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_articles_by_indicator_ip": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/articles/indicator",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId25'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId25')]",
                "contentId": "[variables('_playbookContentId25')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion25')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Intelligence data.",
            "title": "RiskIQ-Intel-Summary-Ip-Incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. RiskIQ intelligence provides analyst with deeper context around vulnerabilities, threat actors, their campaigns or other noteworthy context found from analyzing the Internet. Analysts can leverage this playbook to add context to indicators found within incidents. Each comment added to the incident will link to a more detailed intelligence card from RiskIQ.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "entities": [
              "Ip"
            ],
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Summary Ip Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName26')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Summary playbook",
        "displayName": "RiskIQ-Intel-Summary playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName26'),'/',variables('playbookVersion26'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName26'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Summary Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion26')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Summary",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Alert_-_Get_incident": {
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "runAfter": {
                        "Alert_-_Get_incident": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Threat Article Results: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "For_each_host_article": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "For_each_host_article": {
                          "actions": {
                            "Append_to_host_array": {
                              "inputs": {
                                "name": "result_output_host",
                                "value": {
                                  "Link": "@item()['link']",
                                  "Title": "@item()['title']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_articles_by_indicator_host')?['articles']",
                          "runAfter": {
                            "Get_articles_by_indicator_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_articles_by_indicator_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/articles/indicator",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                              "message": "<p>Threat Article Results: @{items('For_each_IP_Address')?['Address']}<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "For_each_ip_article": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "For_each_ip_article": {
                          "actions": {
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "result_output_ip",
                                "value": {
                                  "Link": "@item()['link']",
                                  "Title": "@item()['title']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_articles_by_indicator_ip')?['articles']",
                          "runAfter": {
                            "Get_articles_by_indicator_ip": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_articles_by_indicator_ip": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/articles/indicator",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId26'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId26')]",
                "contentId": "[variables('_playbookContentId26')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion26')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Intelligence data.",
            "title": "RiskIQ-Intel-Summary-Alert",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. RiskIQ intelligence provides analyst with deeper context around vulnerabilities, threat actors, their campaigns or other noteworthy context found from analyzing the Internet. Analysts can leverage this playbook to add context to indicators found within incidents. Each comment added to the incident will link to a more detailed intelligence card from RiskIQ.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Summary Alert",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName27')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RiskIQ-Intel-Summary playbook",
        "displayName": "RiskIQ-Intel-Summary playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName27'),'/',variables('playbookVersion27'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName27'))]"
      ],
      "properties": {
        "description": "RiskIQ-Intel-Summary Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion27')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RiskIQ-Intel-Summary",
              "type": "string"
            }
          },
          "variables": {
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "RiskIQConnectionName": "riskiq-shared",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('RiskIQConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "LogicAppsCategory": "security",
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      },
                      "type": "ApiConnection"
                    },
                    "Entities_-_Get_IPs": {
                      "inputs": {
                        "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      },
                      "type": "ApiConnection"
                    },
                    "For_each_Host": {
                      "actions": {
                        "Add_comment_to_incident_(V3)_2": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>Threat Article Results: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br>\n@{body('Create_Host_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_Host_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_Host_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_host')"
                          },
                          "runAfter": {
                            "For_each_host_article": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "For_each_host_article": {
                          "actions": {
                            "Append_to_host_array": {
                              "inputs": {
                                "name": "result_output_host",
                                "value": {
                                  "Link": "@item()['link']",
                                  "Title": "@item()['title']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_articles_by_indicator_host')?['articles']",
                          "runAfter": {
                            "Get_articles_by_indicator_host": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_articles_by_indicator_host": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/articles/indicator",
                            "queries": {
                              "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "runAfter": {
                        "Init_Result_Host": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_IP_Address": {
                      "actions": {
                        "Add_comment_to_incident_(V3)": {
                          "inputs": {
                            "body": {
                              "incidentArmId": "@triggerBody()?['object']?['id']",
                              "message": "<p>Threat Article Results: @{items('For_each_IP_Address')?['Address']}<br>\n@{body('Create_IP_HTML_table')}</p>"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/Incidents/Comment"
                          },
                          "runAfter": {
                            "Create_IP_HTML_table": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection"
                        },
                        "Create_IP_HTML_table": {
                          "inputs": {
                            "format": "HTML",
                            "from": "@variables('result_output_ip')"
                          },
                          "runAfter": {
                            "For_each_ip_article": [
                              "Succeeded"
                            ]
                          },
                          "type": "Table"
                        },
                        "For_each_ip_article": {
                          "actions": {
                            "Append_to_array_variable": {
                              "inputs": {
                                "name": "result_output_ip",
                                "value": {
                                  "Link": "@item()['link']",
                                  "Title": "@item()['title']"
                                }
                              },
                              "type": "AppendToArrayVariable"
                            }
                          },
                          "foreach": "@body('Get_articles_by_indicator_ip')?['articles']",
                          "runAfter": {
                            "Get_articles_by_indicator_ip": [
                              "Succeeded"
                            ]
                          },
                          "type": "Foreach"
                        },
                        "Get_articles_by_indicator_ip": {
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                              }
                            },
                            "method": "get",
                            "path": "/articles/indicator",
                            "queries": {
                              "query": "@items('For_each_IP_Address')?['Address']"
                            }
                          },
                          "type": "ApiConnection"
                        }
                      },
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "runAfter": {
                        "Init_Result_IP": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Init_Result_Host": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_host",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    },
                    "Init_Result_IP": {
                      "inputs": {
                        "variables": [
                          {
                            "name": "result_output_ip",
                            "type": "array"
                          }
                        ]
                      },
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable"
                    }
                  },
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/incident-creation"
                      },
                      "type": "ApiConnectionWebhook"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "riskiqpassivetotal": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RiskIQConnectionName'))]",
                        "connectionName": "[[variables('RiskIQConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/riskiqpassivetotal')]"
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId27'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId27')]",
                "contentId": "[variables('_playbookContentId27')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion27')]",
                "source": {
                  "kind": "Solution",
                  "name": "RiskIQ",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            }
          ],
          "metadata": {
            "comments": "Perform automated enrichment on the Microsoft Sentinel Incidents based on RiskIQ Intelligence data.",
            "title": "RiskIQ-Intel-Summary-Incident",
            "description": "This playbook uses the RiskIQ PassiveTotal connector to automatically enrich incidents generated by Microsoft Sentinel. RiskIQ intelligence provides analyst with deeper context around vulnerabilities, threat actors, their campaigns or other noteworthy context found from analyzing the Internet. Analysts can leverage this playbook to add context to indicators found within incidents. Each comment added to the incident will link to a more detailed intelligence card from RiskIQ.",
            "prerequisites": [
              "This playbook inherits API connections created and established within a base playbook. Ensure you have deployed [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) prior to deploying this playbook. You will need your API credentials (email/secret) when configuring that playbook. Those can be found on your [account settings](https://community.riskiq.com/settings) page. For enterprise customers, it's preferred to use the 'organization' credential pair, not the user. If you have trouble accessing your account or your credentials contact your account representative (support[@]riskiq.com)."
            ],
            "lastUpdateTime": "2022-08-05T00:00:00Z",
            "postDeployment": [
              "After deploying the playbook, you must authorize the connections leveraged.",
              "1. Visit the playbook resource.",
              "2. Under 'Development Tools' (located on the left), click 'API Connections'.",
              "3. Ensure each connection has been authorized.",
              "**Note: If you've deployed the [RiskIQ-Base](https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/RiskIQ/Playbooks/RiskIQ-Base/azuredeploy.json) playbook, you will only need to authorize the Microsoft Sentinel connection.**"
            ],
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "RiskIQ Intel Summary Incident",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "RiskIQ",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Base')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Automated-Triage-alert-trigger')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Automated-Triage-incident-trigger')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-PassiveDns-Domain')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-PassiveDns-Ip')]",
              "version": "[variables('playbookVersion5')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-PassiveDns')]",
              "version": "[variables('playbookVersion6')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Summary-Domain-alert-trigger')]",
              "version": "[variables('playbookVersion7')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Summary-Domain-incident-trigger')]",
              "version": "[variables('playbookVersion8')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Summary-Ip-alert-trigger')]",
              "version": "[variables('playbookVersion9')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Summary-Ip-incident-trigger')]",
              "version": "[variables('playbookVersion10')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Summary-alert-trigger')]",
              "version": "[variables('playbookVersion11')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Summary-incident-trigger')]",
              "version": "[variables('playbookVersion12')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Whois-Domain')]",
              "version": "[variables('playbookVersion13')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Whois-IP')]",
              "version": "[variables('playbookVersion14')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Whois')]",
              "version": "[variables('playbookVersion15')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Reputation-Domain-alert-trigger')]",
              "version": "[variables('playbookVersion16')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Reputation-Domain-incident-trigger')]",
              "version": "[variables('playbookVersion17')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Reputation-Ip-alert-trigger')]",
              "version": "[variables('playbookVersion18')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Reputation-Ip-incident-trigger')]",
              "version": "[variables('playbookVersion19')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Reputation-alert-trigger')]",
              "version": "[variables('playbookVersion20')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Reputation-incident-trigger')]",
              "version": "[variables('playbookVersion21')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Summary-Domain-alert-trigger')]",
              "version": "[variables('playbookVersion22')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Summary-Domain-incident-trigger')]",
              "version": "[variables('playbookVersion23')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Summary-Ip-alert-trigger')]",
              "version": "[variables('playbookVersion24')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Summary-Ip-incident-trigger')]",
              "version": "[variables('playbookVersion25')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Summary-alert-trigger')]",
              "version": "[variables('playbookVersion26')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Intel-Summary-incident-trigger')]",
              "version": "[variables('playbookVersion27')]"
            }
          ]
        },
        "firstPublishDate": "2021-10-20",
        "providers": [
          "RiskIQ"
        ],
        "categories": {
          "domains": [
            "Security - Automation (SOAR)",
            "Security - Threat Intelligence"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
