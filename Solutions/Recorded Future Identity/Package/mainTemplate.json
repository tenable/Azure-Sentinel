{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Recorded Future Premier Integrations - support@recordedfuture.com",
    "comments": "Solution template for Recorded Future Identity"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "solutionId": "recordedfuture1605638642586.recorded_future_identity_sentinel_solution",
    "_solutionId": "[variables('solutionId')]",
    "email": "support@recordedfuture.com",
    "_email": "[variables('email')]",
    "Playbooks": "Playbooks",
    "_Playbooks": "[variables('Playbooks')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "Playbooks1",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1')))]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "Playbooks2",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2')))]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "Playbooks3",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3')))]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "Playbooks4",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4')))]",
    "playbookVersion5": "1.0",
    "playbookContentId5": "Playbooks5",
    "_playbookContentId5": "[variables('playbookContentId5')]",
    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RecordedFutureIdentity-add-AAD-security-group-user playbook",
        "displayName": "RecordedFutureIdentity-add-AAD-security-group-user playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName1'),'/',variables('playbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "RecordedFutureIdentity-add-AAD-security-group-user Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFutureIdentity-add-AAD-security-group-user",
              "type": "string"
            }
          },
          "variables": {
            "AzureADConnectionName": "[[concat('azuread-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuread')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "manual": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {
                        "method": "POST",
                        "schema": {
                          "properties": {
                            "active_directory_domain": {
                              "type": "string"
                            },
                            "active_directory_security_group_id": {
                              "type": "string"
                            },
                            "risky_user_email": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    }
                  },
                  "actions": {
                    "Add_risky_user_to_Active_Directory_security_group_for_users_at_risk": {
                      "runAfter": {
                        "Response_-_Risky_user_was_not_found_in_Active_Directory": [
                          "Skipped"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "@@odata.id": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuread']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/v1.0/groups/@{encodeURIComponent(triggerBody()?['active_directory_security_group_id'])}/members/$ref"
                      }
                    },
                    "Get_User_-_Check_if_the_user_exists_in_Active_Directory": {
                      "runAfter": {
                        "If_Active_Directory_domain_parameter_is_not_null_and_not_empty": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuread']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v1.0/users/@{encodeURIComponent(variables('user_principal_name'))}"
                      }
                    },
                    "If_Active_Directory_domain_parameter_is_not_null_and_not_empty": {
                      "actions": {
                        "Set_Active_Directory_user_principal_name_to_user_email's_username_+_AD_domain": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "user_principal_name",
                            "value": "@{concat(split(triggerBody()?['risky_user_email'], '@')[0], '@', triggerBody()?['active_directory_domain'])}"
                          },
                          "description": "Use [user email's username + Active Directory domain] as Active Directory user principal name."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Active_Directory_user_principal_name": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Set_Active_Directory_user_principal_name_to_user's_email": {
                            "type": "SetVariable",
                            "inputs": {
                              "name": "user_principal_name",
                              "value": "@triggerBody()?['risky_user_email']"
                            },
                            "description": "Use [user's email] as Active Directory user principal name."
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "not": {
                              "equals": [
                                "@triggerBody()?['active_directory_domain']",
                                "@null"
                              ]
                            }
                          },
                          {
                            "not": {
                              "equals": [
                                "@triggerBody()?['active_directory_domain']",
                                ""
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Initialize_-_Active_Directory_user_principal_name": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "user_principal_name",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Response_-_Failed_to_add_risky_user_to_AD_security_group_for_users_at_risk": {
                      "runAfter": {
                        "Response_-_Successfully_added_risky_user_to_AD_security_group_for_users_at_risk": [
                          "Skipped"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "active_directory_security_group_id": "@triggerBody()?['active_directory_security_group_id']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_id_in_active_directory": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']",
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "reason": "Failed to add Active Directory risky user to Active Directory security group for users at risk. Check active_directory_security_group_id parameter.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "active_directory_security_group_id": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_id_in_active_directory": {
                                  "type": "string"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 422
                      }
                    },
                    "Response_-_Risky_user_was_not_found_in_Active_Directory": {
                      "runAfter": {
                        "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                          "Failed"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "active_directory_security_group_id": "@triggerBody()?['active_directory_security_group_id']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "reason": "Risky user was not found in Active Directory.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "active_directory_security_group_id": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_principal_name_used": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 404
                      }
                    },
                    "Response_-_Successfully_added_risky_user_to_AD_security_group_for_users_at_risk": {
                      "runAfter": {
                        "Add_risky_user_to_Active_Directory_security_group_for_users_at_risk": [
                          "Succeeded"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "active_directory_security_group_id": "@triggerBody()?['active_directory_security_group_id']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_id_in_active_directory": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']",
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "status": "Successfully added risky user to Active Directory security group for users at risk."
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "active_directory_security_group_id": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_id_in_active_directory": {
                                  "type": "string"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 200
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuread": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                        "connectionName": "[[variables('AzureADConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuread')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('AzureADConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('AzureADConnectionName')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFutureIdentity-add-AAD-security-group-user",
            "description": "This playbook adds a compromised user to an AAD security group. Triage and remediation should be handled in follow up playbooks or actions.",
            "lastUpdateTime": "2022-09-09T00:00:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RecordedFutureIdentity-confirm-AAD-risky-user playbook",
        "displayName": "RecordedFutureIdentity-confirm-AAD-risky-user playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName2'),'/',variables('playbookVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "RecordedFutureIdentity-confirm-AAD-risky-user Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFutureIdentity-confirm-AAD-risky-user",
              "type": "string"
            }
          },
          "variables": {
            "AzureADConnectionName": "[[concat('azuread-', parameters('PlaybookName'))]",
            "AzureADIdentityProtectionConnectionName": "[[concat('azureadip-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuread')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureadip')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureADIdentityProtectionConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "manual": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {
                        "method": "POST",
                        "schema": {
                          "properties": {
                            "active_directory_domain": {
                              "type": "string"
                            },
                            "risky_user_email": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    }
                  },
                  "actions": {
                    "Check_if_AD_Identity_Protection_risky_users_list_contains_the_user": {
                      "runAfter": {
                        "Response_-_Risky_user_was_not_found_in_Active_Directory": [
                          "Skipped"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureadip']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/beta/riskyUsers/@{encodeURIComponent(body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id'])}"
                      }
                    },
                    "Confirm_the_user_is_indeed_compromised": {
                      "runAfter": {
                        "Check_if_AD_Identity_Protection_risky_users_list_contains_the_user": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "userIds": [
                            "@body('Check_if_AD_Identity_Protection_risky_users_list_contains_the_user')?['id']"
                          ]
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureadip']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/beta/riskyUsers/confirmCompromised"
                      }
                    },
                    "Get_User_-_Check_if_the_user_exists_in_Active_Directory": {
                      "runAfter": {
                        "If_Active_Directory_domain_parameter_is_not_null_and_not_empty": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuread']['connectionId']"
                          }
                        },
                        "method": "get",
                        "path": "/v1.0/users/@{encodeURIComponent(variables('user_principal_name'))}"
                      }
                    },
                    "If_Active_Directory_domain_parameter_is_not_null_and_not_empty": {
                      "actions": {
                        "Set_Active_Directory_user_principal_name_to_user_email's_username_+_AD_domain": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "user_principal_name",
                            "value": "@{concat(split(triggerBody()?['risky_user_email'], '@')[0], '@', triggerBody()?['active_directory_domain'])}"
                          },
                          "description": "Use [user email's username + Active Directory domain] as Active Directory user principal name."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Active_Directory_user_principal_name": [
                          "Succeeded"
                        ]
                      },
                      "else": {
                        "actions": {
                          "Set_Active_Directory_user_principal_name_to_user's_email": {
                            "type": "SetVariable",
                            "inputs": {
                              "name": "user_principal_name",
                              "value": "@triggerBody()?['risky_user_email']"
                            },
                            "description": "Use [user's email] as Active Directory user principal name."
                          }
                        }
                      },
                      "expression": {
                        "and": [
                          {
                            "not": {
                              "equals": [
                                "@triggerBody()?['active_directory_domain']",
                                "@null"
                              ]
                            }
                          },
                          {
                            "not": {
                              "equals": [
                                "@triggerBody()?['active_directory_domain']",
                                ""
                              ]
                            }
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Initialize_-_Active_Directory_user_principal_name": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "user_principal_name",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Response_-_Failed_to_confirm_user_at_risk_is_compromised": {
                      "runAfter": {
                        "Response_-_Successfully_confirmed_user_at_risk_is_indeed_compromised": [
                          "Skipped"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "active_directory_identity_protection_results_for_risky_user": "@body('Check_if_AD_Identity_Protection_risky_users_list_contains_the_user')",
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_id_in_active_directory": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']",
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "reason": "Failed to confirm user at risk is compromised. Probably your tenant is not licensed for Active Directory Identity Protection feature. You can upgrade your subscription to access this feature.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "active_directory_identity_protection_results_for_risky_user": {
                                  "type": "object"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_id_in_active_directory": {
                                  "type": "string"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 422
                      }
                    },
                    "Response_-_Risky_user_was_not_found_in_Active_Directory": {
                      "runAfter": {
                        "Get_User_-_Check_if_the_user_exists_in_Active_Directory": [
                          "Failed"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "reason": "Risky user was not found in Active Directory.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 404
                      }
                    },
                    "Response_-_Successfully_confirmed_user_at_risk_is_indeed_compromised": {
                      "runAfter": {
                        "Confirm_the_user_is_indeed_compromised": [
                          "Succeeded"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "active_directory_identity_protection_results_for_risky_user": "@body('Check_if_AD_Identity_Protection_risky_users_list_contains_the_user')",
                            "parameters_passed": {
                              "active_directory_domain": "@triggerBody()?['active_directory_domain']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            },
                            "user_id_in_active_directory": "@body('Get_User_-_Check_if_the_user_exists_in_Active_Directory')?['id']",
                            "user_principal_name_used": "@variables('user_principal_name')"
                          },
                          "status": "Confirmed user at risk is indeed compromised."
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "active_directory_identity_protection_results_for_risky_user": {
                                  "type": "object"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "active_directory_domain": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                },
                                "user_id_in_active_directory": {
                                  "type": "string"
                                },
                                "user_principal_name": {
                                  "type": "string"
                                }
                              },
                              "type": "object"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 200
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuread": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureADConnectionName'))]",
                        "connectionName": "[[variables('AzureADConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuread')]"
                      },
                      "azureadip": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureADIdentityProtectionConnectionName'))]",
                        "connectionName": "[[variables('AzureADIdentityProtectionConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureadip')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('AzureADConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('AzureADConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('AzureADIdentityProtectionConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('AzureADIdentityProtectionConnectionName')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFutureIdentity-confirm-AAD-risky-user",
            "description": "This playbook confirms compromise of users deemed 'high risk' by AAD.",
            "lastUpdateTime": "2022-09-09T00:00:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RecordedFutureIdentity-lookup-and-save-user playbook",
        "displayName": "RecordedFutureIdentity-lookup-and-save-user playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName3'),'/',variables('playbookVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "RecordedFutureIdentity-lookup-and-save-user Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFutureIdentity-lookup-and-save-user",
              "type": "string"
            }
          },
          "variables": {
            "LogAnalyticsDataCollectorConnectionName": "[[concat('azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "RecordedFutureIdentityConnectionName": "[[concat('recordedfutureidenti-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]",
            "_connection-3": "[[variables('connection-3')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "lookup_results_log_analytics_custom_log_name_default": {
                      "defaultValue": "RecordedFutureIdentity_UsersLookupResults_CL",
                      "type": "String"
                    },
                    "lookup_lookback_days_default": {
                      "defaultValue": -365,
                      "type": "Int"
                    }
                  },
                  "triggers": {
                    "manual": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {
                        "method": "POST",
                        "schema": {
                          "properties": {
                            "lookup_lookback_days": {
                              "type": "integer"
                            },
                            "lookup_results_log_analytics_custom_log_name": {
                              "type": "string"
                            },
                            "risky_user_email": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        }
                      }
                    }
                  },
                  "actions": {
                    "Credential_Lookup_-_Look_up_credential_data_for_one_or_more_users": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "filter": {
                            "first_downloaded_gte": "@{formatDateTime(addDays(utcNow(), if(equals(triggerBody()?['lookup_lookback_days'], null), parameters('lookup_lookback_days_default'), triggerBody()?['lookup_lookback_days'])), 'yyyy-MM-dd')}"
                          },
                          "subjects": [
                            "@triggerBody()?['risky_user_email']"
                          ]
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfutureidenti']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/credentials/lookup"
                      }
                    },
                    "Response_-_Failed_to_get_Lookup_data": {
                      "runAfter": {
                        "Credential_Lookup_-_Look_up_credential_data_for_one_or_more_users": [
                          "Failed"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "lookup_lookback_date": "@formatDateTime(addDays(utcNow(), if(equals(triggerBody()?['lookup_lookback_days'], null), parameters('lookup_lookback_days_default'), triggerBody()?['lookup_lookback_days'])), 'yyyy-MM-dd')",
                            "lookup_results": "@body('Credential_Lookup_-_Look_up_credential_data_for_one_or_more_users')",
                            "lookup_results_log_analytics_custom_log_name": "@if(equals(triggerBody()?['lookup_results_log_analytics_custom_log_name'], null), parameters('lookup_results_log_analytics_custom_log_name_default'), triggerBody()?['lookup_results_log_analytics_custom_log_name'])",
                            "parameters_passed": {
                              "lookup_lookback_days": "@triggerBody()?['lookup_lookback_days']",
                              "lookup_results_log_analytics_custom_log_name": "@triggerBody()?['lookup_results_log_analytics_custom_log_name']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            }
                          },
                          "reason": "Failed to get Lookup data.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "lookup_lookback_date": {
                                  "type": "string"
                                },
                                "lookup_results": {
                                  "type": "object"
                                },
                                "lookup_results_log_analytics_custom_log_name": {
                                  "type": "string"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "lookup_lookback_days": {
                                      "type": "integer"
                                    },
                                    "lookup_results_log_analytics_custom_log_name": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 422
                      }
                    },
                    "Response_-_Failed_to_save_Lookup_results": {
                      "runAfter": {
                        "Response_-_Successfully_saved_lookup_results_into_LogAnalytics": [
                          "Skipped"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "lookup_lookback_date": "@formatDateTime(addDays(utcNow(), if(equals(triggerBody()?['lookup_lookback_days'], null), parameters('lookup_lookback_days_default'), triggerBody()?['lookup_lookback_days'])), 'yyyy-MM-dd')",
                            "lookup_results": "@body('Credential_Lookup_-_Look_up_credential_data_for_one_or_more_users')",
                            "lookup_results_log_analytics_custom_log_name": "@if(equals(triggerBody()?['lookup_results_log_analytics_custom_log_name'], null), parameters('lookup_results_log_analytics_custom_log_name_default'), triggerBody()?['lookup_results_log_analytics_custom_log_name'])",
                            "parameters_passed": {
                              "lookup_lookback_days": "@triggerBody()?['lookup_lookback_days']",
                              "lookup_results_log_analytics_custom_log_name": "@triggerBody()?['lookup_results_log_analytics_custom_log_name']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            }
                          },
                          "reason": "Failed to save Lookup results into LogAnalytics.",
                          "status": "Error"
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "lookup_lookback_date": {
                                  "type": "string"
                                },
                                "lookup_results": {
                                  "type": "object"
                                },
                                "lookup_results_log_analytics_custom_log_name": {
                                  "type": "string"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "lookup_lookback_days": {
                                      "type": "integer"
                                    },
                                    "lookup_results_log_analytics_custom_log_name": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                }
                              },
                              "type": "object"
                            },
                            "reason": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 422
                      }
                    },
                    "Response_-_Successfully_saved_lookup_results_into_LogAnalytics": {
                      "runAfter": {
                        "Send_Data_-_Save_Lookup_results_to_LogAnalytics_Custom_Log": [
                          "Succeeded"
                        ]
                      },
                      "type": "Response",
                      "kind": "Http",
                      "inputs": {
                        "body": {
                          "data": {
                            "lookup_lookback_date": "@formatDateTime(addDays(utcNow(), if(equals(triggerBody()?['lookup_lookback_days'], null), parameters('lookup_lookback_days_default'), triggerBody()?['lookup_lookback_days'])), 'yyyy-MM-dd')",
                            "lookup_results": "@body('Credential_Lookup_-_Look_up_credential_data_for_one_or_more_users')",
                            "lookup_results_log_analytics_custom_log_name": "@if(equals(triggerBody()?['lookup_results_log_analytics_custom_log_name'], null), parameters('lookup_results_log_analytics_custom_log_name_default'), triggerBody()?['lookup_results_log_analytics_custom_log_name'])",
                            "parameters_passed": {
                              "lookup_lookback_days": "@triggerBody()?['lookup_lookback_days']",
                              "lookup_results_log_analytics_custom_log_name": "@triggerBody()?['lookup_results_log_analytics_custom_log_name']",
                              "risky_user_email": "@triggerBody()?['risky_user_email']"
                            }
                          },
                          "status": "Successfully saved risky user lookup results into LogAnalytics table."
                        },
                        "headers": {
                          "Content-Type": "application/json"
                        },
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "lookup_lookback_date": {
                                  "type": "string"
                                },
                                "lookup_results": {
                                  "type": "object"
                                },
                                "lookup_results_log_analytics_custom_log_name": {
                                  "type": "string"
                                },
                                "parameters_passed": {
                                  "properties": {
                                    "lookup_lookback_days": {
                                      "type": "integer"
                                    },
                                    "lookup_results_log_analytics_custom_log_name": {
                                      "type": "string"
                                    },
                                    "risky_user_email": {
                                      "type": "string"
                                    }
                                  },
                                  "type": "object"
                                }
                              },
                              "type": "object"
                            },
                            "status": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "statusCode": 200
                      }
                    },
                    "Send_Data_-_Save_Lookup_results_to_LogAnalytics_Custom_Log": {
                      "runAfter": {
                        "Response_-_Failed_to_get_Lookup_data": [
                          "Skipped"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{body('Credential_Lookup_-_Look_up_credential_data_for_one_or_more_users')}",
                        "headers": {
                          "Log-Type": "@{if(equals(triggerBody()?['lookup_results_log_analytics_custom_log_name'], null), parameters('lookup_results_log_analytics_custom_log_name_default'), triggerBody()?['lookup_results_log_analytics_custom_log_name'])}",
                          "time-generated-field": "@{utcNow()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/logs"
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                        "connectionName": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]"
                      },
                      "recordedfutureidenti": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureIdentityConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('LogAnalyticsDataCollectorConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('RecordedFutureIdentityConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('RecordedFutureIdentityConnectionName')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFutureIdentity-lookup-and-save-user",
            "description": "This playbook gets compromise identity details from Recorded Future Identity Intelligence and saves the data for further review and analysis.",
            "lastUpdateTime": "2022-09-15T00:00:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RecordedFutureIdentity-search-workforce-user playbook",
        "displayName": "RecordedFutureIdentity-search-workforce-user playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName4'),'/',variables('playbookVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "RecordedFutureIdentity-search-workforce-user Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFutureIdentity-search-workforce-user",
              "type": "string"
            },
            "Playbook-Name-add-AAD-security-group-user": {
              "defaultValue": "RecordedFutureIdentity-add-AAD-security-group-user",
              "type": "string"
            },
            "Playbook-Name-lookup-and-save-user": {
              "defaultValue": "RecordedFutureIdentity-lookup-and-save-user",
              "type": "string"
            },
            "Playbook-Name-confirm-AAD-risky-user": {
              "defaultValue": "RecordedFutureIdentity-confirm-AAD-risky-user",
              "type": "string"
            }
          },
          "variables": {
            "LogAnalyticsDataCollectorConnectionName": "[[concat('azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "AzureMonitorLogsConnectionName": "[[concat('azuremonitorlogs-', parameters('PlaybookName'))]",
            "RecordedFutureIdentityConnectionName": "[[concat('recordedfutureidenti-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuremonitorlogs')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "organization_domain": {
                      "defaultValue": "example.com",
                      "type": "String"
                    },
                    "search_lookback_days": {
                      "defaultValue": -14,
                      "type": "Int"
                    },
                    "credential_dumps_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_LeakedCredentials_CredentialDumps_CL",
                      "type": "String"
                    },
                    "malware_logs_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_LeakedCredentials_MalwareLogs_CL",
                      "type": "String"
                    },
                    "lookup_results_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_UsersLookupResults_CL",
                      "type": "String"
                    },
                    "lookup_lookback_days": {
                      "defaultValue": -365,
                      "type": "Int"
                    },
                    "active_directory_domain": {
                      "defaultValue": "[variables('blanks')]",
                      "type": "String"
                    },
                    "active_directory_security_group_id": {
                      "defaultValue": "[variables('blanks')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "Add_Log_Analytics_Credential_dump_exposures_to_the_corresponding_array": {
                      "runAfter": {
                        "Query_Log_Analytics_for_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "known_credential_dump_creds",
                        "value": "@body('Query_Log_Analytics_for_Credential_dump_exposures')?['value']"
                      }
                    },
                    "Add_Log_Analytics_Malware_log_exposures_to_the_corresponding_array": {
                      "runAfter": {
                        "Query_Log_Analytics_for_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "known_malware_log_creds",
                        "value": "@body('Query_Log_Analytics_for_Malware_log_exposures')?['value']"
                      }
                    },
                    "Credential_Search_-_Search_credential_data_for_one_or_more_domains": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "domain_type": "My Organization (workforce use case)",
                          "domains": [
                            "@parameters('organization_domain')"
                          ],
                          "filter": {
                            "latest_downloaded_gte": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                          },
                          "limit": 500
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfutureidenti']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/credentials/search"
                      }
                    },
                    "For_Each_-_Make_new_and_known_Credential_dumps_be_comparable": {
                      "foreach": "@body('Credential_Search_-_Search_credential_data_for_one_or_more_domains')?['credential_dumps']",
                      "actions": {
                        "Append_transformed_exposures_to_array": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "transformed_rf_api_credential_dump_creds",
                            "value": {
                              "email": "@items('For_Each_-_Make_new_and_known_Credential_dumps_be_comparable')"
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_transformed_new_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_-_extend_new_exposures_array_with_new_Credential_dump_exposures": {
                      "foreach": "@variables('unknown_credential_dump_creds')",
                      "actions": {
                        "Add_new_Credential_dump_exposure_email_to_the_array_of_all_new_exposures": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "newly_leaked_emails",
                            "value": "@items('For_Each_-_extend_new_exposures_array_with_new_Credential_dump_exposures')?['email']"
                          }
                        }
                      },
                      "runAfter": {
                        "For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures": {
                      "foreach": "@variables('unknown_malware_log_creds')",
                      "actions": {
                        "Add_new_Malware_log_exposure_email_to_the_array_of_all_new_exposures": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "newly_leaked_emails",
                            "value": "@items('For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures')?['login']"
                          }
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_all_new_exposures_(emails)": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_new_Credential_dump_exposures": {
                      "foreach": "@variables('transformed_rf_api_credential_dump_creds')",
                      "actions": {
                        "If_Credential_dump_exposure_is_new": {
                          "actions": {
                            "Add_new_exposure_to_the_new_Credential_dump_exposures_array": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "unknown_credential_dump_creds",
                                "value": "@items('For_Each_new_Credential_dump_exposures')"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "contains": [
                                    "@variables('known_credential_dump_creds')",
                                    "@items('For_Each_new_Credential_dump_exposures')"
                                  ]
                                }
                              }
                            ]
                          },
                          "type": "If",
                          "description": "\"New\" - means it have not been previously seen by the Logic App."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_new_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_new_Malware_log_exposures": {
                      "foreach": "@body('Credential_Search_-_Search_credential_data_for_one_or_more_domains')?['malware_logs']",
                      "actions": {
                        "If_Malware_log_exposure_is_new": {
                          "actions": {
                            "Add_new_exposure_to_the_new_Malware_log_exposures_array": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "unknown_malware_log_creds",
                                "value": "@items('For_Each_new_Malware_log_exposures')"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "contains": [
                                    "@variables('known_malware_log_creds')",
                                    "@items('For_Each_new_Malware_log_exposures')"
                                  ]
                                }
                              }
                            ]
                          },
                          "type": "If",
                          "description": "\"New\" - means it have not been previously seen by the Logic App."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_new_exposures_-_do_protective_actions": {
                      "foreach": "@variables('newly_leaked_emails')",
                      "actions": {
                        "Current_time": {
                          "type": "Expression",
                          "kind": "CurrentTime",
                          "inputs": {},
                          "description": "This block is needed only to create 3 branches in this For each loop."
                        },
                        "RecordedFutureIdentity-add-AAD-security-group-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "active_directory_domain": "@parameters('active_directory_domain')",
                              "active_directory_security_group_id": "@parameters('active_directory_security_group_id')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-add-AAD-security-group-user'))]"
                              }
                            }
                          }
                        },
                        "RecordedFutureIdentity-lookup-and-save-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "lookup_lookback_days": "@parameters('lookup_lookback_days')",
                              "lookup_results_log_analytics_custom_log_name": "@parameters('lookup_results_log_analytics_custom_log_name')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-lookup-and-save-user'))]"
                              }
                            }
                          }
                        },
                        "RecordedFutureIdentity-confirm-AAD-risky-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "active_directory_domain": "@parameters('active_directory_domain')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-confirm-AAD-risky-user'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "For_Each_-_extend_new_exposures_array_with_new_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Initialize_-_Array_of_all_new_exposures_(emails)": {
                      "runAfter": {
                        "Send_Data_-_Save_new_Credential_dump_exposures_into_Log_Analytics_Custom_Log": [
                          "Succeeded",
                          "Skipped",
                          "TimedOut",
                          "Failed"
                        ],
                        "Send_Data_-_Save_new_Malware_log_exposures_into_Log_Analytics_Custom_Log": [
                          "Succeeded",
                          "Skipped",
                          "TimedOut",
                          "Failed"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "newly_leaked_emails",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Initialize_-_Array_of_known_Credential_dump_exposures": {
                      "runAfter": {
                        "Credential_Search_-_Search_credential_data_for_one_or_more_domains": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "known_credential_dump_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Existing Credential dumps (collected during prior Logic App runs)"
                    },
                    "Initialize_-_Array_of_known_Malware_log_exposures": {
                      "runAfter": {
                        "Credential_Search_-_Search_credential_data_for_one_or_more_domains": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "known_malware_log_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Existing Malware logs (collected during prior Logic App runs)"
                    },
                    "Initialize_-_Array_of_new_Credential_dump_exposures": {
                      "runAfter": {
                        "For_Each_-_Make_new_and_known_Credential_dumps_be_comparable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "unknown_credential_dump_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "\"New\" - means that this are new leaks, which weren't seen on previous runs of the logic app."
                    },
                    "Initialize_-_Array_of_new_Malware_log_exposures": {
                      "runAfter": {
                        "Add_Log_Analytics_Malware_log_exposures_to_the_corresponding_array": [
                          "Succeeded",
                          "Skipped"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "unknown_malware_log_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Exposures that wasn't previously seen by the Logic App."
                    },
                    "Initialize_-_Array_of_transformed_new_Credential_dump_exposures": {
                      "runAfter": {
                        "Add_Log_Analytics_Credential_dump_exposures_to_the_corresponding_array": [
                          "Succeeded",
                          "Skipped"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "transformed_rf_api_credential_dump_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "New Credential dumps are formatted to enable storing and comparing them with existing Credential dumps in Log Analytics."
                    },
                    "Query_Log_Analytics_for_Credential_dump_exposures": {
                      "runAfter": {
                        "Initialize_-_Array_of_known_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{parameters('credential_dumps_log_analytics_custom_log_name')}\n| project email=email_s",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/queryData",
                        "queries": {
                          "resourcegroups": "RF",
                          "resourcename": "RF-log-analyitics",
                          "resourcetype": "Log Analytics Workspace",
                          "subscriptions": "5129b3ff-c0c6-4e86-bd1c-70e5fcd579cf",
                          "timerange": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                        }
                      }
                    },
                    "Query_Log_Analytics_for_Malware_log_exposures": {
                      "runAfter": {
                        "Initialize_-_Array_of_known_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{parameters('malware_logs_log_analytics_custom_log_name')}\n| project login=login_s, domain=domain_s",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/queryData",
                        "queries": {
                          "resourcegroups": "RF",
                          "resourcename": "RF-log-analyitics",
                          "resourcetype": "Log Analytics Workspace",
                          "subscriptions": "5129b3ff-c0c6-4e86-bd1c-70e5fcd579cf",
                          "timerange": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                        }
                      }
                    },
                    "Send_Data_-_Save_new_Credential_dump_exposures_into_Log_Analytics_Custom_Log": {
                      "runAfter": {
                        "Transform_new_Credential_dump_exposures_array_into_a_JSON_object": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{outputs('Transform_new_Credential_dump_exposures_array_into_a_JSON_object')}",
                        "headers": {
                          "Log-Type": "@parameters('credential_dumps_log_analytics_custom_log_name')",
                          "time-generated-field": "@{utcNow()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/logs"
                      }
                    },
                    "Send_Data_-_Save_new_Malware_log_exposures_into_Log_Analytics_Custom_Log": {
                      "runAfter": {
                        "Transform_new_Malware_log_exposures_array_into_a_JSON_object": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{outputs('Transform_new_Malware_log_exposures_array_into_a_JSON_object')}",
                        "headers": {
                          "Log-Type": "@parameters('malware_logs_log_analytics_custom_log_name')",
                          "time-generated-field": "@{utcNow()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/logs"
                      }
                    },
                    "Transform_new_Credential_dump_exposures_array_into_a_JSON_object": {
                      "runAfter": {
                        "For_Each_new_Credential_dump_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@variables('unknown_credential_dump_creds')"
                    },
                    "Transform_new_Malware_log_exposures_array_into_a_JSON_object": {
                      "runAfter": {
                        "For_Each_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@variables('unknown_malware_log_creds')"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                        "connectionName": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]"
                      },
                      "azuremonitorlogs": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                        "connectionName": "[[variables('AzureMonitorLogsConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuremonitorlogs')]"
                      },
                      "recordedfutureidenti": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureIdentityConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('LogAnalyticsDataCollectorConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('AzureMonitorLogsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('AzureMonitorLogsConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('RecordedFutureIdentityConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-4')]"
                },
                "displayName": "[[variables('RecordedFutureIdentityConnectionName')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFutureIdentity-search-workforce-user",
            "description": "This playbook searches the Recorded Future Identity Intelligence Module for compromised workforce users.\n\nThis playbook depends on:\n- RecordedFutureIdentity-add-AAD-security-group-user\n- RecordedFutureIdentity-confirm-AAD-risky-user\n- RecordedFutureIdentity-lookup-and-save-user\n\n Those playbooks need to be installed **manually** before installing current playbook.",
            "lastUpdateTime": "2022-09-15T00:00:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "RecordedFutureIdentity-search-external-user playbook",
        "displayName": "RecordedFutureIdentity-search-external-user playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName5'),'/',variables('playbookVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "RecordedFutureIdentity-search-external-user Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion5')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "RecordedFutureIdentity-search-external-user",
              "type": "string"
            },
            "Playbook-Name-add-AAD-security-group-user": {
              "defaultValue": "RecordedFutureIdentity-add-AAD-security-group-user",
              "type": "string"
            },
            "Playbook-Name-lookup-and-save-user": {
              "defaultValue": "RecordedFutureIdentity-lookup-and-save-user",
              "type": "string"
            },
            "Playbook-Name-confirm-AAD-risky-user": {
              "defaultValue": "RecordedFutureIdentity-confirm-AAD-risky-user",
              "type": "string"
            }
          },
          "variables": {
            "LogAnalyticsDataCollectorConnectionName": "[[concat('azureloganalyticsdatacollector-', parameters('PlaybookName'))]",
            "AzureMonitorLogsConnectionName": "[[concat('azuremonitorlogs-', parameters('PlaybookName'))]",
            "RecordedFutureIdentityConnectionName": "[[concat('recordedfutureidenti-', parameters('PlaybookName'))]",
            "connection-2": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]",
            "_connection-2": "[[variables('connection-2')]",
            "connection-3": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuremonitorlogs')]",
            "_connection-3": "[[variables('connection-3')]",
            "connection-4": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]",
            "_connection-4": "[[variables('connection-4')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    },
                    "organization_domain": {
                      "defaultValue": "example.com",
                      "type": "String"
                    },
                    "search_lookback_days": {
                      "defaultValue": -14,
                      "type": "Int"
                    },
                    "malware_logs_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_LeakedCredentials_MalwareLogs_CL",
                      "type": "String"
                    },
                    "lookup_results_log_analytics_custom_log_name": {
                      "defaultValue": "RecordedFutureIdentity_UsersLookupResults_CL",
                      "type": "String"
                    },
                    "lookup_lookback_days": {
                      "defaultValue": -365,
                      "type": "Int"
                    },
                    "active_directory_domain": {
                      "defaultValue": "[variables('blanks')]",
                      "type": "String"
                    },
                    "active_directory_security_group_id": {
                      "defaultValue": "[variables('blanks')]",
                      "type": "String"
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "recurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "evaluatedRecurrence": {
                        "frequency": "Day",
                        "interval": 1
                      },
                      "type": "Recurrence"
                    }
                  },
                  "actions": {
                    "Add_Log_Analytics_Malware_log_exposures_to_the_corresponding_array": {
                      "runAfter": {
                        "Query_Log_Analytics_for_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "known_malware_log_creds",
                        "value": "@body('Query_Log_Analytics_for_Malware_log_exposures')?['value']"
                      }
                    },
                    "Credential_Search_-_Search_credential_data_for_one_or_more_domains": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": {
                          "domain_type": "Customer (external use case)",
                          "domains": [
                            "@parameters('organization_domain')"
                          ],
                          "filter": {
                            "latest_downloaded_gte": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                          },
                          "limit": 500
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['recordedfutureidenti']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/credentials/search"
                      }
                    },
                    "For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures": {
                      "foreach": "@variables('unknown_malware_log_creds')",
                      "actions": {
                        "Add_new_Malware_log_exposure_email_to_the_array_of_all_new_exposures": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "newly_leaked_emails",
                            "value": "@items('For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures')?['login']"
                          }
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_all_new_exposures_(emails)": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_Each_new_Malware_log_exposures": {
                      "foreach": "@body('Credential_Search_-_Search_credential_data_for_one_or_more_domains')?['malware_logs']",
                      "actions": {
                        "If_Malware_log_exposure_is_new": {
                          "actions": {
                            "Add_new_exposure_to_the_new_Malware_log_exposures_array": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "unknown_malware_log_creds",
                                "value": "@items('For_Each_new_Malware_log_exposures')"
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "not": {
                                  "contains": [
                                    "@variables('known_malware_log_creds')",
                                    "@items('For_Each_new_Malware_log_exposures')"
                                  ]
                                }
                              }
                            ]
                          },
                          "type": "If",
                          "description": "\"New\" - means it have not been previously seen by the Logic App."
                        }
                      },
                      "runAfter": {
                        "Initialize_-_Array_of_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "For_each_new_exposures_-_do_protective_actions": {
                      "foreach": "@variables('newly_leaked_emails')",
                      "actions": {
                        "Current_time": {
                          "type": "Expression",
                          "kind": "CurrentTime",
                          "inputs": {},
                          "description": "This block is needed only to create 3 branches in this For each loop."
                        },
                        "RecordedFutureIdentity-add-AAD-security-group-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "active_directory_domain": "@parameters('active_directory_domain')",
                              "active_directory_security_group_id": "@parameters('active_directory_security_group_id')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-add-AAD-security-group-user'))]"
                              }
                            }
                          }
                        },
                        "RecordedFutureIdentity-confirm-AAD-risky-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "active_directory_domain": "@parameters('active_directory_domain')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-confirm-AAD-risky-user'))]"
                              }
                            }
                          }
                        },
                        "RecordedFutureIdentity-lookup-and-save-user": {
                          "runAfter": {
                            "Current_time": [
                              "Succeeded"
                            ]
                          },
                          "type": "Workflow",
                          "inputs": {
                            "body": {
                              "lookup_lookback_days": "@parameters('lookup_lookback_days')",
                              "lookup_results_log_analytics_custom_log_name": "@parameters('lookup_results_log_analytics_custom_log_name')",
                              "risky_user_email": "@{items('For_each_new_exposures_-_do_protective_actions')}"
                            },
                            "headers": {
                              "Content-Type": "application/json"
                            },
                            "host": {
                              "triggerName": "manual",
                              "workflow": {
                                "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Logic/workflows/', parameters('Playbook-Name-lookup-and-save-user'))]"
                              }
                            }
                          }
                        }
                      },
                      "runAfter": {
                        "For_Each_-_extend_new_exposures_array_with_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Initialize_-_Array_of_all_new_exposures_(emails)": {
                      "runAfter": {
                        "Send_Data_-_Save_new_Malware_log_exposures_into_Log_Analytics_Custom_Log": [
                          "Succeeded",
                          "Skipped",
                          "TimedOut",
                          "Failed"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "newly_leaked_emails",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Initialize_-_Array_of_known_Malware_log_exposures": {
                      "runAfter": {
                        "Credential_Search_-_Search_credential_data_for_one_or_more_domains": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "known_malware_log_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Existing Malware logs (collected during prior Logic App runs)"
                    },
                    "Initialize_-_Array_of_new_Malware_log_exposures": {
                      "runAfter": {
                        "Add_Log_Analytics_Malware_log_exposures_to_the_corresponding_array": [
                          "Succeeded",
                          "Skipped"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "unknown_malware_log_creds",
                            "type": "array"
                          }
                        ]
                      },
                      "description": "Exposures that wasn't previously seen by the Logic App."
                    },
                    "Query_Log_Analytics_for_Malware_log_exposures": {
                      "runAfter": {
                        "Initialize_-_Array_of_known_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{parameters('malware_logs_log_analytics_custom_log_name')}\n| project login=login_s, domain=domain_s",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/queryData",
                        "queries": {
                          "resourcegroups": "RF",
                          "resourcename": "RF-log-analyitics",
                          "resourcetype": "Log Analytics Workspace",
                          "subscriptions": "5129b3ff-c0c6-4e86-bd1c-70e5fcd579cf",
                          "timerange": "@{formatDateTime(addDays(utcNow(), parameters('search_lookback_days')), 'yyyy-MM-dd')}"
                        }
                      }
                    },
                    "Send_Data_-_Save_new_Malware_log_exposures_into_Log_Analytics_Custom_Log": {
                      "runAfter": {
                        "Transform_new_Malware_log_exposures_array_into_a_JSON_object": [
                          "Succeeded"
                        ]
                      },
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@{outputs('Transform_new_Malware_log_exposures_array_into_a_JSON_object')}",
                        "headers": {
                          "Log-Type": "@parameters('malware_logs_log_analytics_custom_log_name')",
                          "time-generated-field": "@{utcNow()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azureloganalyticsdatacollector']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/api/logs"
                      }
                    },
                    "Transform_new_Malware_log_exposures_array_into_a_JSON_object": {
                      "runAfter": {
                        "For_Each_new_Malware_log_exposures": [
                          "Succeeded"
                        ]
                      },
                      "type": "Compose",
                      "inputs": "@variables('unknown_malware_log_creds')"
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azureloganalyticsdatacollector": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('LogAnalyticsDataCollectorConnectionName'))]",
                        "connectionName": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azureloganalyticsdatacollector')]"
                      },
                      "azuremonitorlogs": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureMonitorLogsConnectionName'))]",
                        "connectionName": "[[variables('AzureMonitorLogsConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/azuremonitorlogs')]"
                      },
                      "recordedfutureidenti": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('RecordedFutureIdentityConnectionName'))]",
                        "connectionName": "[[variables('RecordedFutureIdentityConnectionName')]",
                        "id": "[[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',variables('workspace-location-inline'),'/managedApis/recordedfutureidenti')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('LogAnalyticsDataCollectorConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-2')]"
                },
                "displayName": "[[variables('LogAnalyticsDataCollectorConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('AzureMonitorLogsConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-3')]"
                },
                "displayName": "[[variables('AzureMonitorLogsConnectionName')]"
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2018-07-01-preview",
              "name": "[[variables('RecordedFutureIdentityConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-4')]"
                },
                "displayName": "[[variables('RecordedFutureIdentityConnectionName')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId5')]",
                "contentId": "[variables('_playbookContentId5')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "Recorded Future Identity",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Recorded Future Premier Integrations",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Recorded Future Support Team",
                  "email": "support@recordedfuture.com",
                  "tier": "Partner",
                  "link": "https://support.recordedfuture.com/"
                }
              }
            }
          ],
          "metadata": {
            "title": "RecordedFutureIdentity-search-external-user",
            "description": "This playbook searches the Recorded Future Identity Intelligence Module for compromised external (customer) users.\n\nThis playbook depends on:\n- RecordedFutureIdentity-add-AAD-security-group-user\n- RecordedFutureIdentity-confirm-AAD-risky-user\n- RecordedFutureIdentity-lookup-and-save-user\n\n Those playbooks need to be installed **manually** before installing current playbook.",
            "lastUpdateTime": "2022-09-15T00:00:00Z",
            "tags": [
              "Identity protection"
            ],
            "releaseNotes": {
              "version": "1.0",
              "title": "[variables('blanks')]",
              "notes": [
                "Initial version"
              ]
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]",
      "properties": {
        "version": "2.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Recorded Future Identity",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Recorded Future Premier Integrations",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Recorded Future Support Team",
          "email": "support@recordedfuture.com",
          "tier": "Partner",
          "link": "https://support.recordedfuture.com/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Playbook",
              "contentId": "[variables('_Playbooks')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Playbooks')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Playbooks')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Playbooks')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Playbooks')]",
              "version": "[variables('playbookVersion5')]"
            }
          ]
        },
        "firstPublishDate": "2022-09-06",
        "lastPublishDate": "2022-09-06",
        "providers": [
          "Recorded Future"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection",
            "Identity"
          ]
        }
      }
    }
  ],
  "outputs": {}
}
