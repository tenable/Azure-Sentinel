{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft - support@microsoft.com",
    "comments": "Solution template for HYAS"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "solutionId": "hyas.a-hyas-insight-azure-sentinel-solutions-gallery",
    "_solutionId": "[variables('solutionId')]",
    "email": "support@microsoft.com",
    "_email": "[variables('email')]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookId1": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId1')))]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution": "Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS')]",
    "playbookVersion5": "1.0",
    "playbookContentId5": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS",
    "_playbookContentId5": "[variables('playbookContentId5')]",
    "playbookId5": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId5'))]",
    "playbookTemplateSpecName5": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId5')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS')]",
    "playbookVersion6": "1.0",
    "playbookContentId6": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS",
    "_playbookContentId6": "[variables('playbookContentId6')]",
    "playbookId6": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId6'))]",
    "playbookTemplateSpecName6": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId6')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution": "Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution')]",
    "playbookVersion7": "1.0",
    "playbookContentId7": "Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution",
    "_playbookContentId7": "[variables('playbookContentId7')]",
    "playbookId7": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId7'))]",
    "playbookTemplateSpecName7": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId7')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS')]",
    "playbookVersion8": "1.0",
    "playbookContentId8": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS",
    "_playbookContentId8": "[variables('playbookContentId8')]",
    "playbookId8": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId8'))]",
    "playbookTemplateSpecName8": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId8')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS')]",
    "playbookVersion9": "1.0",
    "playbookContentId9": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS",
    "_playbookContentId9": "[variables('playbookContentId9')]",
    "playbookId9": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId9'))]",
    "playbookTemplateSpecName9": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId9')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash')]",
    "playbookVersion10": "1.0",
    "playbookContentId10": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash",
    "_playbookContentId10": "[variables('playbookContentId10')]",
    "playbookId10": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId10'))]",
    "playbookTemplateSpecName10": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId10')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole')]",
    "playbookVersion11": "1.0",
    "playbookContentId11": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole",
    "_playbookContentId11": "[variables('playbookContentId11')]",
    "playbookId11": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId11'))]",
    "playbookTemplateSpecName11": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId11')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate": "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate')]",
    "playbookVersion12": "1.0",
    "playbookContentId12": "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate",
    "_playbookContentId12": "[variables('playbookContentId12')]",
    "playbookId12": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId12'))]",
    "playbookTemplateSpecName12": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId12')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo": "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo')]",
    "playbookVersion13": "1.0",
    "playbookContentId13": "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo",
    "_playbookContentId13": "[variables('playbookContentId13')]",
    "playbookId13": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId13'))]",
    "playbookTemplateSpecName13": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId13')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo": "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo')]",
    "playbookVersion14": "1.0",
    "playbookContentId14": "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo",
    "_playbookContentId14": "[variables('playbookContentId14')]",
    "playbookId14": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId14'))]",
    "playbookTemplateSpecName14": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId14')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS": "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS')]",
    "playbookVersion15": "1.0",
    "playbookContentId15": "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS",
    "_playbookContentId15": "[variables('playbookContentId15')]",
    "playbookId15": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId15'))]",
    "playbookTemplateSpecName15": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId15')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attribution": "Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attribution",
    "_Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attribution": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attribution')]",
    "playbookVersion16": "1.0",
    "playbookContentId16": "Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attribution",
    "_playbookContentId16": "[variables('playbookContentId16')]",
    "playbookId16": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId16'))]",
    "playbookTemplateSpecName16": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId16')))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution')]",
    "playbookVersion17": "1.0",
    "playbookContentId17": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution",
    "_playbookContentId17": "[variables('playbookContentId17')]",
    "playbookId17": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId17'))]",
    "playbookTemplateSpecName17": "[concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId17')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS playbook",
        "displayName": "Insight-Domain-Current-WHOIS playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName1'),'/',variables('playbookVersion1'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName1'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Contact_Info_Variable": {
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Contact Info",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_Hosts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_through_Hosts_Object": {
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Current WHOIS enrichment data for the domain \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\" :\n\n@{replace(replace(replace(replace(replace(variables('Comment'),'&quot;',''),'{',''),'}',''),'[',''),']','')}\n\nFor detailed information, see https://insight.hyas.com/static/details?domain=@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Current_WHOIS_information_for_domain')?['items']",
                              "actions": {
                                "Creating_Contact_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Contact Info",
                                    "value": {
                                      "Email": "@items('Looping_Through_Response_Object')?['email']",
                                      "Phone Number": "@items('Looping_Through_Response_Object')?['phone']"
                                    }
                                  }
                                },
                                "Creating_JSON_Output_Variable_Object": {
                                  "runAfter": {
                                    "Creating_Contact_Object": [
                                      "Succeeded"
                                    ]
                                  },
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "Contact Info": "@variables('Contact Info')",
                                      "Creation Date": "@items('Looping_Through_Response_Object')?['domain_created_datetime']",
                                      "Expire Date": "@items('Looping_Through_Response_Object')?['domain_expires_datetime']",
                                      "Nameservers": "@items('Looping_Through_Response_Object')?['nameserver']",
                                      "Registrar": "@items('Looping_Through_Response_Object')?['registrar']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for domain \"@{items('Looping_through_Hosts_Object')?['HostName']}@{items('Looping_through_Hosts_Object')?['DnsDomain']}.\""
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Current_WHOIS_information_for_domain": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "current": true,
                                "domain": "@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/whois"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Current_WHOIS_information_for_domain": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Current_WHOIS_information_for_domain')?['items'])"
                          }
                        }
                      },
                      "runAfter": {
                        "Contact_Info_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-Domain-Current-WHOIS",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with current WHOIS information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS playbook",
        "displayName": "HYAS-Insight-Domain-Historic-WHOIS playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName2'),'/',variables('playbookVersion2'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName2'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_through_Hosts_Object": {
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Historic WHOIS enrichment data for the domain \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?domain=@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Historic_WHOIS_information_for_domain')",
                              "actions": {
                                "For_each_through_Phone_Object": {
                                  "foreach": "@items('Looping_Through_Response_Object')['phone']",
                                  "actions": {
                                    "Creating_JSON_Output_Variable_Object": {
                                      "type": "AppendToArrayVariable",
                                      "inputs": {
                                        "name": "Json Output",
                                        "value": {
                                          "Email": "@items('Looping_Through_Response_Object')?['email']",
                                          "Phone": "@items('For_each_through_Phone_Object')?['phone']",
                                          "Registrant": "@items('Looping_Through_Response_Object')?['name']",
                                          "Registrar": "@items('Looping_Through_Response_Object')?['registrar']"
                                        }
                                      }
                                    }
                                  },
                                  "type": "Foreach"
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for domain \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\""
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Historic_WHOIS_information_for_domain": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "domain": "@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/whois/domain"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Historic_WHOIS_information_for_domain": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Historic_WHOIS_information_for_domain'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "Insight-Domain-Historic-WHOIS",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with historic WHOIS information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS playbook",
        "displayName": "HYAS-Insight-Domain-Passive-DNS playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName3'),'/',variables('playbookVersion3'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName3'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_through_Hosts_Object": {
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Passive DNS enrichment data for the domain \"@{items('Looping_through_Hosts_Object')?['HostName']}@{items('Looping_through_Hosts_Object')?['DnsDomain']}.\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?domain=@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Passive_DNS_information_for_domain')",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "Count": "@items('Looping_Through_Response_Object')?['count']",
                                      "First Seen": "@items('Looping_Through_Response_Object')?['first_seen']",
                                      "IP": "@items('Looping_Through_Response_Object')?['ipv4']",
                                      "Last Seen": "@items('Looping_Through_Response_Object')?['last_seen']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for domain \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\""
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Passive_DNS_information_for_domain": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "domain": "@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/passivedns"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Passive_DNS_information_for_domain": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Passive_DNS_information_for_domain'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-Domain-Passive-DNS",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with recent passive DNS records. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution playbook",
        "displayName": "Insight-Email-C2-Attribution playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName4'),'/',variables('playbookVersion4'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName4'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Account_Name_Variable": {
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Email1",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Account_UPN_Suffix_Variable": {
                      "runAfter": {
                        "Account_Name_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Email2",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Email_Connector_Variable": {
                      "runAfter": {
                        "Account_UPN_Suffix_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Connector",
                            "type": "string",
                            "value": "@"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_Accounts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/account"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_Accounts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Account_Object_for_Accounts_Name": {
                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight  C2 Attribution Enrichment data the Email Address\"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\" :\n\n@{variables('Comment')}\n\nFor detailed information, see https://insight.hyas.com/static/details?email=@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Set_Comment_to_Empty": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "For_each": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "For_each": {
                              "foreach": "@take(body('Retrieve_C2_Attribution_information_for_Email_address'),3)",
                              "actions": {
                                "Append_to_array_variable": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "actor_ipv4": "@items('For_each')?['actor_ipv4']",
                                      "c2_domain": "@items('For_each')?['c2_domain']",
                                      "c2_ipv4": "@items('For_each')?['c2_ip']",
                                      "c2_url": "@items('For_each')?['c2_url']",
                                      "datetime": "@items('For_each')?['datetime']",
                                      "email": "@items('For_each')?['email']",
                                      "email_domain": "@items('For_each')?['email_domain']",
                                      "referrer_domain": "@items('For_each')?['referrer_domain']",
                                      "referrer_ipv4": "@items('For_each')?['referrer_ipv4']",
                                      "referrer_url": "@items('For_each')?['referrer_url']",
                                      "sha256": "@items('For_each')?['sha256']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            },
                            "Set_Comment_to_Empty": {
                              "runAfter": {
                                "Set_JSON_Output_to_Empty": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": " "
                              }
                            },
                            "Set_JSON_Output_to_Empty": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Json Output"
                              }
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for the Email Address \"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_C2_Attribution_information_for_Email_address": {
                          "runAfter": {
                            "Setting_Accounts_UPN_suffix_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "email": "@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/c2attribution/email"
                          }
                        },
                        "Setting_Accounts_Name_Variable": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Email1",
                            "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['Name']"
                          }
                        },
                        "Setting_Accounts_UPN_suffix_variable": {
                          "runAfter": {
                            "Setting_Accounts_Name_Variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Email2",
                            "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['UPNSuffix']"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_C2_Attribution_information_for_Email_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_C2_Attribution_information_for_Email_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Email_Connector_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-Email-C2-Attribution",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with C2 Attribution information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName5')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS playbook",
        "displayName": "Insight-Email-Dynamic-DNS playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName5'),'/',variables('playbookVersion5'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName5'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion5')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Account_Name_Variable": {
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Email1",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Account_UPN_Suffix_Variable": {
                      "runAfter": {
                        "Account_Name_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Email2",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Email_Connector_Variable": {
                      "runAfter": {
                        "Account_UPN_Suffix_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Connector",
                            "type": "string",
                            "value": "@"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_Accounts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/account"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_Accounts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Account_Object_for_Accounts_Name": {
                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Dynamic DNS enrichment data for the email \"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?email=@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Dynamic_DNS_information_for_email_address')",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "A Record": "@items('Looping_Through_Response_Object')?['a_record']",
                                      "Created IP": "@items('Looping_Through_Response_Object')?['created_ip']",
                                      "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                                      "Domain Creator IP": "@items('Looping_Through_Response_Object')?['domain_creator_ip']",
                                      "Timestamp": "@items('Looping_Through_Response_Object')?['created']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for email \"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Dynamic_DNS_information_for_email_address": {
                          "runAfter": {
                            "Setting_Accounts_UPN_suffix_variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "email": "@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/dynamicdns/email"
                          }
                        },
                        "Setting_Accounts_Name_Variable": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Email1",
                            "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['Name']"
                          }
                        },
                        "Setting_Accounts_UPN_suffix_variable": {
                          "runAfter": {
                            "Setting_Accounts_Name_Variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Email2",
                            "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['UPNSuffix']"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Dynamic_DNS_information_for_email_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Dynamic_DNS_information_for_email_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Email_Connector_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId5'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId5')]",
                "contentId": "[variables('_playbookContentId5')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion5')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-Email-Dynamic-DNS",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with Dynamic DNS information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName6')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS playbook",
        "displayName": "Insight-Email-Historic-WHOIS playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName6'),'/',variables('playbookVersion6'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName6'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion6')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Account_Name_Variable": {
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Email1",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Account_UPN_Suffix_Variable": {
                      "runAfter": {
                        "Account_Name_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Email2",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "Email_Connector_Variable": {
                      "runAfter": {
                        "Account_UPN_Suffix_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Connector",
                            "type": "string",
                            "value": "@"
                          }
                        ]
                      }
                    },
                    "Entities_-_Get_Accounts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/account"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_Accounts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Account_Object_for_Accounts_Name": {
                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Historic WHOIS enrichment data for the email \"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?email=@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Historic_WHOIS_information_for_email_address')",
                              "actions": {
                                "For_each_through_Phone_Object": {
                                  "foreach": "@items('Looping_Through_Response_Object')['phone']",
                                  "actions": {
                                    "Creating_JSON_Output_Variable_Object": {
                                      "type": "AppendToArrayVariable",
                                      "inputs": {
                                        "name": "Json Output",
                                        "value": {
                                          "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                                          "Phone": "@items('For_each_through_Phone_Object')?['phone']",
                                          "Registrant": "@items('Looping_Through_Response_Object')?['name']",
                                          "Registrar": "@items('Looping_Through_Response_Object')?['registrar']"
                                        }
                                      }
                                    }
                                  },
                                  "type": "Foreach"
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for email \"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Looping_Through_Account_Object_for_UPN_suffix": {
                          "runAfter": {
                            "Setting_Accounts_Name_Variable": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Email2",
                            "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['UPNSuffix']"
                          }
                        },
                        "Retrieve_Historic_WHOIS_information_for_email_address": {
                          "runAfter": {
                            "Looping_Through_Account_Object_for_UPN_suffix": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "email": "@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/whois/email"
                          }
                        },
                        "Setting_Accounts_Name_Variable": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Email1",
                            "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['Name']"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Historic_WHOIS_information_for_email_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Historic_WHOIS_information_for_email_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Email_Connector_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId6'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId6')]",
                "contentId": "[variables('_playbookContentId6')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion6')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-Email-Historic-WHOIS",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with historic WHOIS information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName7')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution playbook",
        "displayName": "Insight-IP-C2-Attribution playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName7'),'/',variables('playbookVersion7'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName7'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion7')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_IPs": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight C2 Attribution Enrichment data for the IP Address\n \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :\n               \n@{variables('Comment')}\n\nFor detailed information, see https://insight.hyas.com/static/details?ip=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Set_Comment_to_Empty": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "For_each": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "For_each": {
                              "foreach": "@take(body('Retrieve_C2_Attribution_information_for_IP_address'),3)",
                              "actions": {
                                "Append_to_array_variable": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "actor_ipv4": "@items('For_each')?['actor_ipv4']",
                                      "c2_domain": "@items('For_each')?['c2_domain']",
                                      "c2_ipv4": "@items('For_each')?['c2_ip']",
                                      "c2_url": "@items('For_each')?['c2_url']",
                                      "datetime": "@items('For_each')?['datetime']",
                                      "email": "@items('For_each')?['email']",
                                      "email_domain": "@items('For_each')?['email_domain']",
                                      "referrer_domain": "@items('For_each')?['referrer_domain']",
                                      "referrer_ipv4": "@items('For_each')?['referrer_ipv4']",
                                      "referrer_url": "@items('For_each')?['referrer_url']",
                                      "sha256": "@items('For_each')?['sha256']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            },
                            "Set_Comment_to_Empty": {
                              "runAfter": {
                                "Set_Json_Output_to_Empty": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": " "
                              }
                            },
                            "Set_Json_Output_to_Empty": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Json Output"
                              }
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for the IP Address \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_C2_Attribution_information_for_IP_address": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "ip": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/c2attribution/ip"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_C2_Attribution_information_for_IP_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_C2_Attribution_information_for_IP_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId7'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId7')]",
                "contentId": "[variables('_playbookContentId7')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion7')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-IP-C2-Attribution",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with historic WHOIS information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName8')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS playbook",
        "displayName": "Insight-IP-Dynamic-DNS playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName8'),'/',variables('playbookVersion8'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName8'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion8')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_IPs": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Dynamic DNS enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?ip=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Dynamic_DNS_information_for_IP_address')",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "A Record": "@items('Looping_Through_Response_Object')?['a_record']",
                                      "Created IP": "@items('Looping_Through_Response_Object')?['created_ip']",
                                      "Domain Creator IP": "@items('Looping_Through_Response_Object')?['domain_creator_ip']",
                                      "Email": "@items('Looping_Through_Response_Object')?['email']",
                                      "Timestamp": "@items('Looping_Through_Response_Object')?['created']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Dynamic_DNS_information_for_IP_address": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "ip": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/dynamicdns"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Dynamic_DNS_information_for_IP_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Dynamic_DNS_information_for_IP_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId8'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId8')]",
                "contentId": "[variables('_playbookContentId8')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion8')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-IP-Dynamic-DNS",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with recent Dynamic DNS information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName9')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS playbook",
        "displayName": "Insight-IP-Passive-DNS playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName9'),'/',variables('playbookVersion9'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName9'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion9')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_IPs": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Passive DNS enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?ipv4=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Passive_DNS_information_for_IP_address')",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "Count": "@items('Looping_Through_Response_Object')?['count']",
                                      "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                                      "First Seen": "@items('Looping_Through_Response_Object')?['first_seen']",
                                      "Last Seen": "@items('Looping_Through_Response_Object')?['last_seen']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Passive_DNS_information_for_IP_address": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "ipv4": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/passivedns/ip"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Passive_DNS_information_for_IP_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Passive_DNS_information_for_IP_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId9'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId9')]",
                "contentId": "[variables('_playbookContentId9')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion9')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-IP-Passive-DNS",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with geolocation information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName10')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash playbook",
        "displayName": "Insight-IP-Passive-Hash playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName10'),'/',variables('playbookVersion10'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName10'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion10')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_IPs": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Passive Hash enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?ipv4=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Passive_Hash_information_for_IP_address')",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                                      "MD5 Count": "@items('Looping_Through_Response_Object')?['md5_count']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Passive_Hash_information_for_IP_address": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "ipv4": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/passivehash"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Passive_Hash_information_for_IP_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Passive_Hash_information_for_IP_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId10'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId10')]",
                "contentId": "[variables('_playbookContentId10')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion10')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-IP-Passive-Hash",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with Passive Hash information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName11')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole playbook",
        "displayName": "Insight-IP-Sinkhole playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName11'),'/',variables('playbookVersion11'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName11'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion11')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_IPs": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Sinkhole enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?ipv4=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Sinkhole_information_for_IP_address')",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "Count": "@items('Looping_Through_Response_Object')?['count']",
                                      "Country": "@items('Looping_Through_Response_Object')?['country_name']",
                                      "First Seen": "@items('Looping_Through_Response_Object')?['datetime']",
                                      "Last Seen": "@items('Looping_Through_Response_Object')?['last_seen']",
                                      "Org": "@items('Looping_Through_Response_Object')?['organization_name']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Sinkhole_information_for_IP_address": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "ipv4": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/sinkhole"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Sinkhole_information_for_IP_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Sinkhole_information_for_IP_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId11'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId11')]",
                "contentId": "[variables('_playbookContentId11')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion11')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-IP-Sinkhole",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with Sinkhole information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName12')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate playbook",
        "displayName": "Insight-IP-SSL-Certificate playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName12'),'/',variables('playbookVersion12'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName12'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion12')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_IPs": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight SSL certificate enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?ip=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_SSL_certificate_information_for_IP_address')?['ssl_certs']",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "Expire Date": "@items('Looping_Through_Response_Object')?['ssl_cert']?['expire_date']",
                                      "Issue Date": "@items('Looping_Through_Response_Object')?['ssl_cert']?['issue_date']",
                                      "Issuer": "@items('Looping_Through_Response_Object')?['ssl_cert']?['issuer_commonName']",
                                      "SHA1": "@items('Looping_Through_Response_Object')?['ssl_cert']?['sha1']",
                                      "Subject": "@items('Looping_Through_Response_Object')?['ssl_cert']?['subject_commonName']",
                                      "Subject Org": "@items('Looping_Through_Response_Object')?['ssl_cert']?['subject_organizationName']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_SSL_certificate_information_for_IP_address": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "ip": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/ssl_certificate"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_SSL_certificate_information_for_IP_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_SSL_certificate_information_for_IP_address')?['ssl_certs'])"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId12'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId12')]",
                "contentId": "[variables('_playbookContentId12')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion12')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-IP-SSL-Certificate",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with SSL certificate information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName13')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo playbook",
        "displayName": "Insight-IPv4-Device-Geo playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName13'),'/',variables('playbookVersion13'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName13'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion13')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_IPs": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Device Geo enrichment data for the IPv4 \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?ipv4=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Device_Geo_information_for_IPv4_address')",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "BSSID": "@items('Looping_Through_Response_Object')?['wifi_bssid']",
                                      "Timestamp": "@items('Looping_Through_Response_Object')?['datetime']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Device_Geo_information_for_IPv4_address": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "ipv4": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/device_geo"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Device_Geo_information_for_IPv4_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Device_Geo_information_for_IPv4_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId13'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId13')]",
                "contentId": "[variables('_playbookContentId13')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion13')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-IPv4-Device-Geo",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with geolocation information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName14')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo playbook",
        "displayName": "Insight-IPv6-Device-Geo playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName14'),'/',variables('playbookVersion14'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName14'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion14')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_IPs": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/ip"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_IPs": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_IPs": {
                      "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Device Geo enrichment data for the IPv6 \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?ipv6=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Device_Geo_information_for_IPv6_address')",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "BSSID": "@items('Looping_Through_Response_Object')?['wifi_bssid']",
                                      "Timestamp": "@items('Looping_Through_Response_Object')?['datetime']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Device_Geo_information_for_IPv6_address": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "ipv6": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/device_geo/ipv6"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Device_Geo_information_for_IPv6_address": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Device_Geo_information_for_IPv6_address'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId14'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId14')]",
                "contentId": "[variables('_playbookContentId14')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion14')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-IPv6-Device-Geo",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with geolocation information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName15')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS playbook",
        "displayName": "Insight-Phone-Number-Historic-WHOIS playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName15'),'/',variables('playbookVersion15'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName15'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion15')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_Accounts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/account"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_Accounts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_Accounts": {
                      "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight Historic WHOIS enrichment data for the phone number \"@{items('Looping_Through_Sentinel_Accounts')?['Name']}\" :\n\n@{replace(variables('Comment'), '&quot;', '')}\n\nFor detailed information, see https://insight.hyas.com/static/details?phone=@{items('Looping_Through_Sentinel_Accounts')?['Name']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                              "actions": {
                                "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                                  "type": "SetVariable",
                                  "inputs": {
                                    "name": "Comment",
                                    "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                                  }
                                }
                              },
                              "runAfter": {
                                "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                                  "Succeeded"
                                ]
                              },
                              "expression": {
                                "and": [
                                  {
                                    "greater": [
                                      "@length(body('Create_HTML_table'))",
                                      3000
                                    ]
                                  }
                                ]
                              },
                              "type": "If"
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "Looping_Through_Response_Object": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "Looping_Through_Response_Object": {
                              "foreach": "@body('Retrieve_Historic_WHOIS_information_for_phone_number')",
                              "actions": {
                                "Creating_JSON_Output_Variable_Object": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                                      "Email": "@items('Looping_Through_Response_Object')?['email']",
                                      "Registrant": "@items('Looping_Through_Response_Object')?['name']",
                                      "Registrar": "@items('Looping_Through_Response_Object')?['registrar']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach"
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for phone number \"@{items('Looping_Through_Sentinel_Accounts')?['Name']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_Historic_WHOIS_information_for_phone_number": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "phone": "@items('Looping_Through_Sentinel_Accounts')?['Name']"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/whois/phone"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_Historic_WHOIS_information_for_phone_number": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_Historic_WHOIS_information_for_phone_number'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach"
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId15'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId15')]",
                "contentId": "[variables('_playbookContentId15')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion15')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "Insight-Phone-Number-Historic-WHOIS",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with historic WHOIS information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName16')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attribution playbook",
        "displayName": "Insight-SHA256-C2-Attribution playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName16'),'/',variables('playbookVersion16'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName16'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attribution Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion16')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attribution",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_FileHashes": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/filehash"
                      }
                    },
                    "Filehash_Variable": {
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "FileHashValue",
                            "type": "string"
                          }
                        ]
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_FileHashes": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_Through_Sentinel_Sha256_values": {
                      "foreach": "@body('Entities_-_Get_FileHashes')?['Filehashes']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight C2 Attribution Enrichment data for the SHA256 \"@{variables('FileHashValue')}\"\n\n :\n@{variables('Comment')}\n\n\nFor detailed information, see https://insight.hyas.com/static/details?sha256=@{variables('FileHashValue')}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Set_Comment_Variable_to_empty": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "For_each": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "For_each": {
                              "foreach": "@take(body('Retrieve_C2_Attribution_information_for_SHA256'),3)",
                              "actions": {
                                "Append_to_array_variable": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "actor_ipv4": "@items('For_each')?['actor_ipv4']",
                                      "c2_domain": "@items('For_each')?['c2_domain']",
                                      "c2_ipv4": "@items('For_each')?['c2_ip']",
                                      "c2_url": "@items('For_each')?['c2_url']",
                                      "datetime": "@items('For_each')?['datetime']",
                                      "email": "@items('For_each')?['email']",
                                      "email_domain": "@items('For_each')?['email_domain']",
                                      "referrer_domain": "@items('For_each')?['referrer_domain']",
                                      "referrer_ipv4": "@items('For_each')?['referrer_ipv4']",
                                      "referrer_url": "@items('For_each')?['referrer_url']",
                                      "sha256": "@items('For_each')?['sha256']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach",
                              "runtimeConfiguration": {
                                "concurrency": {
                                  "repetitions": 1
                                }
                              }
                            },
                            "Set_Comment_Variable_to_empty": {
                              "runAfter": {
                                "Set_Json_output_to_empty": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": " "
                              }
                            },
                            "Set_Json_output_to_empty": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Json Output"
                              }
                            }
                          },
                          "runAfter": {
                            "Setting_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for the SHA256  \"@{items('Looping_Through_Sentinel_Sha256_values')?['Address']}\"."
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_C2_Attribution_information_for_SHA256": {
                          "runAfter": {
                            "Set_Filehash_Value": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "sha256": "@variables('FileHashValue')"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/c2attribution/sha256"
                          }
                        },
                        "Set_Filehash_Value": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "FileHashValue",
                            "value": "@items('Looping_Through_Sentinel_Sha256_values')?['Value']"
                          }
                        },
                        "Setting_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_C2_Attribution_information_for_SHA256": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_C2_Attribution_information_for_SHA256'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Filehash_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId16'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId16')]",
                "contentId": "[variables('_playbookContentId16')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion16')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "HYAS-Insight-SHA256-C2-Attribution",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with historic WHOIS information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attributions",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs",
      "apiVersion": "2021-05-01",
      "name": "[variables('playbookTemplateSpecName17')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution playbook",
        "displayName": "Insight-Domain-C2-Attribution playbook"
      }
    },
    {
      "type": "Microsoft.Resources/templateSpecs/versions",
      "apiVersion": "2021-05-01",
      "name": "[concat(variables('playbookTemplateSpecName17'),'/',variables('playbookVersion17'))]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "hidden-sentinelWorkspaceId": "[variables('workspaceResourceId')]",
        "hidden-sentinelContentType": "Playbook"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/templateSpecs', variables('playbookTemplateSpecName17'))]"
      ],
      "properties": {
        "description": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution Playbook with template version 2.0.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion17')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution",
              "type": "string"
            },
            "UserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            }
          },
          "variables": {
            "HYASInsightApiKey": "[[concat('hyasinsight-', parameters('PlaybookName'))]",
            "AzureSentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('AzureSentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "V1",
              "properties": {
                "displayName": "[[variables('AzureSentinelConnectionName')]",
                "parameterValueType": "Alternative",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('HYASInsightApiKey')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('UserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "body": {
                          "callback_url": "@{listCallbackUrl()}"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "Entities_-_Get_Hosts": {
                      "type": "ApiConnection",
                      "inputs": {
                        "body": "@triggerBody()?['Entities']",
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "post",
                        "path": "/entities/host"
                      }
                    },
                    "JSON_Output_Variable": {
                      "runAfter": {
                        "Entities_-_Get_Hosts": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Json Output",
                            "type": "array"
                          }
                        ]
                      }
                    },
                    "Looping_through_Hosts_Object": {
                      "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
                      "actions": {
                        "Add_comment_to_incident_(V2)_2": {
                          "runAfter": {
                            "Checking_If_the_Response_Returned_Data": [
                              "Succeeded"
                            ]
                          },
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "Value": "HYAS Insight  C2 Attribution Enrichment data for the Domain \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\" : \n\n@{variables('Comment')}\n\nFor detailed information, see https://insight.hyas.com/static/details?domain=@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                              }
                            },
                            "method": "put",
                            "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                          }
                        },
                        "Checking_If_the_Response_Returned_Data": {
                          "actions": {
                            "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                              "runAfter": {
                                "Set_Comment_Variable_to_Empty": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": "@body('Create_HTML_table')"
                              }
                            },
                            "Create_HTML_table": {
                              "runAfter": {
                                "For_each": [
                                  "Succeeded"
                                ]
                              },
                              "type": "Table",
                              "inputs": {
                                "format": "HTML",
                                "from": "@variables('Json Output')"
                              }
                            },
                            "For_each": {
                              "foreach": "@take(body('Retrieve_C2_Attribution_information_for_Domain'),3)",
                              "actions": {
                                "Append_to_array_variable": {
                                  "type": "AppendToArrayVariable",
                                  "inputs": {
                                    "name": "Json Output",
                                    "value": {
                                      "actor_ipv4": "@items('For_each')?['actor_ipv4']",
                                      "c2_domain": "@items('For_each')?['c2_domain']",
                                      "c2_ipv4": "@items('For_each')?['c2_ip']",
                                      "c2_url": "@items('For_each')?['c2_url']",
                                      "datetime": "@items('For_each')?['datetime']",
                                      "email": "@items('For_each')?['email']",
                                      "email_domain": "@items('For_each')?['email_domain']",
                                      "referrer_domain": "@items('For_each')?['referrer_domain']",
                                      "referrer_ipv4": "@items('For_each')?['referrer_ipv4']",
                                      "referrer_url": "@items('For_each')?['referrer_url']",
                                      "sha256": "@items('For_each')?['sha256']"
                                    }
                                  }
                                }
                              },
                              "type": "Foreach",
                              "runtimeConfiguration": {
                                "concurrency": {
                                  "repetitions": 1
                                }
                              }
                            },
                            "Set_Comment_Variable_to_Empty": {
                              "runAfter": {
                                "Set_Json_Output_to_Empty": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Comment",
                                "value": " "
                              }
                            },
                            "Set_Json_Output_to_Empty": {
                              "runAfter": {
                                "Create_HTML_table": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable",
                              "inputs": {
                                "name": "Json Output"
                              }
                            }
                          },
                          "runAfter": {
                            "Setting_the_Response_Length_Variable": [
                              "Succeeded"
                            ]
                          },
                          "else": {
                            "actions": {
                              "No_Records_Found": {
                                "type": "SetVariable",
                                "inputs": {
                                  "name": "Comment",
                                  "value": "No records found in HYAS Insight for the Domain  \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\""
                                }
                              }
                            }
                          },
                          "expression": {
                            "and": [
                              {
                                "greater": [
                                  "@variables('RecordsLength')",
                                  0
                                ]
                              }
                            ]
                          },
                          "type": "If"
                        },
                        "Retrieve_C2_Attribution_information_for_Domain": {
                          "type": "ApiConnection",
                          "inputs": {
                            "body": {
                              "applied_filters": {
                                "domain": "@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                              }
                            },
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                              }
                            },
                            "method": "post",
                            "path": "/c2attribution/domain"
                          }
                        },
                        "Setting_the_Response_Length_Variable": {
                          "runAfter": {
                            "Retrieve_C2_Attribution_information_for_Domain": [
                              "Succeeded"
                            ]
                          },
                          "type": "SetVariable",
                          "inputs": {
                            "name": "RecordsLength",
                            "value": "@length(body('Retrieve_C2_Attribution_information_for_Domain'))"
                          }
                        }
                      },
                      "runAfter": {
                        "Sentinel_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Response_Length_Variable": {
                      "runAfter": {
                        "JSON_Output_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "RecordsLength",
                            "type": "integer",
                            "value": 0
                          }
                        ]
                      }
                    },
                    "Sentinel_Incident_Comment_Variable": {
                      "runAfter": {
                        "Response_Length_Variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "Comment",
                            "type": "string"
                          }
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                        "connectionName": "[[variables('AzureSentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
                        "connectionProperties": {
                          "authentication": {
                            "type": "ManagedServiceIdentity"
                          }
                        }
                      },
                      "hyasinsight": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('HYASInsightApiKey'))]",
                        "connectionName": "[[variables('HYASInsightApiKey')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/hyasinsight')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId17'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId17')]",
                "contentId": "[variables('_playbookContentId17')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion17')]",
                "source": {
                  "kind": "Solution",
                  "name": "HYAS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "Microsoft",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "HYAS",
                  "tier": "Partner",
                  "link": "https://www.hyas.com/contact"
                }
              }
            }
          ],
          "metadata": {
            "title": "Insight-Domain-C2-Attribution",
            "description": "This playbook uses the HYAS Insight connector to automatically enrich incidents generated by Sentinel with C2 Attribution information. You need a valid subscription in order to use the connector and playbook. Learn more about the integration via the [connector documentation](https://docs.microsoft.com/connectors/hyasinsight/) or visit [HYAS Insight](https://www.hyas.com/contact) to request a trial key.",
            "prerequisites": [
              "None"
            ],
            "lastUpdateTime": "2022-07-31T00:00:00Z",
            "releaseNotes": [
              {
                "version": "1.0.0",
                "title": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "2.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "2.0.0",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "HYAS",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "HYAS",
          "tier": "Partner",
          "link": "https://www.hyas.com/contact"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Email-C2-Attribution')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS')]",
              "version": "[variables('playbookVersion5')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS')]",
              "version": "[variables('playbookVersion6')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-C2-Attribution')]",
              "version": "[variables('playbookVersion7')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS')]",
              "version": "[variables('playbookVersion8')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS')]",
              "version": "[variables('playbookVersion9')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash')]",
              "version": "[variables('playbookVersion10')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole')]",
              "version": "[variables('playbookVersion11')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate')]",
              "version": "[variables('playbookVersion12')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo')]",
              "version": "[variables('playbookVersion13')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo')]",
              "version": "[variables('playbookVersion14')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS')]",
              "version": "[variables('playbookVersion15')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-SHA256-C2-Attribution')]",
              "version": "[variables('playbookVersion16')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Domain-C2-Attribution')]",
              "version": "[variables('playbookVersion17')]"
            }
          ]
        },
        "firstPublishDate": "2021-10-20",
        "providers": [
          "HYAS"
        ],
        "categories": {
          "domains": [
            "Security - Threat Intelligence",
            "Security – Automation (SOAR)"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
